<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.111.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon_next.png><meta itemprop=name content="Elasticsearch学习笔记2"><meta itemprop=description content="elasticsearch学习笔记2"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zzzicode.github.io/imgs/avatar.png"><meta itemprop=keywords content="微服务,elasticsearch"><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch学习笔记2"><meta property="og:description" content="elasticsearch学习笔记2"><meta property="og:image" content="/imgs/avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02/"><meta property="og:site_name" content="zzzi的小站"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="zzzi"><meta property="article:published_time" content="2024-03-01 20:51:31 +0800 CST"><meta property="article:modified_time" content="2024-03-01 20:51:31 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4b7f3d9c4ef8db1505229a7dcd2c4e3ab17cd4960dd8a78b503c013770ad56a6.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02","permalink":"https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02/","title":"Elasticsearch学习笔记2"}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Elasticsearch学习笔记2 - zzzi的小站</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>zzzi的小站</h1><i class=logo-line></i></a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>228</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#11dsl查询分类>1.1.DSL查询分类</a></li><li><a href=#12全文检索查询>1.2.全文检索查询</a><ul><li><a href=#121使用场景>1.2.1.使用场景</a></li><li><a href=#122基本语法>1.2.2.基本语法</a></li><li><a href=#123示例>1.2.3.示例</a></li><li><a href=#124总结>1.2.4.总结</a></li></ul></li><li><a href=#13精准查询>1.3.精准查询</a><ul><li><a href=#131term查询>1.3.1.term查询</a></li><li><a href=#132range查询>1.3.2.range查询</a></li><li><a href=#133总结>1.3.3.总结</a></li></ul></li><li><a href=#14地理坐标查询>1.4.地理坐标查询</a><ul><li><a href=#141矩形范围查询>1.4.1.矩形范围查询</a></li><li><a href=#142附近查询>1.4.2.附近查询</a></li></ul></li><li><a href=#15复合查询>1.5.复合查询</a><ul><li><a href=#151相关性算分>1.5.1.相关性算分</a></li><li><a href=#152算分函数查询>1.5.2.算分函数查询</a><ul><li><a href=#1语法说明>1）语法说明</a></li><li><a href=#2示例>2）示例</a></li><li><a href=#3小结>3）小结</a></li></ul></li><li><a href=#153布尔查询>1.5.3.布尔查询</a><ul><li><a href=#1语法示例>1）语法示例：</a></li><li><a href=#2示例-1>2）示例</a></li><li><a href=#3小结-1>3）小结</a></li></ul></li></ul></li><li><a href=#16小结>1.6.小结</a></li></ul><ul><li><a href=#21排序>2.1.排序</a><ul><li><a href=#211普通字段排序>2.1.1.普通字段排序</a></li><li><a href=#212地理坐标排序>2.1.2.地理坐标排序</a></li></ul></li><li><a href=#22分页>2.2.分页</a><ul><li><a href=#221基本的分页>2.2.1.基本的分页</a></li><li><a href=#222深度分页问题>2.2.2.深度分页问题</a></li><li><a href=#223小结>2.2.3.小结</a></li></ul></li><li><a href=#23高亮>2.3.高亮</a><ul><li><a href=#231高亮原理>2.3.1.高亮原理</a></li><li><a href=#232实现高亮>2.3.2.实现高亮</a></li></ul></li><li><a href=#24总结>2.4.总结</a></li></ul><ul><li><a href=#31快速入门>3.1.快速入门</a><ul><li><a href=#311发起查询请求>3.1.1.发起查询请求</a></li><li><a href=#312解析响应>3.1.2.解析响应</a></li><li><a href=#313完整代码>3.1.3.完整代码</a></li><li><a href=#314小结>3.1.4.小结</a></li></ul></li><li><a href=#32match查询>3.2.match查询</a></li><li><a href=#33精确查询>3.3.精确查询</a></li><li><a href=#34布尔查询>3.4.布尔查询</a></li><li><a href=#35排序分页>3.5.排序、分页</a></li><li><a href=#36高亮>3.6.高亮</a><ul><li><a href=#361高亮请求构建>3.6.1.高亮请求构建</a></li><li><a href=#362高亮结果解析>3.6.2.高亮结果解析</a></li></ul></li></ul><ul><li><a href=#41酒店搜索和分页>4.1.酒店搜索和分页</a><ul><li><a href=#411需求分析>4.1.1.需求分析</a></li><li><a href=#412定义实体类>4.1.2.定义实体类</a></li><li><a href=#413定义controller>4.1.3.定义controller</a></li><li><a href=#414实现搜索业务>4.1.4.实现搜索业务</a></li></ul></li><li><a href=#42酒店结果过滤>4.2.酒店结果过滤</a><ul><li><a href=#421需求分析>4.2.1.需求分析</a></li><li><a href=#422修改实体类>4.2.2.修改实体类</a></li><li><a href=#423修改搜索业务>4.2.3.修改搜索业务</a></li></ul></li><li><a href=#43我周边的酒店>4.3.我周边的酒店</a><ul><li><a href=#431需求分析>4.3.1.需求分析</a></li><li><a href=#432修改实体类>4.3.2.修改实体类</a></li><li><a href=#433距离排序api>4.3.3.距离排序API</a></li><li><a href=#434添加距离排序>4.3.4.添加距离排序</a></li><li><a href=#435排序距离显示>4.3.5.排序距离显示</a></li></ul></li><li><a href=#44酒店竞价排名>4.4.酒店竞价排名</a><ul><li><a href=#441需求分析>4.4.1.需求分析</a></li><li><a href=#442修改hoteldoc实体>4.4.2.修改HotelDoc实体</a></li><li><a href=#443添加广告标记>4.4.3.添加广告标记</a></li><li><a href=#444添加算分函数查询>4.4.4.添加算分函数查询</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=zzzi src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.png><p class=site-author-name itemprop=name>zzzi</p><div class=site-description itemprop=description>make_tuple("工作","论文")</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>228</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>54</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zzziCode title="Github → https://github.com/zzziCode" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.png"><meta itemprop=name content="zzzi"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="zzzi"><meta itemprop=description content="make_tuple(&#34;工作&#34;,&#34;论文&#34;)"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Elasticsearch学习笔记2"><meta itemprop=description content="elasticsearch学习笔记2"></span><header class=post-header><h1 class=post-title itemprop="name headline">Elasticsearch学习笔记2</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2024-03-01 20:51:31 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-03-01 20:51:31 +0800 CST">2024-03-01</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0 itemprop=url rel=index><span itemprop=name>学习笔记</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>16272</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>33分钟</span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><blockquote><p>🔍 elasticsearch学习笔记2</p></blockquote><p>本节中主要介绍elasticsearch中的文档搜索功能，这也是它最重要的一个知识点</p><h1 id=1dsl查询文档>1.DSL查询文档
<a class=header-anchor href=#1dsl%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3></a></h1><p>elasticsearch的查询依然是基于JSON风格的<code>DSL</code>来实现的。</p><h2 id=11dsl查询分类>1.1.DSL查询分类
<a class=header-anchor href=#11dsl%e6%9f%a5%e8%af%a2%e5%88%86%e7%b1%bb></a></h2><p>Elasticsearch提供了基于JSON的DSL（
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html title="Domain Specific Language" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Domain Specific Language
<i class="fa fa-external-link-alt"></i>
</a>）来定义查询。常见的查询类型包括：</p><ul><li><p><strong>查询所有</strong>：查询出所有数据，一般测试用。例如：match_all</p></li><li><p><strong>全文检索（full text）查询</strong>：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：</p><ul><li>match_query</li><li>multi_match_query</li></ul></li><li><p><strong>精确查询</strong>：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：</p><ul><li>ids</li><li>range</li><li>term</li></ul></li><li><p><strong>地理（geo）查询</strong>：根据经纬度查询。例如：</p><ul><li>geo_distance</li><li>geo_bounding_box</li></ul></li><li><p><strong>复合（compound）查询</strong>：复合查询可以将上述各种查询条件<strong>组合</strong>起来，合并查询条件。例如：</p><ul><li>bool</li><li>function_score</li></ul></li></ul><p>查询的语法基本一致：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;查询类型&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;查询条件&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;条件值&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们以查询所有为例，其中：</p><ul><li>查询类型为match_all</li><li>没有查询条件，所以match_all中的花括号没有值</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// 查询所有
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>其它查询无非就是<strong>查询类型</strong>、<strong>查询条件</strong>的变化。</p><h2 id=12全文检索查询>1.2.全文检索查询
<a class=header-anchor href=#12%e5%85%a8%e6%96%87%e6%a3%80%e7%b4%a2%e6%9f%a5%e8%af%a2></a></h2><h3 id=121使用场景>1.2.1.使用场景
<a class=header-anchor href=#121%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af></a></h3><p>全文检索查询的基本流程如下：</p><ul><li>对用户搜索的内容做<strong>分词</strong>，得到词条</li><li>根据词条去倒排索引库中匹配，得到文档id</li><li>根据文档id找到文档，返回给用户</li></ul><blockquote><p>相当于用户输入一个内容，elasticsearch将其进行分词，然后根据词条去查询匹配，根据所有查询匹配到的id找到文档返回给用户</p></blockquote><p>比较常用的场景包括：</p><ul><li>商城的输入框搜索</li><li>百度输入框搜索</li></ul><p>例如京东：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056925.png alt=image-20210721165326938></p><p>因为是拿着词条去匹配，因此参与搜索的字段也<strong>必须是可分词</strong>的text类型的字段。</p><h3 id=122基本语法>1.2.2.基本语法
<a class=header-anchor href=#122%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95></a></h3><p>常见的全文检索查询包括：</p><ul><li>match查询：单字段查询</li><li>multi_match查询：多字段查询，任意一个字段符合条件就算符合查询条件</li></ul><p>match查询语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;TEXT&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>mulit_match语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;multi_match&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;TEXT&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;fields&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#e6db74>&#34;FIELD1&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34; FIELD12&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=123示例>1.2.3.示例
<a class=header-anchor href=#123%e7%a4%ba%e4%be%8b></a></h3><p>match查询示例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056931.png alt=image-20210721170455419 style=zoom:50%><p>这里的all字段是一个组合字段，将name，brand，business中所有的词条组合在一起形成的新字段</p><p>multi_match查询示例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056932.png alt=image-20210721170720691 style=zoom:50%><p>可以看到，两种查询结果是一样的，为什么？</p><p>因为我们将brand、name、business值都利用copy_to复制到了all字段中。all一个字段包含了三个字段中的所有值。因此你根据三个字段搜索，和根据all字段搜索效果当然一样了。</p><p>但是，搜索字段越多，对查询性能影响越大，因此建议采用copy_to，然后单字段查询的方式。只是这一个字段中包含的值更多，查询时不用切换字段不会使得查询性能降低</p><blockquote><p>这里得到一个启发，如果某些字段经常使用多字段查询，那么可以将这几个字段复制到一个新字段中，新字段本身没有任何意义，只是为了加快查询效率而将这些字段的值都包含了</p></blockquote><h3 id=124总结>1.2.4.总结
<a class=header-anchor href=#124%e6%80%bb%e7%bb%93></a></h3><p>match和multi_match的区别是什么？</p><ul><li>match：根据<strong>一个字段</strong>查询</li><li>multi_match：根据<strong>多个字段</strong>查询，参与查询字段越多，查询性能越差，所以可以将多字段copy到一个字段中</li></ul><h2 id=13精准查询>1.3.精准查询
<a class=header-anchor href=#13%e7%b2%be%e5%87%86%e6%9f%a5%e8%af%a2></a></h2><p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以<strong>不会</strong>对搜索条件分词。常见的有：</p><ul><li>term：根据词条精确值查询</li><li>range：根据值的范围查询</li></ul><h3 id=131term查询>1.3.1.term查询
<a class=header-anchor href=#131term%e6%9f%a5%e8%af%a2></a></h3><p>因为精确查询的字段<strong>搜索的是不分词的字段</strong>，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，用户输入的内容跟自动值<strong>完全匹配</strong>时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p><p>语法说明：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// term查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;value&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;VALUE&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>示例：</p><p>当我搜索的是精确词条时，能正确查询出结果：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056933.png alt=image-20210721171655308></p><p>但是，当我搜索的内容不是词条，而是多个词语形成的短语时，反而搜索不到：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056934.png alt=image-20210721171838378></p><p>因为此时是term精确查询，针对输入的内容不会进行分词，而索引库中没有一个文档的字段是“杭州上海”，从而导致搜索不到任何文档</p><h3 id=132range查询>1.3.2.range查询
<a class=header-anchor href=#132range%e6%9f%a5%e8%af%a2></a></h3><p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。</p><p>基本语法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// range查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;range&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;gte&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>10</span>, <span style=color:#75715e>// 这里的gte代表大于等于，gt则代表大于，其中的e代表equals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;lte&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>20</span> <span style=color:#75715e>// lte代表小于等于，lt则代表小于
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>示例：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056936.png alt=image-20210721172307172></p><h3 id=133总结>1.3.3.总结
<a class=header-anchor href=#133%e6%80%bb%e7%bb%93></a></h3><p>精确查询常见的有哪些？</p><ul><li>term查询：根据词条精确匹配，一般搜索keyword类型、数值类型、布尔类型、日期类型字段</li><li>range查询：根据数值范围查询，可以是数值、日期的范围</li></ul><h2 id=14地理坐标查询>1.4.地理坐标查询
<a class=header-anchor href=#14%e5%9c%b0%e7%90%86%e5%9d%90%e6%a0%87%e6%9f%a5%e8%af%a2></a></h2><p>所谓的地理坐标查询，其实就是根据经纬度查询，官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</p><p>常见的使用场景包括：</p><ul><li>携程：搜索我附近的酒店</li><li>滴滴：搜索我附近的出租车</li><li>微信：搜索我附近的人</li></ul><p>附近的酒店：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056937.png alt=image-20210721172645103 style=zoom:50%><p>附近的车：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056938.png alt=image-20210721172654880 style=zoom:50%><p>此时会根据经纬度算出附近的符合要求的文档然后返回</p><h3 id=141矩形范围查询>1.4.1.矩形范围查询
<a class=header-anchor href=#141%e7%9f%a9%e5%bd%a2%e8%8c%83%e5%9b%b4%e6%9f%a5%e8%af%a2></a></h3><p>矩形范围查询，也就是geo_bounding_box查询，查询坐标落在某个矩形范围的所有文档：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056939.gif alt=DKV9HZbVS6></p><p>查询时，需要指定矩形的<strong>左上</strong>、<strong>右下</strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。</p><p>语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// geo_bounding_box查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;geo_bounding_box&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;top_left&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{ <span style=color:#75715e>// 左上点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;lat&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>31.1</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;lon&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>121.5</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;bottom_right&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{ <span style=color:#75715e>// 右下点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;lat&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>30.9</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;lon&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>121.7</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这种并不符合“附近的人”这样的需求，因为这种需要指定范围，所以我们就不做了。</p><h3 id=142附近查询>1.4.2.附近查询
<a class=header-anchor href=#142%e9%99%84%e8%bf%91%e6%9f%a5%e8%af%a2></a></h3><p>附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档。</p><p>换句话来说，在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056940.gif alt=vZrdKAh19C></p><p>语法说明：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// geo_distance 查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;geo_distance&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;distance&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;15km&#34;</span>, <span style=color:#75715e>// 半径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;31.21,121.5&#34;</span> <span style=color:#75715e>// 圆心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这种查询只用指定圆心和半径就可以查询这个圆内的所有文档</p><p>示例：</p><p>我们先搜索陆家嘴附近15km的酒店：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056941.png alt=image-20210721175443234 style=zoom:50%><p>发现共有47家酒店。</p><p>然后把半径缩短到3公里：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056942.png alt=image-20210721182031475 style=zoom:50%><p>可以发现，搜索到的酒店数量减少到了5家。这种搜索更加符合附近的人，附近的车等搜索需求</p><h2 id=15复合查询>1.5.复合查询
<a class=header-anchor href=#15%e5%a4%8d%e5%90%88%e6%9f%a5%e8%af%a2></a></h2><p>复合（compound）查询：复合查询可以<strong>将简单查询组合</strong>起来，实现更复杂的搜索逻辑。常见的有两种：</p><ul><li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名</li><li>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</li></ul><h3 id=151相关性算分>1.5.1.相关性算分
<a class=header-anchor href=#151%e7%9b%b8%e5%85%b3%e6%80%a7%e7%ae%97%e5%88%86></a></h3><p>当我们利用match查询时，文档结果会根据与搜索词条的关联度<strong>打分</strong>（_score），返回结果时按照分值降序排列。</p><p>例如，我们搜索 &ldquo;虹桥如家&rdquo;，结果如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_score&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>17.850193</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_source&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;虹桥如家酒店真不错&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_score&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>12.259849</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_source&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;外滩如家酒店真不错&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_score&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>11.91091</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;_source&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;迪士尼如家酒店真不错&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>]
</span></span></code></pre></td></tr></table></div></div><p>在elasticsearch中，早期使用的打分算法是TF-IDF算法，公式如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056943.png alt=image-20210721190152134 style=zoom:50%><p>在后来的5.1版本升级中，elasticsearch将算法改进为BM25算法，公式如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056944.png alt=image-20210721190416214 style=zoom:50%><p>TF-IDF算法有一个缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而BM25则会让单个词条的算分有一个上限，曲线更加平滑：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056945.png alt=image-20210721190907320 style=zoom:50%><p>小结：elasticsearch会根据词条和文档的相关度做打分，算法由两种：</p><ul><li>TF-IDF算法</li><li>BM25算法，elasticsearch5.1版本后采用的算法</li></ul><h3 id=152算分函数查询>1.5.2.算分函数查询
<a class=header-anchor href=#152%e7%ae%97%e5%88%86%e5%87%bd%e6%95%b0%e6%9f%a5%e8%af%a2></a></h3><p>根据相关度打分是比较合理的需求，但<strong>合理的不一定是产品经理需要</strong>的。</p><p>以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁掏的钱多排名就越靠前。如图，也就是在相关度更高的得分高的基础上，付费的广告得分更高：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056946.png alt=image-20210721191144560 style=zoom:50%><p>要想认为控制相关性算分，就需要利用elasticsearch中的function score 查询了。</p><h4 id=1语法说明>1）语法说明
<a class=header-anchor href=#1%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e></a></h4><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056947.png alt=image-20210721191544750 style=zoom:50%><p>function score 查询中包含四部分内容：</p><ul><li><strong>原始查询</strong>条件：query部分，基于这个条件搜索文档，并且基于BM25算法给文档打分，最后得到<strong>原始算分</strong>（query score)</li><li><strong>过滤条件</strong>：filter部分，符合该条件的文档才会<strong>重新算分</strong></li><li><strong>算分函数</strong>：符合filter条件的文档要根据这个<strong>函数</strong>做运算，得到的<strong>函数算分</strong>（function score），有四种函数<ul><li>weight：函数结果是常量</li><li>field_value_factor：以文档中的某个字段值作为函数结果</li><li>random_score：以随机数作为函数结果</li><li>script_score：自定义算分函数算法</li></ul></li><li><strong>运算模式</strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：<ul><li>multiply：相乘，用之前的原始算分乘以一个数</li><li>replace：用function score替换query score</li><li>其它，例如：sum、avg、max、min</li></ul></li></ul><p>function score的运行流程如下：</p><ul><li>1）根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong>（query score）</li><li>2）根据<strong>过滤条件</strong>，过滤文档</li><li>3）符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong>（function score）</li><li>4）将<strong>原始算分</strong>（query score）和<strong>函数算分</strong>（function score）基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li></ul><p>因此，其中的关键点是：</p><ul><li>过滤条件：决定<strong>哪些</strong>文档的算分被修改</li><li>算分函数：决定<strong>函数算分</strong>的算法</li><li>运算模式：决定<strong>最终算分</strong>结果</li></ul><h4 id=2示例>2）示例
<a class=header-anchor href=#2%e7%a4%ba%e4%be%8b></a></h4><p>需求：给“如家”这个品牌的酒店排名靠前一些</p><p>翻译一下这个需求，转换为之前说的四个要点：</p><ul><li>原始条件：不确定，可以任意变化，例如上海的酒店</li><li>过滤条件：brand = &ldquo;如家&rdquo;</li><li>算分函数：可以简单粗暴，直接给固定的算分结果，weight</li><li>运算模式：比如求和</li></ul><p>因此最终的DSL语句如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;function_score&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span>      	<span style=color:#f92672>&#34;match&#34;</span>:{
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;all&#34;</span>:<span style=color:#e6db74>&#34;上海&#34;</span>
</span></span><span style=display:flex><span>      	}
</span></span><span style=display:flex><span>      }, <span style=color:#75715e>// 原始查询，可以是任意条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;functions&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 算分函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;filter&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 满足的条件，品牌必须是如家
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>            </span><span style=color:#f92672>&#34;term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              </span><span style=color:#f92672>&#34;brand&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;如家&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;weight&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 算分权重为2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;boost_mode&#34;</span>: <span style=color:#e6db74>&#34;sum&#34;</span> <span style=color:#75715e>// 加权模式，求和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个查询条件就会现将上海的所有酒店查询出来，然后针对如家重新算分，在原有分数的基础上+10</p><p>测试，在未添加算分函数时，如家得分如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056948.png alt=image-20210721193152520 style=zoom:50%><p>添加了算分函数后，如家得分就提升了：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056949.png alt=image-20210721193458182 style=zoom:50%><h4 id=3小结>3）小结
<a class=header-anchor href=#3%e5%b0%8f%e7%bb%93></a></h4><p>function score query定义的三要素是什么？</p><ul><li>过滤条件：哪些文档要加分</li><li>算分函数：如何计算function score</li><li>加权方式：function score 与 query score如何运算</li></ul><h3 id=153布尔查询>1.5.3.布尔查询
<a class=header-anchor href=#153%e5%b8%83%e5%b0%94%e6%9f%a5%e8%af%a2></a></h3><p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有：</p><ul><li>must：必须匹配每个子查询，类似“与”</li><li>should：选择性匹配子查询，类似“或”</li><li>must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li><li>filter：必须匹配，<strong>不参与算分</strong></li></ul><p>比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056950.png alt=image-20210721193822848 style=zoom:50%><p>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用bool查询了。</p><p>需要注意的是，搜索时，参与<strong>打分的字段越多，查询的性能也越差</strong>。因此这种多条件查询时，建议这样做：</p><ul><li>搜索框的关键字搜索，是全文检索查询，使用must查询，<strong>参与算分</strong></li><li>其它过滤条件，采用filter查询。<strong>不参与算分</strong></li></ul><p>这样有选择性的规定查询的类型可以提高查询效率</p><h4 id=1语法示例>1）语法示例：
<a class=header-anchor href=#1%e8%af%ad%e6%b3%95%e7%a4%ba%e4%be%8b></a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;bool&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;must&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#75715e>//城市必须在上海
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{<span style=color:#f92672>&#34;term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#f92672>&#34;city&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;上海&#34;</span><span style=color:#960050;background-color:#1e0010> </span>}}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>],
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;should&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#75715e>//酒店品牌可以是皇冠假日或者华美达
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{<span style=color:#f92672>&#34;term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#f92672>&#34;brand&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;皇冠假日&#34;</span><span style=color:#960050;background-color:#1e0010> </span>}},
</span></span><span style=display:flex><span>        {<span style=color:#f92672>&#34;term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#f92672>&#34;brand&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;华美达&#34;</span><span style=color:#960050;background-color:#1e0010> </span>}}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>],
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;must_not&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#75715e>//酒店价格必须大于500
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;range&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;price&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;lte&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>500</span><span style=color:#960050;background-color:#1e0010> </span>}<span style=color:#960050;background-color:#1e0010> </span>}}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>],
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;filter&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#75715e>//酒店评分必须在45及以上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;range&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#f92672>&#34;score&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;gte&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>45</span><span style=color:#960050;background-color:#1e0010> </span>}<span style=color:#960050;background-color:#1e0010> </span>}}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=2示例-1>2）示例
<a class=header-anchor href=#2%e7%a4%ba%e4%be%8b-1></a></h4><p>需求：搜索名字<strong>包含</strong>“如家”，价格<strong>不高于</strong>400，在坐标31.21,121.5周围10km<strong>范围内</strong>的酒店。</p><p>分析：</p><ul><li>名称搜索，属于全文检索查询，应该参与算分。放到must中</li><li>价格不高于400，用range查询，属于过滤条件，不参与算分。放到must_not中</li><li>周围10km范围内，用geo_distance查询，属于过滤条件，不参与算分。放到filter中</li></ul><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056951.png alt=image-20210721194744183 style=zoom:50%><h4 id=3小结-1>3）小结
<a class=header-anchor href=#3%e5%b0%8f%e7%bb%93-1></a></h4><p>bool查询有几种逻辑关系？</p><ul><li>must：必须匹配的条件，可以理解为“与”</li><li>should：选择性匹配的条件，可以理解为“或”</li><li>must_not：必须不匹配的条件，不参与打分</li><li>filter：必须匹配的条件，不参与打分</li></ul><h2 id=16小结>1.6.小结
<a class=header-anchor href=#16%e5%b0%8f%e7%bb%93></a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;function_score&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010>...</span>}, <span style=color:#75715e>// 原始查询，可以是任意条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;functions&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 算分函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;filter&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010>...</span>},<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 满足的条件，品牌必须是如家
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;weight&#34;</span>:<span style=color:#960050;background-color:#1e0010> xxx </span><span style=color:#75715e>// 算分权重为2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;boost_mode&#34;</span>: <span style=color:#e6db74>&#34;xxx&#34;</span> <span style=color:#75715e>// 加权模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>基础的查询语句结构就是这样，只是查询类型不一样就导致了形成的DSL不一样，之后还会涉及到算分函数给满足条件的文档重新算分</p><h1 id=2搜索结果处理>2.搜索结果处理
<a class=header-anchor href=#2%e6%90%9c%e7%b4%a2%e7%bb%93%e6%9e%9c%e5%a4%84%e7%90%86></a></h1><p>当我们使用上一节的各种查询方式搜索到文档之后，得到的搜索的结果可以按照用户指定的方式去处理或展示。例如排序，分页，高亮等</p><h2 id=21排序>2.1.排序
<a class=header-anchor href=#21%e6%8e%92%e5%ba%8f></a></h2><p>elasticsearch<strong>默认</strong>是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html title=结果排序 rel="noopener external nofollow noreferrer" target=_blank class=exturl>结果排序
<i class="fa fa-external-link-alt"></i>
</a>。可以排序字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。</p><h3 id=211普通字段排序>2.1.1.普通字段排序
<a class=header-anchor href=#211%e6%99%ae%e9%80%9a%e5%ad%97%e6%ae%b5%e6%8e%92%e5%ba%8f></a></h3><p>keyword、数值、日期类型排序的语法基本一致。</p><p><strong>语法</strong>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;sort&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;desc&#34;</span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#75715e>// 排序字段、排序方式ASC、DESC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序，以此类推</p><p><strong>示例</strong>：</p><p>需求描述：酒店数据按照用户评价（score)降序排序，评价相同的按照价格(price)升序排序</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056952.png alt=image-20210721195728306 style=zoom:50%><p>写在前面的字段先进行排序，当前面的字段相等时才会针对后面的字段进行排序</p><h3 id=212地理坐标排序>2.1.2.地理坐标排序
<a class=header-anchor href=#212%e5%9c%b0%e7%90%86%e5%9d%90%e6%a0%87%e6%8e%92%e5%ba%8f></a></h3><p>地理坐标排序略有不同。</p><p><strong>语法说明</strong>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;sort&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;_geo_distance&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;FIELD&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;纬度，经度&#34;</span>, <span style=color:#75715e>// 文档中geo_point类型的字段名、目标坐标点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;order&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span>, <span style=color:#75715e>// 排序方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;unit&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;km&#34;</span> <span style=color:#75715e>// 排序的距离单位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个查询的含义是：</p><ul><li>指定一个坐标，作为目标点</li><li>计算每一个文档中，指定字段（必须是geo_point类型）的坐标 到目标点的距离是多少</li><li>根据距离排序</li></ul><p><strong>示例：</strong></p><p>需求描述：实现对酒店数据按照到你的位置坐标的距离升序排序</p><p>提示：获取你的位置的经纬度的方式：https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/</p><p>假设我的位置是：31.034661，121.612282，寻找我周围距离最近的酒店。</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056953.png alt=image-20210721200214690 style=zoom:50%><h2 id=22分页>2.2.分页
<a class=header-anchor href=#22%e5%88%86%e9%a1%b5></a></h2><p>elasticsearch 默认情况下只返回<code>top10</code>的数据。而如果要查询更多数据就需要修改分页参数了。elasticsearch中通过修改from、size参数来控制要返回的分页结果：</p><ul><li>from：从第几个文档开始</li><li>size：总共查询几个文档</li></ul><p>类似于mysql中的<code>limit ?, ?</code></p><h3 id=221基本的分页>2.2.1.基本的分页
<a class=header-anchor href=#221%e5%9f%ba%e6%9c%ac%e7%9a%84%e5%88%86%e9%a1%b5></a></h3><p>分页的基本语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;from&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 分页开始的位置，默认为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>10</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 期望获取的文档总数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;sort&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{<span style=color:#f92672>&#34;price&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=222深度分页问题>2.2.2.深度分页问题
<a class=header-anchor href=#222%e6%b7%b1%e5%ba%a6%e5%88%86%e9%a1%b5%e9%97%ae%e9%a2%98></a></h3><p>现在，我要查询990~1000的数据，查询逻辑要这么写：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;from&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>990</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 分页开始的位置，默认为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>10</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 期望获取的文档总数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;sort&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{<span style=color:#f92672>&#34;price&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里是查询990开始的数据，也就是 第990~第1000条 数据。</p><p>不过，elasticsearch内部分页时，必须<strong>先查询</strong> 0~1000条，<strong>再截取</strong>其中的990 ~ 1000的这10条：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056954.png alt=image-20210721200643029 style=zoom:50%><p>查询TOP1000，如果es是单点模式，这并无太大影响。</p><p>但是elasticsearch将来一定是集群，例如我集群有5个节点，我要查询TOP1000的数据，并不是每个节点查询200条就可以了。</p><p>因为节点A的TOP200，在另一个节点可能排到10000名以外了。</p><p>因此要想获取整个集群的TOP1000，必须先查询出每个节点的TOP1000，汇总结果后，重新排名，重新截取TOP1000。</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056955.png alt=image-20210721201003229 style=zoom:50%><p>那如果我要查询9900~10000的数据呢？是不是要先查询TOP10000呢？那每个节点都要查询10000条？汇总到内存中？</p><p>当查询分页深度较大时，汇总数据过多，对内存和CPU会产生非常大的压力，因此elasticsearch会禁止from+ size 超过10000的请求。如果想要修改，可以修改search_after参数</p><p>针对深度分页，ES提供了两种解决方案，
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html title=官方文档 rel="noopener external nofollow noreferrer" target=_blank class=exturl>官方文档
<i class="fa fa-external-link-alt"></i>
</a>：</p><ul><li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li><li>scroll：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。</li></ul><h3 id=223小结>2.2.3.小结
<a class=header-anchor href=#223%e5%b0%8f%e7%bb%93></a></h3><p>分页查询的常见实现方案以及优缺点：</p><ul><li><p><code>from + size</code>：</p><ul><li>优点：支持随机翻页</li><li>缺点：深度分页问题，默认查询上限（from + size）是10000</li><li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li></ul></li><li><p><code>after search</code>：</p><ul><li>优点：没有查询上限（单次查询的size不超过10000）</li><li>缺点：只能<strong>向后逐页</strong>查询，不支持随机翻页，因为是从上一次分页的值向后继续查询</li><li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li></ul></li><li><p><code>scroll</code>：</p><ul><li>优点：没有查询上限（单次查询的size不超过10000）</li><li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li><li>场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。</li></ul></li></ul><h2 id=23高亮>2.3.高亮
<a class=header-anchor href=#23%e9%ab%98%e4%ba%ae></a></h2><h3 id=231高亮原理>2.3.1.高亮原理
<a class=header-anchor href=#231%e9%ab%98%e4%ba%ae%e5%8e%9f%e7%90%86></a></h3><p>什么是高亮显示呢？</p><p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056956.png alt=image-20210721202705030 style=zoom:50%><p>高亮显示的实现分为两步：</p><ul><li>1）给文档中的所有关键字都添加一个标签，例如<code>&lt;em></code>标签</li><li>2）页面给<code>&lt;em></code>标签编写CSS样式，样式决定了关键字的颜色以及字体大小，是否变粗等效果</li></ul><h3 id=232实现高亮>2.3.2.实现高亮
<a class=header-anchor href=#232%e5%ae%9e%e7%8e%b0%e9%ab%98%e4%ba%ae></a></h3><p><strong>高亮的语法</strong>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;TEXT&#34;</span> <span style=color:#75715e>// 查询条件，高亮一定要使用全文检索查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;highlight&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;fields&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 指定要高亮的字段，当要高亮的字段不是搜索字段时需要加上一个属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;FIELD&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;pre_tags&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;&lt;em&gt;&#34;</span>,<span style=color:#960050;background-color:#1e0010>  </span><span style=color:#75715e>// 用来标记高亮字段的前置标签
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;post_tags&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;&lt;/em&gt;&#34;</span><span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 用来标记高亮字段的后置标签
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>注意：</strong></p><ul><li>高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li><li>默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li><li>如果要对<strong>非搜索字段高亮</strong>，则需要添加一个属性：<code>required_field_match=false</code>，例如搜索的是all字段，但是想要高亮的只是name字段，不想要所有的地方都高亮，此时就需要加上这个属性</li></ul><p><strong>示例</strong>：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056957.png alt=image-20210721203349633 style=zoom:50%><p>默认情况下，高亮自动添加的是<code>&lt;em>&lt;/em></code>标签</p><h2 id=24总结>2.4.总结
<a class=header-anchor href=#24%e6%80%bb%e7%bb%93></a></h2><p>查询的DSL是一个大的JSON对象，包含下列属性：</p><ul><li>query：查询条件</li><li>from和size：分页条件</li><li>sort：排序条件</li><li>highlight：高亮条件</li></ul><p>示例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056959.png alt=image-20210721203657850 style=zoom:50%><h1 id=3restclient查询文档>3.RestClient查询文档
<a class=header-anchor href=#3restclient%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3></a></h1><p>使用java代码进行文档的查询同样适用昨天学习的 RestHighLevelClient对象，基本步骤包括：</p><ul><li>1）准备Request对象</li><li>2）准备<strong>请求参数</strong></li><li>3）发起请求</li><li>4）解析响应</li></ul><h2 id=31快速入门>3.1.快速入门
<a class=header-anchor href=#31%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8></a></h2><p>我们以match_all查询为例</p><h3 id=311发起查询请求>3.1.1.发起查询请求
<a class=header-anchor href=#311%e5%8f%91%e8%b5%b7%e6%9f%a5%e8%af%a2%e8%af%b7%e6%b1%82></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056960.png alt=image-20210721203950559></p><p>代码解读：</p><ul><li><p>第一步，创建<code>SearchRequest</code>对象，指定索引库名</p></li><li><p>第二步，利用<code>request.source()</code>构建 DSL，DSL中可以包含查询、分页、排序、高亮等</p><ul><li><code>query()</code>：代表查询条件，利用<code>QueryBuilders.matchAllQuery()</code>构建一个match_all查询的DSL</li></ul></li><li><p>第三步，利用client.search()发送请求，得到响应</p></li></ul><p>这里关键的API有两个，一个是<code>request.source()</code>，其中包含了查询、排序、分页、高亮等所有功能，之后利用这个方法进行文档的各种查询：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056961.png alt=image-20210721215640790 style=zoom:50%><p>另一个是<code>QueryBuilders</code>，其中包含match、term、function_score、bool等各种查询：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056962.png alt=image-20210721215729236 style=zoom:50%><p>拼接好之后利用client向elasticsearch发送查询请求并得到结果</p><h3 id=312解析响应>3.1.2.解析响应
<a class=header-anchor href=#312%e8%a7%a3%e6%9e%90%e5%93%8d%e5%ba%94></a></h3><p>响应结果的解析：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056963.png alt=image-20210721214221057 style=zoom:50%><p>获取到最终查询到的string类型的文档之后，可以将其转换成java对象进行处理</p><p>elasticsearch返回的结果是一个JSON字符串，结构包含：</p><ul><li><code>hits</code>：命中的结果<ul><li><code>total</code>：总条数，其中的value是具体的总条数值</li><li><code>max_score</code>：所有结果中得分最高的文档的相关性算分</li><li><code>hits</code>：搜索结果的文档数组，其中的每个文档都是一个json对象<ul><li><code>_source</code>：文档中的原始数据，也是json对象</li></ul></li></ul></li></ul><p>因此，我们解析响应结果，就是<strong>逐层解析</strong>JSON字符串，流程如下：</p><ul><li><code>SearchHits</code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果<ul><li><code>SearchHits#getTotalHits().value</code>：获取总条数信息</li><li><code>SearchHits#getHits()</code>：获取SearchHit数组，也就是文档数组<ul><li><code>SearchHit#getSourceAsString()</code>：获取文档结果中的_source，也就是原始的json文档数据</li></ul></li></ul></li></ul><h3 id=313完整代码>3.1.3.完整代码
<a class=header-anchor href=#313%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81></a></h3><p>完整代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testMatchAll</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchAllQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleResponse</span><span style=color:#f92672>(</span>SearchResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHits searchHits <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.1.获取总条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>long</span> total <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getTotalHits</span><span style=color:#f92672>().</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;共搜索到&#34;</span> <span style=color:#f92672>+</span> total <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;条数据&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.2.文档数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHit<span style=color:#f92672>[]</span> hits <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.3.遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SearchHit hit <span style=color:#f92672>:</span> hits<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取文档source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String json <span style=color:#f92672>=</span> hit<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceAsString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 反序列化，将String类型的json数据转换成java对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HotelDoc hotelDoc <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> HotelDoc<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotelDoc = &#34;</span> <span style=color:#f92672>+</span> hotelDoc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=314小结>3.1.4.小结
<a class=header-anchor href=#314%e5%b0%8f%e7%bb%93></a></h3><p>查询的基本步骤是：</p><ol><li><p>创建SearchRequest对象</p></li><li><p>准备Request.source()，也就是DSL。</p><p>① QueryBuilders来构建查询条件</p><p>② 传入Request.source() 的 query() 方法</p></li><li><p>发送请求，得到结果</p></li><li><p>解析结果（参考JSON结果，从外到内，逐层解析）</p></li></ol><h2 id=32match查询>3.2.match查询
<a class=header-anchor href=#32match%e6%9f%a5%e8%af%a2></a></h2><p>全文检索的match和multi_match查询与match_all的API基本一致。差别是查询条件，也就是query的部分。</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056964.png alt=image-20210721215923060 style=zoom:50%><p>因此，Java代码上的差异主要是request.source().query()中的参数了。同样是利用QueryBuilders提供的方法：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056965.png alt=image-20210721215843099></p><p>而结果解析代码则完全一致，可以抽取并共享。</p><p>完整代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testMatch</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.准备DSL，如果是多字段查询，第一个参数是查询条件，后面的参数是查询字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;如家&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=33精确查询>3.3.精确查询
<a class=header-anchor href=#33%e7%b2%be%e7%a1%ae%e6%9f%a5%e8%af%a2></a></h2><p>精确查询主要是两者：</p><ul><li>term：词条精确匹配</li><li>range：范围查询</li></ul><p>与之前的查询相比，差异同样在查询条件，其它都一样。</p><p>查询条件构造的API如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056966.png alt=image-20210721220305140 style=zoom:50%><h2 id=34布尔查询>3.4.布尔查询
<a class=header-anchor href=#34%e5%b8%83%e5%b0%94%e6%9f%a5%e8%af%a2></a></h2><p>布尔查询是用must、must_not、filter等方式组合其它查询，代码示例如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056967.png alt=image-20210721220927286 style=zoom:50%><p>可以看到，API与其它查询的差别同样是在查询条件的构建，QueryBuilders，结果解析等其他代码完全不变。</p><p>完整代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testBool</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 2.1.准备BooleanQuery
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//不再是直接用QueryBuilders进行拼接，而是使用BooleanQuery
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BoolQueryBuilder boolQuery <span style=color:#f92672>=</span> QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>boolQuery</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.2.添加term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;city&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;杭州&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.3.添加range
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>rangeQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;price&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>lte</span><span style=color:#f92672>(</span><span style=color:#ae81ff>250</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>boolQuery<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=35排序分页>3.5.排序、分页
<a class=header-anchor href=#35%e6%8e%92%e5%ba%8f%e5%88%86%e9%a1%b5></a></h2><p>搜索结果的排序和分页是与query同级的参数，因此同样是使用request.source()来设置。</p><p>对应的API如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056968.png alt=image-20210721221121266 style=zoom:50%><p>完整代码示例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testPageAndSort</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 页码，每页大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> page <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> size <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.准备DSL，将所有的查询条件进行拼接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 2.1.query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchAllQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.2.排序 sort
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;price&#34;</span><span style=color:#f92672>,</span> SortOrder<span style=color:#f92672>.</span><span style=color:#a6e22e>ASC</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.3.分页 from、size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>from</span><span style=color:#f92672>((</span>page <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>*</span> size<span style=color:#f92672>).</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>5</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=36高亮>3.6.高亮
<a class=header-anchor href=#36%e9%ab%98%e4%ba%ae></a></h2><p>高亮的代码与之前代码差异较大，有两点：</p><ul><li>查询的DSL：其中除了查询条件，还需要添加高亮条件，同样是与query同级。</li><li>结果解析：结果除了要解析_source文档数据，还要解析高亮结果</li></ul><h3 id=361高亮请求构建>3.6.1.高亮请求构建
<a class=header-anchor href=#361%e9%ab%98%e4%ba%ae%e8%af%b7%e6%b1%82%e6%9e%84%e5%bb%ba></a></h3><p>高亮请求的构建API如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056969.png alt=image-20210721221744883 style=zoom:50%><p>上述代码省略了查询条件部分，但是大家不要忘了：高亮查询必须使用<strong>全文检索查询</strong>，并且要有搜索关键字，将来才可以对关键字高亮。</p><p>完整代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testHighlight</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 2.1.query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;如家&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.2.高亮，因为要高亮的字段时非查询字段，所以要设置属性requireFieldMatch为false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>highlighter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HighlightBuilder<span style=color:#f92672>().</span><span style=color:#a6e22e>field</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>requireFieldMatch</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应，此时响应得到的结果中，name字段就带上了&lt;em&gt;&lt;/em&gt;标签
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=362高亮结果解析>3.6.2.高亮结果解析
<a class=header-anchor href=#362%e9%ab%98%e4%ba%ae%e7%bb%93%e6%9e%9c%e8%a7%a3%e6%9e%90></a></h3><p><strong>高亮的结果与查询的文档结果默认是分离</strong>的，并不在一起。</p><p>因此解析高亮的代码需要额外处理：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056970.png alt=image-20210721222057212 style=zoom:50%><p>代码解读：</p><ul><li>第一步：从结果中获取source。hit.getSourceAsString()，这部分是非高亮结果，json字符串。还需要反序列为HotelDoc对象</li><li>第二步：获取高亮结果。hit.getHighlightFields()，返回值是一个Map，key是高亮字段名称，值是HighlightField对象，代表高亮值，因为可能不止一个字段被高亮</li><li>第三步：从map中根据高亮字段名称，获取高亮字段值对象HighlightField</li><li>第四步：从HighlightField中获取Fragments，并且转为字符串。这部分就是真正的高亮字符串了</li><li>第五步：用高亮的结果<strong>替换</strong>HotelDoc中的非高亮结果</li></ul><p>完整代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleResponse</span><span style=color:#f92672>(</span>SearchResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHits searchHits <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.1.获取总条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>long</span> total <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getTotalHits</span><span style=color:#f92672>().</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;共搜索到&#34;</span> <span style=color:#f92672>+</span> total <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;条数据&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.2.文档数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHit<span style=color:#f92672>[]</span> hits <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.3.遍历所有得到的文档结果并解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SearchHit hit <span style=color:#f92672>:</span> hits<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取文档source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String json <span style=color:#f92672>=</span> hit<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceAsString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 反序列化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HotelDoc hotelDoc <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> HotelDoc<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取高亮结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> HighlightField<span style=color:#f92672>&gt;</span> highlightFields <span style=color:#f92672>=</span> hit<span style=color:#f92672>.</span><span style=color:#a6e22e>getHighlightFields</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>CollectionUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>highlightFields<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 根据字段名获取高亮结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            HighlightField highlightField <span style=color:#f92672>=</span> highlightFields<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>highlightField <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 获取高亮值，第一个就是名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 如果对all字段高亮，高亮结果数组中就有多个值，因为一个文档中的all字段拷贝了多个字段的内容，这些内容都可能高亮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//如果对多个字段高亮，此时就会有多个高亮结果数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String name <span style=color:#f92672>=</span> highlightField<span style=color:#f92672>.</span><span style=color:#a6e22e>getFragments</span><span style=color:#f92672>()[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>].</span><span style=color:#a6e22e>string</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 覆盖非高亮结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                hotelDoc<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotelDoc = &#34;</span> <span style=color:#f92672>+</span> hotelDoc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=4黑马旅游案例>4.黑马旅游案例
<a class=header-anchor href=#4%e9%bb%91%e9%a9%ac%e6%97%85%e6%b8%b8%e6%a1%88%e4%be%8b></a></h1><p>下面，我们通过黑马旅游的案例来实战演练下之前学习的知识。</p><p>我们实现四部分功能：</p><ul><li>酒店搜索和分页</li><li>酒店结果过滤</li><li>我周边的酒店</li><li>酒店竞价排名</li></ul><p>启动我们提供的hotel-demo项目，其默认端口是8089，访问http://localhost:8090，就能看到项目页面了：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056971.png alt=image-20210721223159598 style=zoom:50%><h2 id=41酒店搜索和分页>4.1.酒店搜索和分页
<a class=header-anchor href=#41%e9%85%92%e5%ba%97%e6%90%9c%e7%b4%a2%e5%92%8c%e5%88%86%e9%a1%b5></a></h2><p>案例需求：实现黑马旅游的酒店搜索功能，完成关键字搜索和分页</p><h3 id=411需求分析>4.1.1.需求分析
<a class=header-anchor href=#411%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90></a></h3><p>在项目的首页，有一个大大的搜索框，还有分页按钮：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056972.png alt=image-20210721223859419 style=zoom:50%><p>点击搜索按钮，可以看到浏览器控制台发出了请求：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056973.png alt=image-20210721224033789 style=zoom:50%><p>请求参数如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056974.png alt=image-20210721224112708 style=zoom:50%><p>由此可以知道，我们这个请求的信息如下：</p><ul><li>请求方式：POST</li><li>请求路径：/hotel/list</li><li>请求参数：JSON对象，包含4个字段：<ul><li>key：搜索关键字</li><li>page：页码</li><li>size：每页大小</li><li>sortBy：排序，目前暂不实现</li></ul></li><li>返回值：分页查询，需要返回分页结果<code>PageResult</code>，包含两个属性：<ul><li><code>total</code>：总条数</li><li><code>List&lt;HotelDoc></code>：当前页的数据</li></ul></li></ul><blockquote><p>请求参数的格式从请求中就能看出来，返回的结果只有在前端代码中才能看出来需要什么结构的数据</p></blockquote><p>因此，我们实现业务的流程如下：</p><ul><li>步骤一：定义实体类，接收请求参数的JSON对象</li><li>步骤二：编写controller，接收页面的请求</li><li>步骤三：编写业务实现，利用RestHighLevelClient实现搜索、分页</li></ul><h3 id=412定义实体类>4.1.2.定义实体类
<a class=header-anchor href=#412%e5%ae%9a%e4%b9%89%e5%ae%9e%e4%bd%93%e7%b1%bb></a></h3><p>实体类有两个，一个是前端的请求参数实体，一个是服务端应该返回的响应结果实体。</p><p>1）请求参数</p><p>前端请求的json结构如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;搜索关键字&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;page&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;sortBy&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>因此，我们在<code>cn.itcast.hotel.pojo</code>包下定义一个实体类：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestParams</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer page<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sortBy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>2）返回值</p><p>分页查询，需要返回分页结果PageResult，包含两个属性：</p><ul><li><code>total</code>：总条数</li><li><code>List&lt;HotelDoc></code>：当前页的数据</li></ul><p>因此，我们在<code>cn.itcast.hotel.pojo</code>中定义返回结果：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PageResult</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//包含当前查询到了多少条文档以及所有的文档被存储到一个容器中返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Long total<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>HotelDoc<span style=color:#f92672>&gt;</span> hotels<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>PageResult</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>PageResult</span><span style=color:#f92672>(</span>Long total<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>HotelDoc<span style=color:#f92672>&gt;</span> hotels<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>total</span> <span style=color:#f92672>=</span> total<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hotels</span> <span style=color:#f92672>=</span> hotels<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=413定义controller>4.1.3.定义controller
<a class=header-anchor href=#413%e5%ae%9a%e4%b9%89controller></a></h3><p>定义一个HotelController，声明查询接口，满足下列要求：</p><ul><li>请求方式：Post</li><li>请求路径：/hotel/list</li><li>请求参数：对象，类型为RequestParam</li><li>返回值：PageResult，包含两个属性<ul><li><code>Long total</code>：总条数</li><li><code>List&lt;HotelDoc> hotels</code>：酒店数据</li></ul></li></ul><p>因此，我们在<code>cn.itcast.hotel.web</code>中定义HotelController：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/hotel&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HotelController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IHotelService hotelService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 搜索酒店数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PageResult <span style=color:#a6e22e>search</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> RequestParams params<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> hotelService<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=414实现搜索业务>4.1.4.实现搜索业务
<a class=header-anchor href=#414%e5%ae%9e%e7%8e%b0%e6%90%9c%e7%b4%a2%e4%b8%9a%e5%8a%a1></a></h3><p>我们在controller调用了IHotelService，并没有实现该方法，因此下面我们就在IHotelService中定义方法，并且去实现业务逻辑。</p><p>1）在<code>cn.itcast.hotel.service</code>中的<code>IHotelService</code>接口中定义一个方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据关键字搜索酒店信息
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param params 请求参数对象，包含用户输入的关键字 
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 酒店文档列表
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>PageResult <span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><p>2）实现搜索业务，肯定离不开RestHighLevelClient，我们需要把它注册到Spring中作为一个Bean。在<code>cn.itcast.hotel</code>中的<code>HotelDemoApplication</code>中声明这个Bean，之后spring自动将其注册为bean：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RestHighLevelClient <span style=color:#a6e22e>client</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>  <span style=color:#66d9ef>new</span> RestHighLevelClient<span style=color:#f92672>(</span>RestClient<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        HttpHost<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://192.168.150.101:9200&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3）在<code>cn.itcast.hotel.service.impl</code>中的<code>HotelService</code>中实现search方法，向elasticsearch中发送DSL语句得到结果：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> PageResult <span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 2.1.query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String key <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>key<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchAllQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>,</span> key<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.2.分页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> page <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>from</span><span style=color:#f92672>((</span>page <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>*</span> size<span style=color:#f92672>).</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span>size<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 结果解析，主要是将查询到的json数据中的hits中的数据取出来并解析成java对象 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> PageResult <span style=color:#a6e22e>handleResponse</span><span style=color:#f92672>(</span>SearchResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHits searchHits <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.1.获取总条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>long</span> total <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getTotalHits</span><span style=color:#f92672>().</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.2.文档数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SearchHit<span style=color:#f92672>[]</span> hits <span style=color:#f92672>=</span> searchHits<span style=color:#f92672>.</span><span style=color:#a6e22e>getHits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.3.遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>HotelDoc<span style=color:#f92672>&gt;</span> hotels <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SearchHit hit <span style=color:#f92672>:</span> hits<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取文档source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String json <span style=color:#f92672>=</span> hit<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceAsString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 反序列化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HotelDoc hotelDoc <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> HotelDoc<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 放入集合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        hotels<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>hotelDoc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.4.封装返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PageResult<span style=color:#f92672>(</span>total<span style=color:#f92672>,</span> hotels<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=42酒店结果过滤>4.2.酒店结果过滤
<a class=header-anchor href=#42%e9%85%92%e5%ba%97%e7%bb%93%e6%9e%9c%e8%bf%87%e6%bb%a4></a></h2><p>需求：添加品牌、城市、星级、价格等过滤功能</p><h3 id=421需求分析>4.2.1.需求分析
<a class=header-anchor href=#421%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90></a></h3><p>在页面搜索框下面，会有一些过滤项：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056975.png alt=image-20210722091940726></p><p>传递的参数如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056976.png alt=image-20210722092051994 style=zoom:50%><p>包含的过滤条件有：</p><ul><li>brand：品牌值</li><li>city：城市</li><li>minPrice~maxPrice：价格范围</li><li>starName：星级</li></ul><p>我们需要做两件事情：</p><ul><li>修改请求参数的对象RequestParams，接收上述参数</li><li>修改业务逻辑，在搜索条件之外，添加一些过滤条件</li></ul><h3 id=422修改实体类>4.2.2.修改实体类
<a class=header-anchor href=#422%e4%bf%ae%e6%94%b9%e5%ae%9e%e4%bd%93%e7%b1%bb></a></h3><p>修改在<code>cn.itcast.hotel.pojo</code>包下的实体类RequestParams：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestParams</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer page<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sortBy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 下面是新增的过滤条件参数，这些参数可能为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String brand<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String starName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer minPrice<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer maxPrice<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=423修改搜索业务>4.2.3.修改搜索业务
<a class=header-anchor href=#423%e4%bf%ae%e6%94%b9%e6%90%9c%e7%b4%a2%e4%b8%9a%e5%8a%a1></a></h3><p>在HotelService的search方法中，只有一个地方需要修改：requet.source().query( &mldr; )其中的查询条件。</p><p>在之前的业务中，只有match查询，根据关键字搜索，现在要添加条件过滤，包括：</p><ul><li>品牌过滤：是keyword类型，用term查询</li><li>星级过滤：是keyword类型，用term查询</li><li>价格过滤：是数值类型，用range查询</li><li>城市过滤：是keyword类型，用term查询</li></ul><p>多个查询条件组合，肯定是boolean查询来组合：</p><ul><li>关键字搜索放到must中，参与算分</li><li>其它过滤条件放到filter中，不参与算分</li></ul><p>因为条件构建的逻辑比较复杂，这里先封装为一个函数：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056977.png alt=image-20210722092935453></p><p><code>buildBasicQuery</code>的代码如下，这里主要是拼接好request：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>buildBasicQuery</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>,</span> SearchRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.构建BooleanQuery
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BoolQueryBuilder boolQuery <span style=color:#f92672>=</span> QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>boolQuery</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//下面的参数真的传递了才会拼接查询条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 2.关键字搜索
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String key <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>key<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchAllQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>,</span> key<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//下面的条件都是不为空才拼接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 3.城市条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;city&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.品牌条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;brand&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5.星级条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;starName&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 6.价格
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinPrice</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxPrice</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>rangeQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;price&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>gte</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinPrice</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>lte</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxPrice</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 7.放入source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>boolQuery<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=43我周边的酒店>4.3.我周边的酒店
<a class=header-anchor href=#43%e6%88%91%e5%91%a8%e8%be%b9%e7%9a%84%e9%85%92%e5%ba%97></a></h2><p>需求：我附近的酒店</p><h3 id=431需求分析>4.3.1.需求分析
<a class=header-anchor href=#431%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90></a></h3><p>在酒店列表页的右侧，有一个小地图，点击地图的定位按钮，地图会找到你所在的位置：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056978.png alt=image-20210722093414542 style=zoom:50%><p>并且，在前端会发起查询请求，将你的坐标发送到服务端：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056979.png alt=image-20210722093642382 style=zoom:50%><p>我们要做的事情就是基于这个location坐标，然后按照距离对周围酒店排序。实现思路如下：</p><ul><li>修改RequestParams参数，接收location字段</li><li>修改search方法业务逻辑，如果location有值，添加根据geo_distance排序的功能</li></ul><h3 id=432修改实体类>4.3.2.修改实体类
<a class=header-anchor href=#432%e4%bf%ae%e6%94%b9%e5%ae%9e%e4%bd%93%e7%b1%bb></a></h3><p>修改在<code>cn.itcast.hotel.pojo</code>包下的实体类RequestParams：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestParams</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer page<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sortBy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String brand<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String starName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer minPrice<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer maxPrice<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 我当前的地理坐标，这是新增的字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=433距离排序api>4.3.3.距离排序API
<a class=header-anchor href=#433%e8%b7%9d%e7%a6%bb%e6%8e%92%e5%ba%8fapi></a></h3><p>我们以前学习过排序功能，包括两种：</p><ul><li>普通字段排序</li><li>地理坐标排序</li></ul><p>我们只讲了普通字段排序对应的java写法。地理坐标排序只学过DSL语法，如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /indexName/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;match_all&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010> </span><span style=color:#f92672>&#34;sort&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;price&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span><span style=color:#960050;background-color:#1e0010>  </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;_geo_distance&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;FIELD&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;纬度，经度&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;order&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;unit&#34;</span><span style=color:#960050;background-color:#1e0010> </span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;km&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>对应的java代码示例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056980.png alt=image-20210722095227059 style=zoom:50%><h3 id=434添加距离排序>4.3.4.添加距离排序
<a class=header-anchor href=#434%e6%b7%bb%e5%8a%a0%e8%b7%9d%e7%a6%bb%e6%8e%92%e5%ba%8f></a></h3><p>在<code>cn.itcast.hotel.service.impl</code>的<code>HotelService</code>的<code>search</code>方法中，添加一个排序功能：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056981.png alt=image-20210722095902314></p><p>完整代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> PageResult <span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 2.1.query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        buildBasicQuery<span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.2.分页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> page <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>from</span><span style=color:#f92672>((</span>page <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>*</span> size<span style=color:#f92672>).</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span>size<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.3.排序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String location <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getLocation</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>location <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>location<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span>SortBuilders
</span></span><span style=display:flex><span>                                  <span style=color:#f92672>.</span><span style=color:#a6e22e>geoDistanceSort</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;location&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> GeoPoint<span style=color:#f92672>(</span>location<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                                  <span style=color:#f92672>.</span><span style=color:#a6e22e>order</span><span style=color:#f92672>(</span>SortOrder<span style=color:#f92672>.</span><span style=color:#a6e22e>ASC</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                  <span style=color:#f92672>.</span><span style=color:#a6e22e>unit</span><span style=color:#f92672>(</span>DistanceUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>KILOMETERS</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.解析响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> handleResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=435排序距离显示>4.3.5.排序距离显示
<a class=header-anchor href=#435%e6%8e%92%e5%ba%8f%e8%b7%9d%e7%a6%bb%e6%98%be%e7%a4%ba></a></h3><p>重启服务后，测试我的酒店功能：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056982.png alt=image-20210722100040674></p><p>发现确实可以实现对我附近酒店的排序，不过并没有看到酒店到底距离我多远，这该怎么办？</p><p>排序完成后，页面还要<strong>获取</strong>我附近每个酒店的具体<strong>距离</strong>值，这个值在响应结果中是独立的：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056983.png alt=image-20210722095648542></p><p>因此，我们在结果解析阶段，除了解析source部分以外，还要得到sort部分，也就是排序的距离，然后放到响应结果中。</p><p>我们要做两件事：</p><ul><li>修改HotelDoc，添加排序距离字段，用于页面显示</li><li>修改HotelService类中的handleResponse方法，添加对sort值的获取</li></ul><p>1）修改HotelDoc类，添加距离字段</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.NoArgsConstructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HotelDoc</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String address<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer price<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer score<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String brand<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String starName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String business<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String pic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 排序时的 距离值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Object distance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HotelDoc</span><span style=color:#f92672>(</span>Hotel hotel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>address</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getAddress</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>price</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrice</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>score</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getScore</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>brand</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>city</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>starName</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>business</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getBusiness</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//地址等于经纬度拼接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getLatitude</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, &#34;</span> <span style=color:#f92672>+</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getLongitude</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        tis<span style=color:#f92672>.</span><span style=color:#a6e22e>pic</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getPic</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>2）修改HotelService中的handleResponse方法</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056984.png alt=image-20210722100613966></p><p>重启后测试，发现页面能成功显示距离了：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056985.png alt=image-20210722100838604 style=zoom:50%><h2 id=44酒店竞价排名>4.4.酒店竞价排名
<a class=header-anchor href=#44%e9%85%92%e5%ba%97%e7%ab%9e%e4%bb%b7%e6%8e%92%e5%90%8d></a></h2><p>需求：让指定的酒店在搜索结果中排名置顶</p><h3 id=441需求分析>4.4.1.需求分析
<a class=header-anchor href=#441%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90></a></h3><p>要让指定酒店在搜索结果中排名置顶，效果如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056986.png alt=image-20210722100947292 style=zoom:50%><p>页面会给指定的酒店添加<strong>广告</strong>标记</p><p>那怎样才能让指定的酒店排名置顶呢？</p><p>我们之前学习过的function_score查询可以影响算分，算分高了，自然排名也就高了。而function_score包含3个要素：</p><ul><li>过滤条件：哪些文档要加分</li><li>算分函数：如何计算function score</li><li>加权方式：function score 与 query score如何运算</li></ul><p>这里的需求是：让<strong>指定酒店</strong>排名靠前。因此我们需要给这些酒店添加一个标记，这样在过滤条件中就可以<strong>根据这个标记来判断，是否要提高算分</strong>。</p><p>比如，我们给酒店添加一个字段：isAD，Boolean类型：</p><ul><li>true：是广告</li><li>false：不是广告</li></ul><p>这样function_score包含3个要素就很好确定了：</p><ul><li>过滤条件：判断isAD 是否为true，为true的才重新算分</li><li>算分函数：我们可以用最简单暴力的weight，固定加权值</li><li>加权方式：可以用默认的相乘，大大提高算分</li></ul><p>因此，业务的实现步骤包括：</p><ol><li><p>给HotelDoc类添加isAD字段，Boolean类型</p></li><li><p>挑选几个你喜欢的酒店，给它的文档数据添加isAD字段，值为true</p></li><li><p>修改search方法，添加function score功能，给isAD值为true的酒店增加权重</p></li></ol><h3 id=442修改hoteldoc实体>4.4.2.修改HotelDoc实体
<a class=header-anchor href=#442%e4%bf%ae%e6%94%b9hoteldoc%e5%ae%9e%e4%bd%93></a></h3><p>给<code>cn.itcast.hotel.pojo</code>包下的HotelDoc类添加isAD字段：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056987.png alt=image-20210722101908062></p><p>这里添加广告标记的目的是为了前端给对应的记录打上广告标记</p><h3 id=443添加广告标记>4.4.3.添加广告标记
<a class=header-anchor href=#443%e6%b7%bb%e5%8a%a0%e5%b9%bf%e5%91%8a%e6%a0%87%e8%ae%b0></a></h3><p>接下来，我们挑几个酒店，添加isAD字段，设置为true：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>//给索引库中的几个文档添加一个isAD字段并设置为true，代表这几个文档投了广告
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>/hotel/_update/</span><span style=color:#ae81ff>1902197537</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;doc&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;isAD&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>/hotel/_update/</span><span style=color:#ae81ff>2056126831</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;doc&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;isAD&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>/hotel/_update/</span><span style=color:#ae81ff>1989806195</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;doc&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;isAD&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>/hotel/_update/</span><span style=color:#ae81ff>2056105938</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;doc&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;isAD&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=444添加算分函数查询>4.4.4.添加算分函数查询
<a class=header-anchor href=#444%e6%b7%bb%e5%8a%a0%e7%ae%97%e5%88%86%e5%87%bd%e6%95%b0%e6%9f%a5%e8%af%a2></a></h3><p>接下来我们就要修改查询条件了。之前是用的boolean 查询，现在要改成function_socre查询。</p><p>function_score查询结构如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056947.png alt=image-20210721191544750></p><p>对应的JavaAPI如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403012056988.png alt=image-20210722102850818></p><p>我们可以将之前写的boolean查询作为<strong>原始查询</strong>条件放到query中，接下来就是添加<strong>过滤条件</strong>、<strong>算分函数</strong>、<strong>加权模式</strong>了。所以原来的代码依然可以沿用。</p><p>修改<code>cn.itcast.hotel.service.impl</code>包下的<code>HotelService</code>类中的<code>buildBasicQuery</code>方法，添加算分函数查询：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>buildBasicQuery</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>,</span> SearchRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.构建BooleanQuery
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BoolQueryBuilder boolQuery <span style=color:#f92672>=</span> QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>boolQuery</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 关键字搜索
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String key <span style=color:#f92672>=</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>key<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchAllQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>must</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>matchQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>,</span> key<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 城市条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;city&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 品牌条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;brand&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 星级条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;starName&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 价格
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinPrice</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxPrice</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        boolQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>QueryBuilders
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>rangeQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;price&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>gte</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinPrice</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                         <span style=color:#f92672>.</span><span style=color:#a6e22e>lte</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxPrice</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.算分控制
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    FunctionScoreQueryBuilder functionScoreQuery <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>functionScoreQuery</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 原始查询，相关性算分的查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        boolQuery<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// function score的数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>new</span> FunctionScoreQueryBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>FilterFunctionBuilder</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 其中的一个function score 元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>new</span> FunctionScoreQueryBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>FilterFunctionBuilder</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 过滤条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                QueryBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>termQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;isAD&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 算分函数，默认相乘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ScoreFunctionBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>weightFactorFunction</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>functionScoreQuery<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时在前端页面就会优先展示广告，这些广告文档的得分会变得更高，并且会打上广告标记</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1>微服务</a>
<a href=/tags/elasticsearch>elasticsearch</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/redis%E9%9D%A2%E7%BB%8F/ rel=next title=Redis面经><i class="fa fa-chevron-left"></i> Redis面经</a></div><div class="post-nav-prev post-nav-item"><a href=/post/875.%E7%88%B1%E5%90%83%E9%A6%99%E8%95%89%E7%9A%84%E7%8F%82%E7%8F%82/ rel=prev title=875.爱吃香蕉的珂珂>875.爱吃香蕉的珂珂
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>zzzi提供技术支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zzzicode.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":null,"views":null},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"right","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0e26367f0461fb41ac6f947dc2af3620375dc44aa8945e6c2b1480d342c65d1.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>