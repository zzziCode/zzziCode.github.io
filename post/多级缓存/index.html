<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.111.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon_next.png><meta itemprop=name content="å¤šçº§ç¼“å­˜"><meta itemprop=description content="å¤šçº§ç¼“å­˜"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zzzicode.github.io/imgs/avatar.png"><meta itemprop=keywords content="å¾®æœåŠ¡,å¤šçº§ç¼“å­˜"><meta property="og:type" content="article"><meta property="og:title" content="å¤šçº§ç¼“å­˜"><meta property="og:description" content="å¤šçº§ç¼“å­˜"><meta property="og:image" content="/imgs/avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zzzicode.github.io/post/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"><meta property="og:site_name" content="zzziçš„å°ç«™"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="zzzi"><meta property="article:published_time" content="2024-03-15 12:32:24 +0800 CST"><meta property="article:modified_time" content="2024-03-15 12:32:24 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4b7f3d9c4ef8db1505229a7dcd2c4e3ab17cd4960dd8a78b503c013770ad56a6.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98","permalink":"https://zzzicode.github.io/post/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/","title":"å¤šçº§ç¼“å­˜"}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>å¤šçº§ç¼“å­˜ - zzziçš„å°ç«™</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>zzziçš„å°ç«™</h1><i class=logo-line></i></a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£
<span class=badge>226</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#21åˆè¯†caffeine>2.1.åˆè¯†Caffeine</a></li><li><a href=#22å®ç°jvmè¿›ç¨‹ç¼“å­˜>2.2.å®ç°JVMè¿›ç¨‹ç¼“å­˜</a><ul><li><a href=#221éœ€æ±‚>2.2.1.éœ€æ±‚</a></li><li><a href=#232å®ç°>2.3.2.å®ç°</a></li></ul></li></ul><ul><li><a href=#31åˆè¯†lua>3.1.åˆè¯†Lua</a></li><li><a href=#31helloworld>3.1.HelloWorld</a></li><li><a href=#32å˜é‡å’Œå¾ªç¯>3.2.å˜é‡å’Œå¾ªç¯</a><ul><li><a href=#321luaçš„æ•°æ®ç±»å‹>3.2.1.Luaçš„æ•°æ®ç±»å‹</a></li><li><a href=#322å£°æ˜å˜é‡>3.2.2.å£°æ˜å˜é‡</a></li><li><a href=#323å¾ªç¯>3.2.3.å¾ªç¯</a></li></ul></li><li><a href=#33æ¡ä»¶æ§åˆ¶å‡½æ•°>3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•°</a><ul><li><a href=#331å‡½æ•°>3.3.1.å‡½æ•°</a></li><li><a href=#332æ¡ä»¶æ§åˆ¶>3.3.2.æ¡ä»¶æ§åˆ¶</a></li><li><a href=#333æ¡ˆä¾‹>3.3.3.æ¡ˆä¾‹</a></li></ul></li></ul><ul><li><a href=#41å®‰è£…openresty>4.1.å®‰è£…OpenResty</a></li><li><a href=#42openrestyå¿«é€Ÿå…¥é—¨>4.2.OpenRestyå¿«é€Ÿå…¥é—¨</a><ul><li><a href=#421åå‘ä»£ç†æµç¨‹>4.2.1.åå‘ä»£ç†æµç¨‹</a></li><li><a href=#422openrestyç›‘å¬è¯·æ±‚>4.2.2.OpenRestyç›‘å¬è¯·æ±‚</a></li><li><a href=#423ç¼–å†™itemlua>4.2.3.ç¼–å†™item.lua</a></li></ul></li><li><a href=#43è¯·æ±‚å‚æ•°å¤„ç†>4.3.è¯·æ±‚å‚æ•°å¤„ç†</a><ul><li><a href=#431è·å–å‚æ•°çš„api>4.3.1.è·å–å‚æ•°çš„API</a></li><li><a href=#432è·å–å‚æ•°å¹¶è¿”å›>4.3.2.è·å–å‚æ•°å¹¶è¿”å›</a></li></ul></li><li><a href=#44æŸ¥è¯¢tomcat>4.4.æŸ¥è¯¢Tomcat</a><ul><li><a href=#441å‘é€httpè¯·æ±‚çš„api>4.4.1.å‘é€httpè¯·æ±‚çš„API</a></li><li><a href=#442å°è£…httpå·¥å…·>4.4.2.å°è£…httpå·¥å…·</a></li><li><a href=#443cjsonå·¥å…·ç±»>4.4.3.CJSONå·¥å…·ç±»</a></li><li><a href=#444å®ç°tomcatæŸ¥è¯¢>4.4.4.å®ç°TomcatæŸ¥è¯¢</a></li><li><a href=#445åŸºäºidè´Ÿè½½å‡è¡¡>4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡</a><ul><li><a href=#1åŸç†>1ï¼‰åŸç†</a></li><li><a href=#2å®ç°>2ï¼‰å®ç°</a></li><li><a href=#3æµ‹è¯•>3ï¼‰æµ‹è¯•</a></li></ul></li></ul></li><li><a href=#45redisç¼“å­˜é¢„çƒ­>4.5.Redisç¼“å­˜é¢„çƒ­</a></li><li><a href=#46æŸ¥è¯¢redisç¼“å­˜>4.6.æŸ¥è¯¢Redisç¼“å­˜</a><ul><li><a href=#461å°è£…rediså·¥å…·>4.6.1.å°è£…Rediså·¥å…·</a></li><li><a href=#462å®ç°redisæŸ¥è¯¢>4.6.2.å®ç°RedisæŸ¥è¯¢</a></li></ul></li><li><a href=#47nginxæœ¬åœ°ç¼“å­˜>4.7.Nginxæœ¬åœ°ç¼“å­˜</a><ul><li><a href=#471æœ¬åœ°ç¼“å­˜api>4.7.1.æœ¬åœ°ç¼“å­˜API</a></li><li><a href=#472å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢>4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢</a></li></ul></li></ul><ul><li><a href=#51æ•°æ®åŒæ­¥ç­–ç•¥>5.1.æ•°æ®åŒæ­¥ç­–ç•¥</a></li><li><a href=#52å®‰è£…canal>5.2.å®‰è£…Canal</a><ul><li><a href=#521è®¤è¯†canal>5.2.1.è®¤è¯†Canal</a></li></ul></li><li><a href=#52ç›‘å¬canal>5.2.ç›‘å¬Canal</a><ul><li><a href=#531å¼•å…¥ä¾èµ–>5.3.1.å¼•å…¥ä¾èµ–ï¼š</a></li><li><a href=#532ç¼–å†™é…ç½®>5.3.2.ç¼–å†™é…ç½®ï¼š</a></li><li><a href=#533ä¿®æ”¹itemå®ä½“ç±»>5.3.3.ä¿®æ”¹Itemå®ä½“ç±»</a></li><li><a href=#534ç¼–å†™ç›‘å¬å™¨>5.3.4.ç¼–å†™ç›‘å¬å™¨</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=zzzi src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.png><p class=site-author-name itemprop=name>zzzi</p><div class=site-description itemprop=description>make_tuple("å·¥ä½œ","è®ºæ–‡")</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>226</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>54</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zzziCode title="Github â†’ https://github.com/zzziCode" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>å‡¡æ¢¦æ˜Ÿå°˜</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zzzicode.github.io/post/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.png"><meta itemprop=name content="zzzi"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="zzzi"><meta itemprop=description content="make_tuple(&#34;å·¥ä½œ&#34;,&#34;è®ºæ–‡&#34;)"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="å¤šçº§ç¼“å­˜"><meta itemprop=description content="å¤šçº§ç¼“å­˜"></span><header class=post-header><h1 class=post-title itemprop="name headline">å¤šçº§ç¼“å­˜</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š</span>
<time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-15 12:32:24 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-03-15 12:32:24 +0800 CST">2024-03-15</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0 itemprop=url rel=index><span itemprop=name>å­¦ä¹ ç¬”è®°</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>16554</span></span>
<span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>34åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>ğŸ™Œ å¤šçº§ç¼“å­˜</p></blockquote><p>æœ¬èŠ‚ä¸­ä»‹ç»ä¸€ç§äº¿çº§æµé‡çš„ç¼“å­˜æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯å¤šçº§ç¼“å­˜ï¼Œå°†è¯·æ±‚åˆ†ä¸ºå¤šç§ç±»å‹ï¼Œç„¶åä¸€æ­¥ä¸€æ­¥çš„è¿›è¡Œç¼“å­˜ï¼Œç»è¿‡å¤šçº§ç¼“å­˜éƒ½æ²¡æ‰¾åˆ°æ•°æ®æœ€ç»ˆæ‰ä¼šåˆ°è¾¾æ•°æ®åº“ä¸­</p><h1 id=1ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜>1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜
<a class=header-anchor href=#1%e4%bb%80%e4%b9%88%e6%98%af%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98></a></h1><p>ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231573.png alt=image-20210821075259137 style=zoom:50%><p>å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><p>â€¢ è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</p><p>â€¢ Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</p><p>å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p><ul><li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼ˆç¬¬ä¸€çº§ç¼“å­˜ï¼‰ï¼Œå› ä¸ºè¿™äº›èµ„æºä¸ä¼šå˜åŒ–ï¼Œæ‰€ä»¥å¯ä»¥ç¼“å­˜åœ¨æµè§ˆå™¨å‡å°è¯·æ±‚æ—¶é—´</li><li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯</li><li>è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜ï¼ˆç¬¬äºŒçº§ç¼“å­˜ï¼‰</li><li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆç¬¬ä¸‰çº§ç¼“å­˜ï¼Œä¸ç»è¿‡Tomcatï¼‰</li><li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat</li><li>è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ï¼ˆç¬¬å››çº§ç¼“å­˜ï¼‰</li><li>å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li></ul><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231579.png alt=image-20210821075558137 style=zoom:50%><p>åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ª<strong>åå‘ä»£ç†æœåŠ¡å™¨</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™<strong>ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†</strong>ã€‚</p><p>å› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰<strong>ä¸“é—¨</strong>çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼ŒNginxé›†ç¾¤ä¸­åªå…³æ³¨å°†è¯·æ±‚äº¤ç»™å“ªä¸ªç¼“å­˜ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231580.png alt=image-20210821080511581 style=zoom:50%><p>å¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231581.png alt=image-20210821080954947 style=zoom:50%><p>å¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š</p><ul><li><p>ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢</p></li><li><p>å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜</p></li></ul><p>å…¶ä¸­Nginxç¼–ç¨‹åˆ™ä¼šç”¨åˆ°OpenRestyæ¡†æ¶ç»“åˆLuaè¿™æ ·çš„è¯­è¨€ã€‚</p><h1 id=2jvmè¿›ç¨‹ç¼“å­˜>2.JVMè¿›ç¨‹ç¼“å­˜
<a class=header-anchor href=#2jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98></a></h1><h2 id=21åˆè¯†caffeine>2.1.åˆè¯†Caffeine
<a class=header-anchor href=#21%e5%88%9d%e8%af%86caffeine></a></h2><p>ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­å¯åŠ¨è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬æŠŠç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>åˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚Redisï¼š<ul><li>ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ã€å¯é æ€§æ›´å¥½ã€å¯ä»¥åœ¨é›†ç¾¤é—´å…±äº«</li><li>ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€</li><li>åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ã€å¯é æ€§è¦æ±‚è¾ƒé«˜ã€éœ€è¦åœ¨é›†ç¾¤é—´å…±äº«</li></ul></li><li>è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚HashMapã€GuavaCacheï¼š<ul><li>ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿«</li><li>ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ã€å¯é æ€§è¾ƒä½ã€æ— æ³•å…±äº«</li><li>åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå°</li></ul></li></ul><p>æˆ‘ä»¬ä»Šå¤©ä¼šåˆ©ç”¨Caffeineæ¡†æ¶æ¥å®ç°JVMè¿›ç¨‹ç¼“å­˜ã€‚</p><p><strong>Caffeine</strong>æ˜¯ä¸€ä¸ªåŸºäºJava8å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹<strong>æœ€ä½³å‘½ä¸­ç‡</strong>çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰Springå†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯Caffeineã€‚GitHubåœ°å€ï¼šhttps://github.com/ben-manes/caffeine</p><p>Caffeineçš„æ€§èƒ½éå¸¸å¥½ï¼Œä¸‹å›¾æ˜¯å®˜æ–¹ç»™å‡ºçš„æ€§èƒ½å¯¹æ¯”ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231583.png alt=image-20210821081826399 style=zoom:50%><p>å¯ä»¥çœ‹åˆ°Caffeineçš„æ€§èƒ½é¥é¥é¢†å…ˆï¼</p><p>ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬<strong>API</strong>ï¼Œç›¸å½“äºè¦ç¼“å­˜ï¼Œå°±ç›´æ¥è°ƒç”¨æ¡†æ¶æä¾›çš„apiï¼Œä»è€Œå°†æ•°æ®ç¼“å­˜åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä¹‹åå¤–éƒ¨è®¿é—®æ“ä½œè¿™ä¸ªå®¹å™¨å°±å¯ä»¥æ“ä½œç¼“å­˜æ•°æ®ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testBasicOps</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ„å»ºcacheå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Cache<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> cache <span style=color:#f92672>=</span> Caffeine<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å­˜æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    cache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gf&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;è¿ªä¸½çƒ­å·´&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å–æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String gf <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>getIfPresent</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gf&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gf = &#34;</span> <span style=color:#f92672>+</span> gf<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å–æ•°æ®ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// å‚æ•°ä¸€ï¼šç¼“å­˜çš„key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// å‚æ•°äºŒï¼šLambdaè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‚æ•°å°±æ˜¯ç¼“å­˜çš„keyï¼Œæ–¹æ³•ä½“æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ä¼˜å…ˆæ ¹æ®keyæŸ¥è¯¢JVMç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‚æ•°äºŒçš„Lambdaè¡¨è¾¾å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String defaultGF <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;defaultGF&#34;</span><span style=color:#f92672>,</span> key <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ ¹æ®keyå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;æŸ³å²©&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;defaultGF = &#34;</span> <span style=color:#f92672>+</span> defaultGF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Caffeineæ—¢ç„¶æ˜¯ç¼“å­˜çš„ä¸€ç§ï¼Œè‚¯å®šéœ€è¦æœ‰ç¼“å­˜çš„<strong>æ¸…é™¤ç­–ç•¥</strong>ï¼Œä¸ç„¶çš„è¯å†…å­˜æ€»ä¼šæœ‰è€—å°½çš„æ—¶å€™ã€‚</p><p>Caffeineæä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š</p><ul><li><p><strong>åŸºäºå®¹é‡</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™ï¼Œæ•°é‡è¶…è¿‡ä¸Šé™å°±åˆ é™¤ç¼“å­˜</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºç¼“å­˜å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Cache<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> cache <span style=color:#f92672>=</span> Caffeine<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>maximumSize</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#75715e>// è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>åŸºäºæ—¶é—´</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´ï¼Œæœ‰æ•ˆæœŸåˆ°äº†å°±åˆ é™¤ç¼“å­˜</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºç¼“å­˜å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Cache<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> cache <span style=color:#f92672>=</span> Caffeine<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>expireAfterWrite</span><span style=color:#f92672>(</span>Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>ofSeconds</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10</span><span style=color:#f92672>))</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>åŸºäºå¼•ç”¨</strong>ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨GCæ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œ<strong>ä¸å»ºè®®ä½¿ç”¨</strong>ã€‚</p></li></ul><blockquote><p><strong>æ³¨æ„</strong>ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeineä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚æ‰€ä»¥è¯´å¦‚æœç¼“å­˜éœ€è¦æ¸…ç†ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠæ¸…ç†ï¼Œè¿™ä¸­é—´çš„è¿‡æœŸæ•°æ®æ˜¯å¯ä»¥è®¿é—®åˆ°çš„</p></blockquote><h2 id=22å®ç°jvmè¿›ç¨‹ç¼“å­˜>2.2.å®ç°JVMè¿›ç¨‹ç¼“å­˜
<a class=header-anchor href=#22%e5%ae%9e%e7%8e%b0jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98></a></h2><h3 id=221éœ€æ±‚>2.2.1.éœ€æ±‚
<a class=header-anchor href=#221%e9%9c%80%e6%b1%82></a></h3><p>åˆ©ç”¨Caffeineå®ç°ä¸‹åˆ—éœ€æ±‚ï¼š</p><ul><li>ç»™æ ¹æ®idæŸ¥è¯¢<strong>å•†å“</strong>çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li><li>ç»™æ ¹æ®idæŸ¥è¯¢<strong>å•†å“åº“å­˜</strong>çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li><li>ç¼“å­˜åˆå§‹å¤§å°ä¸º100</li><li>ç¼“å­˜ä¸Šé™ä¸º10000</li></ul><h3 id=232å®ç°>2.3.2.å®ç°
<a class=header-anchor href=#232%e5%ae%9e%e7%8e%b0></a></h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚</p><p>åœ¨item-serviceçš„<code>com.heima.item.config</code>åŒ…ä¸‹å®šä¹‰<code>CaffeineConfig</code>ç±»ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.heima.item.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.github.benmanes.caffeine.cache.Cache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.github.benmanes.caffeine.cache.Caffeine<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.Item<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.ItemStock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CaffeineConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//å®šä¹‰ä¸€ä¸ªç¼“å­˜å®¹å™¨äº¤ç»™springï¼Œç¼“å­˜å•†å“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Cache<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> Item<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>itemCache</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Caffeine<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>initialCapacity</span><span style=color:#f92672>(</span><span style=color:#ae81ff>100</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>maximumSize</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10_000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è¿™ä¸ªç¼“å­˜å®¹å™¨ç¼“å­˜åº“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Cache<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> ItemStock<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>stockCache</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Caffeine<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>initialCapacity</span><span style=color:#f92672>(</span><span style=color:#ae81ff>100</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>maximumSize</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10_000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åï¼Œä¿®æ”¹item-serviceä¸­çš„<code>com.heima.item.web</code>åŒ…ä¸‹çš„ItemControllerç±»ï¼Œæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;item&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ItemController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemService itemService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemStockService stockService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//å°†ç¼“å­˜å®¹å™¨æ³¨å…¥è¿›æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Cache<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> Item<span style=color:#f92672>&gt;</span> itemCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Cache<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> ItemStock<span style=color:#f92672>&gt;</span> stockCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...å…¶å®ƒç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//å…ˆä»ç¼“å­˜ä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//æ‰¾ä¸åˆ°ä¹‹åï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°idå½“æˆkeyå»æ•°æ®åº“ä¸­æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/{id}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Item <span style=color:#a6e22e>findById</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> itemCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>id<span style=color:#f92672>,</span> key <span style=color:#f92672>-&gt;</span> itemService<span style=color:#f92672>.</span><span style=color:#a6e22e>query</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>ne</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;status&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>).</span><span style=color:#a6e22e>eq</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> key<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>one</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//åº“å­˜ä¹Ÿæ˜¯å…ˆä»ç¼“å­˜ä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/stock/{id}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ItemStock <span style=color:#a6e22e>findStockById</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> stockCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>id<span style=color:#f92672>,</span> key <span style=color:#f92672>-&gt;</span> stockService<span style=color:#f92672>.</span><span style=color:#a6e22e>getById</span><span style=color:#f92672>(</span>key<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ä½¿ç”¨Caffeineæ¥è¿›è¡Œç¼“å­˜ï¼Œä¸»è¦æ˜¯å°†åˆ©ç”¨è¿™ä¸ªæ¡†æ¶å®šä¹‰çš„ç¼“å­˜å®¹å™¨æ³¨å†Œæˆbeanï¼Œä¹‹åéœ€è¦åœ¨å“ªä½¿ç”¨å°±åœ¨å“ªæ³¨å…¥ï¼Œç„¶åä»ç¼“å­˜ä¸­è·å–æƒ³è¦çš„æ•°æ®ï¼Œæ•°æ®æ²¡æœ‰è·å–åˆ°åæ‰åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢</p><p>ç›¸æ¯”äºç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢ï¼Œå‘½ä¸­ç¼“å­˜ä¹‹åçš„æ€§èƒ½æ›´åŠ å¿«ï¼ŒæŸ¥ä¸åˆ°å°±ä¼šæŸ¥è¯¢æ•°æ®åº“ï¼Œä¹‹åå°†æŸ¥è¯¢åˆ°çš„æ•°æ®è‡ªåŠ¨åŠ å…¥ç¼“å­˜ä¸­ï¼Œè¿™äº›éƒ½ç”±Caffeineå®ç°å¥½äº†</p></blockquote><h1 id=3luaè¯­æ³•å…¥é—¨>3.Luaè¯­æ³•å…¥é—¨
<a class=header-anchor href=#3lua%e8%af%ad%e6%b3%95%e5%85%a5%e9%97%a8></a></h1><p>Nginxç¼–ç¨‹éœ€è¦ç”¨åˆ°Luaè¯­è¨€ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å…ˆå…¥é—¨Luaçš„åŸºæœ¬è¯­æ³•ã€‚</p><h2 id=31åˆè¯†lua>3.1.åˆè¯†Lua
<a class=header-anchor href=#31%e5%88%9d%e8%af%86lua></a></h2><p>Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚å®˜ç½‘ï¼šhttps://www.lua.org/</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231584.png alt=image-20210821091437975 style=zoom:50%><p>Luaç»å¸¸åµŒå…¥åˆ°Cè¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œä¾‹å¦‚æ¸¸æˆå¼€å‘ã€æ¸¸æˆæ’ä»¶ç­‰ã€‚</p><p>Nginxæœ¬èº«ä¹Ÿæ˜¯Cè¯­è¨€å¼€å‘ï¼Œå› æ­¤ä¹Ÿå…è®¸åŸºäºLuaåšæ‹“å±•ã€‚</p><h2 id=31helloworld>3.1.HelloWorld
<a class=header-anchor href=#31helloworld></a></h2><p>CentOS7é»˜è®¤å·²ç»å®‰è£…äº†Luaè¯­è¨€ç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿è¡ŒLuaä»£ç ã€‚</p><p>1ï¼‰åœ¨Linuxè™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªhello.luaæ–‡ä»¶</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231585.png alt=image-20210821091621308></p><p>2ï¼‰æ·»åŠ ä¸‹é¢çš„å†…å®¹</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Hello World!&#34;</span>)  
</span></span></code></pre></td></tr></table></div></div><p>3ï¼‰è¿è¡Œ</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231586.png alt=image-20210821091638140></p><h2 id=32å˜é‡å’Œå¾ªç¯>3.2.å˜é‡å’Œå¾ªç¯
<a class=header-anchor href=#32%e5%8f%98%e9%87%8f%e5%92%8c%e5%be%aa%e7%8e%af></a></h2><p>å­¦ä¹ ä»»ä½•è¯­è¨€å¿…ç„¶ç¦»ä¸å¼€å˜é‡ï¼Œè€Œå˜é‡çš„å£°æ˜å¿…é¡»å…ˆçŸ¥é“æ•°æ®çš„ç±»å‹ã€‚</p><h3 id=321luaçš„æ•°æ®ç±»å‹>3.2.1.Luaçš„æ•°æ®ç±»å‹
<a class=header-anchor href=#321lua%e7%9a%84%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b></a></h3><p>Luaä¸­æ”¯æŒçš„å¸¸è§æ•°æ®ç±»å‹åŒ…æ‹¬ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231588.png alt=image-20210821091835406></p><p>å¦å¤–ï¼ŒLuaæä¾›äº†<strong>type()å‡½æ•°</strong>æ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„æ•°æ®ç±»å‹ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231589.png alt=image-20210821091904332></p><h3 id=322å£°æ˜å˜é‡>3.2.2.å£°æ˜å˜é‡
<a class=header-anchor href=#322%e5%a3%b0%e6%98%8e%e5%8f%98%e9%87%8f></a></h3><p>Luaå£°æ˜å˜é‡çš„æ—¶å€™<strong>æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹</strong>ï¼Œè€Œæ˜¯ç”¨localæ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œ</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å­—ç¬¦ä¸²æ‹¼æ¥å¯ä»¥ä½¿ç”¨ ..</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> str2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;hello&#39;</span> <span style=color:#f92672>..</span> <span style=color:#e6db74>&#39;world&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜æ•°å­—</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> num <span style=color:#f92672>=</span> <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜å¸ƒå°”ç±»å‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> flag <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Luaä¸­çš„tableç±»å‹æ—¢å¯ä»¥ä½œä¸ºæ•°ç»„ï¼Œåˆå¯ä»¥ä½œä¸ºJavaä¸­çš„mapæ¥ä½¿ç”¨ã€‚æ•°ç»„å°±æ˜¯ç‰¹æ®Šçš„tableï¼Œkeyæ˜¯æ•°ç»„è§’æ ‡è€Œå·²ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜æ•°ç»„ ï¼Œkeyä¸ºè§’æ ‡çš„ table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> arr <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;java&#39;</span>, <span style=color:#e6db74>&#39;python&#39;</span>, <span style=color:#e6db74>&#39;lua&#39;</span>}
</span></span><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜tableï¼Œç±»ä¼¼javaçš„map</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> map <span style=color:#f92672>=</span>  {name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Jack&#39;</span>, age<span style=color:#f92672>=</span><span style=color:#ae81ff>21</span>}
</span></span></code></pre></td></tr></table></div></div><p>Luaä¸­çš„æ•°ç»„è§’æ ‡æ˜¯ä»1å¼€å§‹ï¼Œè®¿é—®çš„æ—¶å€™ä¸Javaä¸­ç±»ä¼¼ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- è®¿é—®æ•°ç»„ï¼Œluaæ•°ç»„çš„è§’æ ‡ä»1å¼€å§‹</span>
</span></span><span style=display:flex><span>print(arr[<span style=color:#ae81ff>1</span>])
</span></span></code></pre></td></tr></table></div></div><p>Luaä¸­çš„tableå¯ä»¥ç”¨keyæ¥è®¿é—®ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- è®¿é—®table</span>
</span></span><span style=display:flex><span>print(map[<span style=color:#e6db74>&#39;name&#39;</span>])
</span></span><span style=display:flex><span>print(map.name)
</span></span></code></pre></td></tr></table></div></div><h3 id=323å¾ªç¯>3.2.3.å¾ªç¯
<a class=header-anchor href=#323%e5%be%aa%e7%8e%af></a></h3><p>å¯¹äºtableï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥éå†ã€‚ä¸è¿‡æ•°ç»„å’Œæ™®é€štableéå†ç•¥æœ‰å·®å¼‚ã€‚</p><p>éå†æ•°ç»„ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜æ•°ç»„ keyä¸ºç´¢å¼•çš„ table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> arr <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;java&#39;</span>, <span style=color:#e6db74>&#39;python&#39;</span>, <span style=color:#e6db74>&#39;lua&#39;</span>}
</span></span><span style=display:flex><span><span style=color:#75715e>-- éå†æ•°ç»„</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> index,value <span style=color:#66d9ef>in</span> ipairs(arr) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    print(index, value) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>éå†æ™®é€štable</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å£°æ˜mapï¼Œä¹Ÿå°±æ˜¯table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> map <span style=color:#f92672>=</span> {name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Jack&#39;</span>, age<span style=color:#f92672>=</span><span style=color:#ae81ff>21</span>}
</span></span><span style=display:flex><span><span style=color:#75715e>-- éå†table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> key,value <span style=color:#66d9ef>in</span> pairs(map) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>   print(key, value) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>éå†æ•°ç»„ä½¿ç”¨çš„å‡½æ•°æ˜¯ipairsï¼Œè€Œæ™®é€šçš„tableæ˜¯pairs</p></blockquote><h2 id=33æ¡ä»¶æ§åˆ¶å‡½æ•°>3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•°
<a class=header-anchor href=#33%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6%e5%87%bd%e6%95%b0></a></h2><p>Luaä¸­çš„æ¡ä»¶æ§åˆ¶å’Œå‡½æ•°å£°æ˜ä¸Javaç±»ä¼¼ã€‚</p><h3 id=331å‡½æ•°>3.3.1.å‡½æ•°
<a class=header-anchor href=#331%e5%87%bd%e6%95%b0></a></h3><p>å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#960050;background-color:#1e0010>å‡½æ•°å</span>( argument1, argument2..., argumentn)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- å‡½æ•°ä½“</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#960050;background-color:#1e0010>è¿”å›å€¼</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼Œåªè¦ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œå°±å¯ä»¥å®Œæˆæ‰“å°ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>printArr</span>(arr)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> index, value <span style=color:#66d9ef>in</span> ipairs(arr) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        print(value)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=332æ¡ä»¶æ§åˆ¶>3.3.2.æ¡ä»¶æ§åˆ¶
<a class=header-anchor href=#332%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6></a></h3><p>ç±»ä¼¼Javaçš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ifã€elseè¯­æ³•ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#960050;background-color:#1e0010>å¸ƒå°”è¡¨è¾¾å¼</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸javaä¸åŒï¼Œå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„é€»è¾‘è¿ç®—æ˜¯åŸºäºè‹±æ–‡å•è¯ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231590.png alt=image-20210821092657918></p><h3 id=333æ¡ˆä¾‹>3.3.3.æ¡ˆä¾‹
<a class=header-anchor href=#333%e6%a1%88%e4%be%8b></a></h3><p>éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ‰“å°tableï¼Œå½“å‚æ•°ä¸ºnilæ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>printArr</span>(arr)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>not</span> arr) <span style=color:#66d9ef>then</span> <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>è¿™é‡Œç›¸å½“äºæ•°ç»„ä¸ºç©ºå°±ç¬¦åˆæ¡ä»¶</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> index, value <span style=color:#66d9ef>in</span> ipairs(arr) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        print(value)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=4å®ç°å¤šçº§ç¼“å­˜>4.å®ç°å¤šçº§ç¼“å­˜
<a class=header-anchor href=#4%e5%ae%9e%e7%8e%b0%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98></a></h1><p>å¤šçº§ç¼“å­˜çš„å®ç°ç¦»ä¸å¼€Nginxç¼–ç¨‹ï¼Œè€ŒNginxç¼–ç¨‹åˆç¦»ä¸å¼€OpenRestyã€‚</p><h2 id=41å®‰è£…openresty>4.1.å®‰è£…OpenResty
<a class=header-anchor href=#41%e5%ae%89%e8%a3%85openresty></a></h2><p>OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginxçš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><ul><li>å…·å¤‡Nginxçš„å®Œæ•´åŠŸèƒ½</li><li>åŸºäºLuaè¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—</li><li>å…è®¸ä½¿ç”¨Lua<strong>è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘</strong>ã€<strong>è‡ªå®šä¹‰åº“</strong></li></ul><p>å®˜æ–¹ç½‘ç«™ï¼š
<a href=https://openresty.org/cn/ title=https://openresty.org/cn/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://openresty.org/cn/
<i class="fa fa-external-link-alt"></i></a></p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231591.png alt=image-20210821092902946></p><p>å®‰è£…å®Œæ¯•ä¹‹åå°±å¯ä»¥ä½¿ç”¨ç›¸åº”çš„åŠŸèƒ½ï¼Œå†…éƒ¨å°è£…äº†ä¸€ä¸ªå®Œæ•´çš„nginxï¼Œç›¸å½“äºåŠŸèƒ½æ›´å¼ºå¤§ï¼Œåœ¨nginxä¸Šæ–°å¢äº†ä¸€å¤§å †çš„æ’ä»¶ï¼ŒåæœŸä½¿ç”¨luaç¼–å†™è„šæœ¬ï¼Œå®ç°å¤šçº§ç¼“å­˜</p><h2 id=42openrestyå¿«é€Ÿå…¥é—¨>4.2.OpenRestyå¿«é€Ÿå…¥é—¨
<a class=header-anchor href=#42openresty%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8></a></h2><p>æˆ‘ä»¬å¸Œæœ›è¾¾åˆ°çš„å¤šçº§ç¼“å­˜æ¶æ„å¦‚å›¾ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231593.png alt=yeVDlwtfMx></p><p>å…¶ä¸­ï¼š</p><ul><li><p>windowsä¸Šçš„nginxç”¨æ¥åšåå‘ä»£ç†æœåŠ¡ï¼Œå°†å‰ç«¯çš„æŸ¥è¯¢å•†å“çš„ajaxè¯·æ±‚ä»£ç†åˆ°OpenRestyé›†ç¾¤</p></li><li><p>OpenRestyé›†ç¾¤ç”¨æ¥ç¼–å†™å¤šçº§ç¼“å­˜ä¸šåŠ¡ï¼Œç¼“å­˜ä¸€å…±æœ‰å››çº§</p></li></ul><h3 id=421åå‘ä»£ç†æµç¨‹>4.2.1.åå‘ä»£ç†æµç¨‹
<a class=header-anchor href=#421%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e6%b5%81%e7%a8%8b></a></h3><p>ç°åœ¨ï¼Œå•†å“è¯¦æƒ…é¡µä½¿ç”¨çš„æ˜¯å‡çš„å•†å“æ•°æ®ã€‚ä¸è¿‡åœ¨æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢æœ‰å‘èµ·ajaxè¯·æ±‚æŸ¥è¯¢çœŸå®å•†å“æ•°æ®ã€‚</p><p>è¿™ä¸ªè¯·æ±‚å¦‚ä¸‹ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231594.png alt=image-20210821093144700></p><p>è¯·æ±‚åœ°å€æ˜¯localhostï¼Œç«¯å£æ˜¯80ï¼Œå°±è¢«windowsä¸Šå®‰è£…çš„NginxæœåŠ¡ç»™æ¥æ”¶åˆ°äº†ã€‚ç„¶åä»£ç†ç»™äº†<strong>OpenRestyé›†ç¾¤</strong>ï¼Œç›¸å½“äºæœ€ç»ˆçš„è¯·æ±‚åˆ°è¾¾äº†OpenRestyé›†ç¾¤ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231595.png alt=image-20210821094447709></p><p>æˆ‘ä»¬éœ€è¦åœ¨OpenRestyä¸­ç¼–å†™ä¸šåŠ¡ï¼ŒæŸ¥è¯¢å•†å“æ•°æ®å¹¶è¿”å›åˆ°æµè§ˆå™¨ã€‚</p><p>ä½†æ˜¯è¿™æ¬¡ï¼Œæˆ‘ä»¬å…ˆåœ¨OpenRestyæ¥æ”¶è¯·æ±‚ï¼Œè¿”å›<strong>å‡çš„å•†å“æ•°æ®</strong>ã€‚</p><h3 id=422openrestyç›‘å¬è¯·æ±‚>4.2.2.OpenRestyç›‘å¬è¯·æ±‚
<a class=header-anchor href=#422openresty%e7%9b%91%e5%90%ac%e8%af%b7%e6%b1%82></a></h3><p>OpenRestyçš„å¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå…¶ç›®å½•ä¸‹çš„Luaåº“ï¼Œéœ€è¦åœ¨nginx.confä¸­æŒ‡å®šä¾èµ–åº“çš„ç›®å½•ï¼Œå¹¶å¯¼å…¥ä¾èµ–ï¼š</p><p>1ï¼‰æ·»åŠ å¯¹OpenRestyçš„Luaæ¨¡å—çš„åŠ è½½</p><p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­çš„httpä¸‹é¢ï¼Œæ·»åŠ ä¸‹é¢ä»£ç ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e>#lua æ¨¡å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>lua_package_path</span> <span style=color:#e6db74>&#34;/usr/local/openresty/lualib/?.lua</span>;;<span style=color:#66d9ef>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#cæ¨¡å—     
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>lua_package_cpath</span> <span style=color:#e6db74>&#34;/usr/local/openresty/lualib/?.so</span>;;<span style=color:#66d9ef>&#34;</span>;  
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰ç›‘å¬/api/itemè·¯å¾„</p><p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨nginx.confçš„serverä¸‹é¢ï¼Œæ·»åŠ å¯¹/api/itemè¿™ä¸ªè·¯å¾„çš„ç›‘å¬ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span>  <span style=color:#e6db74>/api/item</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># é»˜è®¤çš„å“åº”ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>default_type</span> <span style=color:#e6db74>application/json</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>content_by_lua_file</span> <span style=color:#e6db74>lua/item.lua</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªç›‘å¬ï¼Œå°±ç±»ä¼¼äºSpringMVCä¸­çš„<code>@GetMapping("/api/item")</code>åšè·¯å¾„æ˜ å°„ã€‚</p><p>è€Œ<code>content_by_lua_file lua/item.lua</code>åˆ™ç›¸å½“äºè°ƒç”¨item.luaè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸šåŠ¡ï¼ŒæŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºjavaä¸­è°ƒç”¨serviceã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯è¯´æ‹¦æˆªåˆ°å‰ç«¯ä¼ é€’è€Œæ¥çš„/api/itemè¯·æ±‚ä¹‹åï¼Œä¼šæ‰§è¡Œitem.luaä¸­çš„é€»è¾‘ï¼Œç„¶åå°†å¾—åˆ°çš„ç»“æœä»¥jsonæ ¼å¼è¿”å›</p></blockquote><h3 id=423ç¼–å†™itemlua>4.2.3.ç¼–å†™item.lua
<a class=header-anchor href=#423%e7%bc%96%e5%86%99itemlua></a></h3><p>1ï¼‰åœ¨<code>/usr/loca/openresty/nginx</code>ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ï¼šlua</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231596.png alt=image-20210821100755080></p><p>2ï¼‰åœ¨<code>/usr/loca/openresty/nginx/lua</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶ï¼šitem.lua</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231597.png alt=image-20210821100801756></p><p>3ï¼‰ç¼–å†™item.luaï¼Œè¿”å›å‡æ•°æ®</p><p>item.luaä¸­ï¼Œåˆ©ç”¨ngx.say()å‡½æ•°è¿”å›æ•°æ®ï¼Œç›¸å½“äºå†…éƒ¨æŸ¥è¯¢åˆ°äº†æ•°æ®ï¼Œä»¥jsonæ ¼å¼è¿”å›åˆ°å‰ç«¯</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span>ngx.say(<span style=color:#e6db74>&#39;{&#34;id&#34;:10001,&#34;name&#34;:&#34;SALSA AIR&#34;,&#34;title&#34;:&#34;RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4&#34;,&#34;price&#34;:17900,&#34;image&#34;:&#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&#34;,&#34;category&#34;:&#34;æ‹‰æ†ç®±&#34;,&#34;brand&#34;:&#34;RIMOWA&#34;,&#34;spec&#34;:&#34;&#34;,&#34;status&#34;:1,&#34;createTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;updateTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;stock&#34;:2999,&#34;sold&#34;:31290}&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>4ï¼‰é‡æ–°åŠ è½½é…ç½®ï¼Œç›¸å½“äºé…ç½®å¥½äº†å°±<strong>åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶</strong>ï¼Œè€Œä¸€ç³»åˆ—çš„éœ€æ±‚éƒ½æ˜¯é€šè¿‡nginxä¸­çš„é…ç½®æ–‡ä»¶æ¥ç¼–å†™çš„ï¼Œä¹‹åå°±å¯ä»¥å®Œæˆè¯·æ±‚çš„å¤„ç†</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>nginx -s reload
</span></span></code></pre></td></tr></table></div></div><p>åˆ·æ–°å•†å“é¡µé¢ï¼šhttp://localhost/item.html?id=1001ï¼Œå³å¯çœ‹åˆ°æ•ˆæœï¼Œè¯·æ±‚è¢«åç«¯çš„OpenRestyæ‹¦æˆªåˆ°ï¼Œç„¶åå‡ºå‘luaè„šæœ¬ä¸­çš„å‡½æ•°ï¼Œè¿”å›äº†ä¸€ä¸ªæ•°æ®ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231598.png alt=image-20210821101217089 style=zoom:50%><h2 id=43è¯·æ±‚å‚æ•°å¤„ç†>4.3.è¯·æ±‚å‚æ•°å¤„ç†
<a class=header-anchor href=#43%e8%af%b7%e6%b1%82%e5%8f%82%e6%95%b0%e5%a4%84%e7%90%86></a></h2><p>ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨OpenRestyæ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯å‡æ•°æ®ã€‚</p><p>è¦è¿”å›çœŸå®æ•°æ®ï¼Œå¿…é¡»æ ¹æ®å‰ç«¯ä¼ é€’æ¥çš„å•†å“idï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯æ‰å¯ä»¥ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è·å–å‰ç«¯ä¼ é€’çš„å•†å“å‚æ•°å‘¢ï¼Ÿ</p><h3 id=431è·å–å‚æ•°çš„api>4.3.1.è·å–å‚æ•°çš„API
<a class=header-anchor href=#431%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e7%9a%84api></a></h3><p>OpenRestyä¸­æä¾›äº†ä¸€äº›APIç”¨æ¥è·å–ä¸åŒç±»å‹çš„å‰ç«¯è¯·æ±‚å‚æ•°ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231599.png alt=image-20210821101433528></p><h3 id=432è·å–å‚æ•°å¹¶è¿”å›>4.3.2.è·å–å‚æ•°å¹¶è¿”å›
<a class=header-anchor href=#432%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e5%b9%b6%e8%bf%94%e5%9b%9e></a></h3><p>åœ¨å‰ç«¯å‘èµ·çš„ajaxè¯·æ±‚å¦‚å›¾ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231600.png alt=image-20210821101721649></p><p>å¯ä»¥çœ‹åˆ°å•†å“idæ˜¯ä»¥è·¯å¾„å ä½ç¬¦æ–¹å¼ä¼ é€’çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ–¹å¼æ¥è·å–ID</p><p>1ï¼‰è·å–å•†å“id</p><p>ä¿®æ”¹<code>/usr/loca/openresty/nginx/nginx.conf</code>æ–‡ä»¶ä¸­ç›‘å¬/api/itemçš„ä»£ç ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è·å–IDï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># åœ¨è¿™é‡Œè·å–/api/itemä¸­çš„è·¯å¾„å‚æ•°ä¿å­˜åˆ°varè¡¨æ ¼ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> ~ <span style=color:#e6db74>/api/item/(\d+)</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># é»˜è®¤çš„å“åº”ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>default_type</span> <span style=color:#e6db74>application/json</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>content_by_lua_file</span> <span style=color:#e6db74>lua/item.lua</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰æ‹¼æ¥IDå¹¶è¿”å›</p><p>ä¿®æ”¹<code>/usr/loca/openresty/nginx/lua/item.lua</code>æ–‡ä»¶ï¼Œè·å–idå¹¶æ‹¼æ¥åˆ°ç»“æœä¸­è¿”å›ï¼Œç›¸å½“äºå‰ç«¯ä¼ é€’ä»€ä¹ˆidï¼Œåç«¯å°±èƒ½è§£æåˆ°ä»€ä¹ˆidï¼ŒåæœŸä½¿ç”¨idæ¥å®ç°ä¸šåŠ¡å³å¯ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- è·å–å•†å“id</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> id <span style=color:#f92672>=</span> ngx.var[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#75715e>-- æ‹¼æ¥å¹¶è¿”å›</span>
</span></span><span style=display:flex><span>ngx.say(<span style=color:#e6db74>&#39;{&#34;id&#34;:&#39;</span> <span style=color:#f92672>..</span> id <span style=color:#f92672>..</span> <span style=color:#e6db74>&#39;,&#34;name&#34;:&#34;SALSA AIR&#34;,&#34;title&#34;:&#34;RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4&#34;,&#34;price&#34;:17900,&#34;image&#34;:&#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&#34;,&#34;category&#34;:&#34;æ‹‰æ†ç®±&#34;,&#34;brand&#34;:&#34;RIMOWA&#34;,&#34;spec&#34;:&#34;&#34;,&#34;status&#34;:1,&#34;createTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;updateTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;stock&#34;:2999,&#34;sold&#34;:31290}&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>3ï¼‰é‡æ–°åŠ è½½å¹¶æµ‹è¯•</p><p>è¿è¡Œå‘½ä»¤ä»¥é‡æ–°åŠ è½½OpenRestyé…ç½®ï¼Œä¹Ÿå°±æ˜¯nginxä¸­çš„é…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>nginx -s reload
</span></span></code></pre></td></tr></table></div></div><p>åˆ·æ–°é¡µé¢å¯ä»¥çœ‹åˆ°ç»“æœä¸­å·²ç»å¸¦ä¸Šäº†IDï¼Œå¹¶ä¸”å‰ç«¯ä¼ é€’ä»€ä¹ˆidï¼Œåç«¯å°±èƒ½è§£æå¹¶è¿”å›ä»€ä¹ˆidï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231601.png alt=image-20210821102235467></p><h2 id=44æŸ¥è¯¢tomcat>4.4.æŸ¥è¯¢Tomcat
<a class=header-anchor href=#44%e6%9f%a5%e8%af%a2tomcat></a></h2><blockquote><p>å¦‚ä½•æ ¹æ®æ‹¿åˆ°çš„å‚æ•°æŸ¥è¯¢Tomcatï¼Œä¹Ÿå°±æ˜¯å°†è¯·æ±‚æœ€ç»ˆè·¯ç”±åˆ°åç«¯javaä»£ç ä¸­</p></blockquote><p>æ‹¿åˆ°å•†å“IDåï¼Œæœ¬åº”å»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æœªå»ºç«‹nginxã€redisç¼“å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ ¹æ®å•†å“idå»tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯ã€‚æˆ‘ä»¬å®ç°å¦‚å›¾éƒ¨åˆ†ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231602.png alt=image-20210821102610167></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„OpenRestyæ˜¯åœ¨è™šæ‹Ÿæœºï¼ŒTomcatæ˜¯åœ¨Windowsç”µè„‘ä¸Šã€‚ä¸¤è€…IPä¸€å®šä¸è¦æé”™äº†ã€‚</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231603.png alt=image-20210821102959829 style=zoom:50%><h3 id=441å‘é€httpè¯·æ±‚çš„api>4.4.1.å‘é€httpè¯·æ±‚çš„API
<a class=header-anchor href=#441%e5%8f%91%e9%80%81http%e8%af%b7%e6%b1%82%e7%9a%84api></a></h3><p>nginxæä¾›äº†å†…éƒ¨APIç”¨ä»¥å‘é€httpè¯·æ±‚ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> resp <span style=color:#f92672>=</span> ngx.location.capture(<span style=color:#e6db74>&#34;/path&#34;</span>,{
</span></span><span style=display:flex><span>    method <span style=color:#f92672>=</span> ngx.HTTP_GET,   <span style=color:#75715e>-- è¯·æ±‚æ–¹å¼</span>
</span></span><span style=display:flex><span>    args <span style=color:#f92672>=</span> {a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>},  <span style=color:#75715e>-- getæ–¹å¼ä¼ å‚æ•°</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><p>è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š</p><ul><li>resp.statusï¼šå“åº”çŠ¶æ€ç </li><li>resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ªtable</li><li>resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ®</li></ul><p>æ³¨æ„ï¼šè¿™é‡Œçš„pathæ˜¯è·¯å¾„ï¼Œå¹¶ä¸åŒ…å«IPå’Œç«¯å£ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè¢«nginxå†…éƒ¨çš„serverç›‘å¬å¹¶å¤„ç†ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè¯·æ±‚å‘é€åˆ°TomcatæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªserveræ¥å¯¹è¿™ä¸ªè·¯å¾„åšåå‘ä»£ç†ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span> <span style=color:#66d9ef>location</span> <span style=color:#e6db74>/path</span> {
</span></span><span style=display:flex><span>     <span style=color:#75715e># è¿™é‡Œæ˜¯windowsç”µè„‘çš„ipå’ŒJavaæœåŠ¡ç«¯å£ï¼Œéœ€è¦ç¡®ä¿windowsé˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://192.168.150.1:8081</span>; 
</span></span><span style=display:flex><span> }
</span></span></code></pre></td></tr></table></div></div><p>åŸç†å¦‚å›¾ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231604.png alt=image-20210821104149061></p><p>ä¹Ÿå°±æ˜¯å‰ç«¯è¯·æ±‚åˆ°è¾¾Nginxåå‘ä»£ç†åˆ°äº†OpenRestyä¸­ï¼Œç„¶ååœ¨OpenRestyä¸­å‘é€ä¸€ä¸ªå‘åç«¯çš„è¯·æ±‚ï¼Œè¯·æ±‚ä¼šè¢«nginxæ‹¦æˆªï¼Œç»§ç»­åå‘ä»£ç†åˆ°åç«¯ï¼Œç›¸å½“äºè¿›è¡Œäº†ä¸¤æ¬¡åå‘ä»£ç†</p><h3 id=442å°è£…httpå·¥å…·>4.4.2.å°è£…httpå·¥å…·
<a class=header-anchor href=#442%e5%b0%81%e8%a3%85http%e5%b7%a5%e5%85%b7></a></h3><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªå‘é€Httpè¯·æ±‚çš„å·¥å…·ï¼ŒåŸºäºngx.location.captureæ¥å®ç°æŸ¥è¯¢tomcatã€‚</p><p>1ï¼‰æ·»åŠ åå‘ä»£ç†ï¼Œåˆ°windowsçš„JavaæœåŠ¡</p><p>å› ä¸ºitem-serviceä¸­çš„æ¥å£éƒ½æ˜¯/itemå¼€å¤´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›‘å¬/itemè·¯å¾„ï¼Œä»£ç†åˆ°windowsä¸Šçš„tomcatæœåŠ¡ã€‚</p><p>ä¿®æ”¹ <code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªlocationï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/item</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://192.168.150.1:8081</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ä»¥åï¼Œåªè¦æˆ‘ä»¬è°ƒç”¨<code>ngx.location.capture("/item")</code>ï¼Œå°±ä¸€å®šèƒ½å‘é€è¯·æ±‚åˆ°windowsçš„tomcatæœåŠ¡ã€‚è¿™ä¸€æ­¥å°±æ˜¯åšäº†ä¸€ä¸ªåå‘ä»£ç†</p><p>2ï¼‰å°è£…å·¥å…·ç±»</p><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒOpenRestyå¯åŠ¨æ—¶ä¼šåŠ è½½ä»¥ä¸‹ä¸¤ä¸ªç›®å½•ä¸­çš„å·¥å…·æ–‡ä»¶ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231605.png alt=image-20210821104857413></p><p>æ‰€ä»¥ï¼Œè‡ªå®šä¹‰çš„httpå·¥å…·ä¹Ÿéœ€è¦æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚</p><p>åœ¨<code>/usr/local/openresty/lualib</code>ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ª<code>common.lua</code>æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ç¼–å†™å‘è¯·æ±‚çš„å‡½æ•°é€»è¾‘ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>vi /usr/local/openresty/lualib/common.lua
</span></span></code></pre></td></tr></table></div></div><p>å†…å®¹å¦‚ä¸‹:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_http</span>(path, params)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> resp <span style=color:#f92672>=</span> ngx.location.capture(path,{
</span></span><span style=display:flex><span>        method <span style=color:#f92672>=</span> ngx.HTTP_GET,
</span></span><span style=display:flex><span>        args <span style=color:#f92672>=</span> params,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- å‡ºé”™è®°å½•ä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> resp <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;httpè¯·æ±‚æŸ¥è¯¢å¤±è´¥, path: &#34;</span>, path , <span style=color:#e6db74>&#34;, args: &#34;</span>, args)
</span></span><span style=display:flex><span>        ngx.exit(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp.body
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {  
</span></span><span style=display:flex><span>    read_http <span style=color:#f92672>=</span> read_http
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> _M
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå·¥å…·å°†read_httpå‡½æ•°å°è£…åˆ°_Mè¿™ä¸ªtableç±»å‹çš„å˜é‡ä¸­ï¼Œå¹¶ä¸”è¿”å›ï¼Œè¿™ç±»ä¼¼äºå¯¼å‡ºã€‚</p><p>ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨<code>require('common')</code>æ¥å¯¼å…¥è¯¥å‡½æ•°åº“ï¼Œè¿™é‡Œçš„commonæ˜¯å‡½æ•°åº“çš„æ–‡ä»¶åã€‚</p><p>3ï¼‰å®ç°å•†å“æŸ¥è¯¢</p><p>æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œåˆ©ç”¨åˆšåˆšå°è£…çš„å‡½æ•°åº“å®ç°å¯¹tomcatçš„æŸ¥è¯¢ï¼Œ<strong>å‰æ</strong>æ˜¯å°†å¯¹åº”è·¯å¾„çš„è¯·æ±‚æ‹¦æˆªï¼Œäº¤ç»™luaè„šæœ¬å¤„ç†ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¼•å…¥è‡ªå®šä¹‰commonå·¥å…·æ¨¡å—ï¼Œè¿”å›å€¼æ˜¯commonä¸­è¿”å›çš„ _M</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> common <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;common&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- ä» commonä¸­è·å–read_httpè¿™ä¸ªå‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_http <span style=color:#f92672>=</span> common.read_http
</span></span><span style=display:flex><span><span style=color:#75715e>-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> id <span style=color:#f92672>=</span> ngx.var[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#75715e>-- æ ¹æ®idæŸ¥è¯¢å•†å“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemJSON <span style=color:#f92672>=</span> read_http(<span style=color:#e6db74>&#34;/item/&#34;</span><span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemStockJSON <span style=color:#f92672>=</span> read_http(<span style=color:#e6db74>&#34;/item/stock/&#34;</span><span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å°†itemæ›¿æ¢æˆjavaåç«¯çš„ipå’Œç«¯å£</p></blockquote><p>è¿™é‡ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯jsonå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åŒ…å«å•†å“ã€åº“å­˜ä¸¤ä¸ªjsonå­—ç¬¦ä¸²ï¼Œé¡µé¢æœ€ç»ˆéœ€è¦çš„æ˜¯æŠŠä¸¤ä¸ªjsonæ‹¼æ¥ä¸ºä¸€ä¸ªjsonï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231606.png alt=image-20210821110441222 style=zoom:50%><p>è¿™å°±éœ€è¦æˆ‘ä»¬å…ˆæŠŠJSONå˜ä¸ºluaçš„tableï¼Œå®Œæˆæ•°æ®æ•´åˆåï¼Œå†è½¬ä¸ºJSONã€‚</p><h3 id=443cjsonå·¥å…·ç±»>4.4.3.CJSONå·¥å…·ç±»
<a class=header-anchor href=#443cjson%e5%b7%a5%e5%85%b7%e7%b1%bb></a></h3><p>OpenRestyæä¾›äº†ä¸€ä¸ªcjsonçš„æ¨¡å—ç”¨æ¥å¤„ç†JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚å¯ä»¥å°†jsonè½¬æ¢æˆtableï¼Œä¹Ÿå¯ä»¥å°†tableè½¬æ¢æˆjson</p><p>å®˜æ–¹åœ°å€ï¼š
<a href=https://github.com/openresty/lua-cjson/ title=https://github.com/openresty/lua-cjson/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/openresty/lua-cjson/
<i class="fa fa-external-link-alt"></i></a></p><p>1ï¼‰å¼•å…¥cjsonæ¨¡å—ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> cjson <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;cjson&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰åºåˆ—åŒ–ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> obj <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;jack&#39;</span>,
</span></span><span style=display:flex><span>    age <span style=color:#f92672>=</span> <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŠŠ table åºåˆ—åŒ–ä¸º json</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> json <span style=color:#f92672>=</span> cjson.encode(obj)
</span></span></code></pre></td></tr></table></div></div><p>3ï¼‰ååºåˆ—åŒ–ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> json <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{&#34;name&#34;: &#34;jack&#34;, &#34;age&#34;: 21}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ååºåˆ—åŒ– jsonä¸º table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> obj <span style=color:#f92672>=</span> cjson.decode(json);
</span></span><span style=display:flex><span>print(obj.name)
</span></span></code></pre></td></tr></table></div></div><h3 id=444å®ç°tomcatæŸ¥è¯¢>4.4.4.å®ç°TomcatæŸ¥è¯¢
<a class=header-anchor href=#444%e5%ae%9e%e7%8e%b0tomcat%e6%9f%a5%e8%af%a2></a></h3><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„item.luaä¸­çš„ä¸šåŠ¡ï¼Œæ·»åŠ jsonå¤„ç†åŠŸèƒ½ï¼Œä¹‹åé‡æ–°åŠ è½½nginxçš„é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥å®Œæˆå¯¹åç«¯çš„è¯·æ±‚ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> common <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;common&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_http <span style=color:#f92672>=</span> common.read_http
</span></span><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥cjsonåº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> cjson <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;cjson&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> id <span style=color:#f92672>=</span> ngx.var[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#75715e>-- æ ¹æ®idæŸ¥è¯¢å•†å“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemJSON <span style=color:#f92672>=</span> read_http(<span style=color:#e6db74>&#34;/item/&#34;</span><span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemStockJSON <span style=color:#f92672>=</span> read_http(<span style=color:#e6db74>&#34;/item/stock/&#34;</span><span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- JSONè½¬åŒ–ä¸ºluaçš„tableï¼Œä¾¿äºåæœŸæ‹¼æ¥æ•°æ®</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item <span style=color:#f92672>=</span> cjson.decode(itemJSON)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stock <span style=color:#f92672>=</span> cjson.decode(stockJSON)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ç»„åˆæ•°æ®</span>
</span></span><span style=display:flex><span>item.stock <span style=color:#f92672>=</span> stock.stock
</span></span><span style=display:flex><span>item.sold <span style=color:#f92672>=</span> stock.sold
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style=display:flex><span>ngx.say(cjson.encode(item))
</span></span></code></pre></td></tr></table></div></div><blockquote><p>è¿™é‡Œå°±å®ç°äº†å°†å‰ç«¯çš„è¯·æ±‚é€šè¿‡Nginxåå‘ä»£ç†åˆ°OpenRestyä¸­ï¼Œç„¶åä»è¿™é‡Œå‘è¯·æ±‚ï¼Œè¿›ä¸€æ­¥åå‘ä»£ç†åˆ°javaåç«¯ä¸­ï¼ŒæŸ¥è¯¢å¾—åˆ°ç»“æœä¹‹åï¼Œå†å°†ç»“æœåœ¨OpenRestyä¸­è¿›è¡Œæ‹¼æ¥ï¼Œè¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯åªæ˜¯ä»¥ä¸ºåç«¯ç›´æ¥è¿”å›çš„å°±æ˜¯è¿™ç§æ•°æ®</p></blockquote><h3 id=445åŸºäºidè´Ÿè½½å‡è¡¡>4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡
<a class=header-anchor href=#445%e5%9f%ba%e4%ba%8eid%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1></a></h3><p>åˆšæ‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„tomcatæ˜¯å•æœºéƒ¨ç½²ã€‚è€Œå®é™…å¼€å‘ä¸­ï¼Œtomcatä¸€å®šæ˜¯<strong>é›†ç¾¤</strong>æ¨¡å¼ï¼Œæ‰€ä»¥åå‘ä»£ç†æ—¶ï¼Œä¸å†æ˜¯ä»£ç†åˆ°ä¸€ä¸ªæŒ‡å®šçš„ipå’Œç«¯å£ï¼Œè€Œæ˜¯ä»£ç†åˆ°ä¸€ä¸ªé›†ç¾¤ï¼Œé›†ç¾¤ä¸­é…ç½®äº†å¤šå°ä¸»æœºçš„ipå’Œç«¯å£ï¼Œç„¶åé›†ç¾¤ä¹‹é—´çš„<strong>è´Ÿè½½å‡è¡¡æ–¹å¼é‡‡ç”¨id</strong>ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•°æ®çš„ç¼“å­˜å‘½ä¸­ç‡ï¼Œç›¸å½“äºRedisä¸­çš„åˆ†ç‰‡é›†ç¾¤ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231608.png alt=image-20210821111023255></p><p>å› æ­¤ï¼ŒOpenRestyéœ€è¦å¯¹tomcaté›†ç¾¤åšè´Ÿè½½å‡è¡¡ã€‚</p><p>è€Œé»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯è½®è¯¢æ¨¡å¼ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢/item/10001æ—¶ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ä¼šè®¿é—®8081ç«¯å£çš„tomcatæœåŠ¡ï¼Œåœ¨è¯¥æœåŠ¡å†…éƒ¨å°±å½¢æˆäº†JVMè¿›ç¨‹ç¼“å­˜</li><li>ç¬¬äºŒæ¬¡ä¼šè®¿é—®8082ç«¯å£çš„tomcatæœåŠ¡ï¼Œè¯¥æœåŠ¡å†…éƒ¨æ²¡æœ‰JVMç¼“å­˜ï¼ˆå› ä¸ºJVMç¼“å­˜æ— æ³•å…±äº«ï¼‰ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“</li><li>&mldr;</li></ul><p>ä½ çœ‹ï¼Œå› ä¸ºè½®è¯¢çš„åŸå› ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢8081å½¢æˆçš„JVMç¼“å­˜å¹¶æœªç”Ÿæ•ˆï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡å†æ¬¡è®¿é—®åˆ°8081æ—¶æ‰å¯ä»¥ç”Ÿæ•ˆï¼Œ<strong>ç¼“å­˜å‘½ä¸­ç‡å¤ªä½</strong>äº†ã€‚</p><p>æ€ä¹ˆåŠï¼Ÿ</p><p>å¦‚æœèƒ½è®©åŒä¸€ä¸ªå•†å“ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œé‚£ä¹ˆJVMç¼“å­˜å°±ä¸€å®šèƒ½ç”Ÿæ•ˆäº†ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å•†å“idåšè´Ÿè½½å‡è¡¡ï¼Œè€Œä¸æ˜¯è½®è¯¢ã€‚</p><h4 id=1åŸç†>1ï¼‰åŸç†
<a class=header-anchor href=#1%e5%8e%9f%e7%90%86></a></h4><p>nginxæä¾›äº†åŸºäºè¯·æ±‚è·¯å¾„åšè´Ÿè½½å‡è¡¡çš„ç®—æ³•ï¼š</p><p>nginxæ ¹æ®è¯·æ±‚è·¯å¾„åšhashè¿ç®—ï¼ŒæŠŠå¾—åˆ°çš„æ•°å€¼å¯¹tomcatæœåŠ¡çš„æ•°é‡å–ä½™ï¼Œä½™æ•°æ˜¯å‡ ï¼Œå°±è®¿é—®ç¬¬å‡ ä¸ªæœåŠ¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚åæœŸåªè¦è¯·æ±‚è·¯å¾„ç›¸åŒï¼Œè¿™æ ·è·¯ç”±åˆ°çš„tomcatæœåŠ¡å™¨å°±æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥æé«˜ç¼“å­˜çš„å‘½ä¸­ç‡</p><p>ä¾‹å¦‚ï¼š</p><ul><li>æˆ‘ä»¬çš„è¯·æ±‚è·¯å¾„æ˜¯ /item/10001</li><li>tomcatæ€»æ•°ä¸º2å°ï¼ˆ8081ã€8082ï¼‰</li><li>å¯¹è¯·æ±‚è·¯å¾„/item/1001åšhashè¿ç®—æ±‚ä½™çš„ç»“æœä¸º1</li><li>åˆ™è®¿é—®ç¬¬ä¸€ä¸ªtomcatæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯8081</li></ul><p>åªè¦<strong>idä¸å˜ï¼Œæ¯æ¬¡hashè¿ç®—ç»“æœä¹Ÿä¸ä¼šå˜</strong>ï¼Œç±»ä¼¼äºRedisåˆ†ç‰‡é›†ç¾¤ä¸­çš„æ’æ§½ã€‚é‚£å°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªå•†å“ï¼Œä¸€ç›´è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œç¡®ä¿JVMç¼“å­˜ç”Ÿæ•ˆã€‚</p><h4 id=2å®ç°>2ï¼‰å®ç°
<a class=header-anchor href=#2%e5%ae%9e%e7%8e%b0></a></h4><p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œå®ç°åŸºäºIDåšè´Ÿè½½å‡è¡¡ã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰tomcaté›†ç¾¤ï¼Œå¹¶è®¾ç½®åŸºäºè·¯å¾„åšè´Ÿè½½å‡è¡¡ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>upstream</span> <span style=color:#e6db74>tomcat-cluster</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>hash</span> $request_uri; <span style=color:#75715e># åªè¦åŠ ä¸Šè¿™ä¸€è¡Œé…ç½®ï¼Œå°±å¯ä»¥å®Œæˆé’ˆå¯¹idåšè´Ÿè½½å‡è¡¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>server</span> 192.168.150.1:<span style=color:#ae81ff>8081</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> 192.168.150.1:<span style=color:#ae81ff>8082</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åï¼Œä¿®æ”¹å¯¹tomcatæœåŠ¡çš„åå‘ä»£ç†ï¼Œç›®æ ‡æŒ‡å‘tomcaté›†ç¾¤ï¼Œä¸å†æ˜¯æŒ‡å‘ä¸€ä¸ªå•ç‹¬çš„ipåœ°å€å’Œç«¯å£ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/item</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://tomcat-cluster</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>é‡æ–°åŠ è½½OpenResty</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>nginx -s reload
</span></span></code></pre></td></tr></table></div></div><h4 id=3æµ‹è¯•>3ï¼‰æµ‹è¯•
<a class=header-anchor href=#3%e6%b5%8b%e8%af%95></a></h4><p>å¯åŠ¨ä¸¤å°tomcatæœåŠ¡ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231609.png alt=image-20210821112420464 style=zoom:50%><p>åŒæ—¶å¯åŠ¨ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231610.png alt=image-20210821112444482></p><p>æ¸…ç©ºæ—¥å¿—åï¼Œå†æ¬¡è®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒidçš„å•†å“ï¼Œè®¿é—®åˆ°äº†ä¸åŒçš„tomcatæœåŠ¡ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231611.png alt=image-20210821112559965></p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231612.png alt=image-20210821112637430></p><h2 id=45redisç¼“å­˜é¢„çƒ­>4.5.Redisç¼“å­˜é¢„çƒ­
<a class=header-anchor href=#45redis%e7%bc%93%e5%ad%98%e9%a2%84%e7%83%ad></a></h2><p>Redisç¼“å­˜ä¼šé¢ä¸´<strong>å†·å¯åŠ¨</strong>é—®é¢˜ï¼š</p><p><strong>å†·å¯åŠ¨</strong>ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedisä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›ã€‚</p><p><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®<strong>æå‰æŸ¥è¯¢</strong>å¹¶ä¿å­˜åˆ°Redisä¸­ã€‚ç›¸å½“äºæå‰ç¼“å­˜</p><p>æˆ‘ä»¬æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾å…¥ç¼“å­˜ä¸­ã€‚</p><p>1ï¼‰åˆ©ç”¨Dockerå®‰è£…Redis</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰åœ¨item-serviceæœåŠ¡ä¸­å¼•å…¥Redisä¾èµ–</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>3ï¼‰é…ç½®Redisåœ°å€</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>redis</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>192.168.150.101</span>
</span></span></code></pre></td></tr></table></div></div><p>4ï¼‰ç¼–å†™åˆå§‹åŒ–ç±»</p><p>ç¼“å­˜é¢„çƒ­éœ€è¦åœ¨<strong>é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆ</strong>ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ‹¿åˆ°<code>RedisTemplate</code>ä¹‹åã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨<code>InitializingBean</code>æ¥å£æ¥å®ç°ï¼Œå› ä¸º<code>InitializingBean</code>å¯ä»¥åœ¨å¯¹è±¡è¢«Springåˆ›å»ºå¹¶ä¸”æˆå‘˜å˜é‡å…¨éƒ¨æ³¨å…¥åæ‰§è¡Œã€‚ç›¸å½“äºä¸€ä¸ªåˆå§‹åŒ–æ—¶æœºçš„è°ƒç”¨</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.heima.item.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.fasterxml.jackson.core.JsonProcessingException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.fasterxml.jackson.databind.ObjectMapper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.Item<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.ItemStock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.service.IItemService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.service.IItemStockService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.InitializingBean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.data.redis.core.StringRedisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisHandler</span> <span style=color:#66d9ef>implements</span> InitializingBean <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> StringRedisTemplate redisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemService itemService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemStockService stockService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ObjectMapper MAPPER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectMapper<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>//åˆå§‹åŒ–ä¹‹åå°±è°ƒç”¨è¿™ä¸ªæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 1.æŸ¥è¯¢å•†å“ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;</span> itemList <span style=color:#f92672>=</span> itemService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.æ”¾å…¥ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Item item <span style=color:#f92672>:</span> itemList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.1.itemåºåˆ—åŒ–ä¸ºJSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String json <span style=color:#f92672>=</span> MAPPER<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.2.å­˜å…¥redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>//æ•°æ®çš„idä½¿ç”¨äº†ç»Ÿä¸€çš„å‰ç¼€ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å•†å“ä¿¡æ¯è¢«å“ˆå¸Œåˆ°äº†ä¸€èµ·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>ItemStock<span style=color:#f92672>&gt;</span> stockList <span style=color:#f92672>=</span> stockService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.æ”¾å…¥ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ItemStock stock <span style=color:#f92672>:</span> stockList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.1.itemåºåˆ—åŒ–ä¸ºJSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String json <span style=color:#f92672>=</span> MAPPER<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.2.å­˜å…¥redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;item:stock:id:&#34;</span> <span style=color:#f92672>+</span> stock<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>æ”¾å…¥ç¼“å­˜ä¸­çš„æ•°æ®çš„keyçš„å‰ç¼€æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·ä¿è¯å“ˆå¸Œä¹‹åä¹Ÿåœ¨ä¸€èµ·</p></blockquote><h2 id=46æŸ¥è¯¢redisç¼“å­˜>4.6.æŸ¥è¯¢Redisç¼“å­˜
<a class=header-anchor href=#46%e6%9f%a5%e8%af%a2redis%e7%bc%93%e5%ad%98></a></h2><p>ç°åœ¨ï¼ŒRedisç¼“å­˜å·²ç»å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥å†OpenRestyä¸­å®ç°æŸ¥è¯¢Redisçš„é€»è¾‘äº†ã€‚å¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231613.png alt=image-20210821113340111 style=zoom:50%><p>å½“è¯·æ±‚è¿›å…¥OpenRestyä¹‹åï¼š</p><ul><li>ä¼˜å…ˆæŸ¥è¯¢Redisç¼“å­˜</li><li>å¦‚æœRedisç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢Tomcat</li></ul><h3 id=461å°è£…rediså·¥å…·>4.6.1.å°è£…Rediså·¥å…·
<a class=header-anchor href=#461%e5%b0%81%e8%a3%85redis%e5%b7%a5%e5%85%b7></a></h3><p>OpenRestyæä¾›äº†æ“ä½œRedisçš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†Redisæ“ä½œå°è£…åˆ°ä¹‹å‰çš„common.luaå·¥å…·åº“ä¸­ã€‚</p><p>ä¿®æ”¹<code>/usr/local/openresty/lualib/common.lua</code>æ–‡ä»¶ï¼š</p><p>1ï¼‰å¼•å…¥Redisæ¨¡å—ï¼Œå¹¶åˆå§‹åŒ–Rediså¯¹è±¡</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥redis</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> redis <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;resty.redis&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- åˆå§‹åŒ–redis</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> red <span style=color:#f92672>=</span> redis:new()
</span></span><span style=display:flex><span>red:set_timeouts(<span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>)
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰å°è£…å‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾Redisè¿æ¥ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± ï¼Œä»£è¡¨å½“å‰è¿æ¥å¯ä»¥ç»™åˆ«äººä½¿ç”¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>close_redis</span>(red)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> pool_max_idle_time <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span> <span style=color:#75715e>-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> pool_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#75715e>--è¿æ¥æ± å¤§å°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:set_keepalive(pool_max_idle_time, pool_size)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: &#34;</span>, err)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>3ï¼‰å°è£…å‡½æ•°ï¼Œæ ¹æ®keyæŸ¥è¯¢Redisæ•°æ®</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_redis</span>(ip, port, key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è·å–ä¸€ä¸ªè¿æ¥ï¼Œè¿æ¥è·å–æˆåŠŸç›´æ¥æŸ¥è¯¢</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:connect(ip, port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;è¿æ¥rediså¤±è´¥ : &#34;</span>, err)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢redis</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> resp, err <span style=color:#f92672>=</span> red:get(key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> resp <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æŸ¥è¯¢Rediså¤±è´¥: &#34;</span>, err, <span style=color:#e6db74>&#34;, key = &#34;</span> , key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>--å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> resp <span style=color:#f92672>==</span> ngx.null <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = &#34;</span>, key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- å°†å½“å‰redisçš„è¿æ¥æ”¾å…¥è¿æ¥æ± ä¸­</span>
</span></span><span style=display:flex><span>    close_redis(red)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>4ï¼‰å¯¼å‡º</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {  
</span></span><span style=display:flex><span>    read_http <span style=color:#f92672>=</span> read_http,
</span></span><span style=display:flex><span>    read_redis <span style=color:#f92672>=</span> read_redis
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> _M
</span></span></code></pre></td></tr></table></div></div><p>å®Œæ•´çš„common.luaï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥redis</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> redis <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;resty.redis&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- åˆå§‹åŒ–redis</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> red <span style=color:#f92672>=</span> redis:new()
</span></span><span style=display:flex><span>red:set_timeouts(<span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>close_redis</span>(red)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> pool_max_idle_time <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span> <span style=color:#75715e>-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> pool_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#75715e>--è¿æ¥æ± å¤§å°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:set_keepalive(pool_max_idle_time, pool_size)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: &#34;</span>, err)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_redis</span>(ip, port, key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è·å–ä¸€ä¸ªè¿æ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:connect(ip, port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;è¿æ¥rediså¤±è´¥ : &#34;</span>, err)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢redis</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> resp, err <span style=color:#f92672>=</span> red:get(key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> resp <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æŸ¥è¯¢Rediså¤±è´¥: &#34;</span>, err, <span style=color:#e6db74>&#34;, key = &#34;</span> , key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>--å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> resp <span style=color:#f92672>==</span> ngx.null <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = &#34;</span>, key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    close_redis(red)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_http</span>(path, params)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> resp <span style=color:#f92672>=</span> ngx.location.capture(path,{
</span></span><span style=display:flex><span>        method <span style=color:#f92672>=</span> ngx.HTTP_GET,
</span></span><span style=display:flex><span>        args <span style=color:#f92672>=</span> params,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> resp <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;httpæŸ¥è¯¢å¤±è´¥, path: &#34;</span>, path , <span style=color:#e6db74>&#34;, args: &#34;</span>, args)
</span></span><span style=display:flex><span>        ngx.exit(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp.body
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {  
</span></span><span style=display:flex><span>    read_http <span style=color:#f92672>=</span> read_http,
</span></span><span style=display:flex><span>    read_redis <span style=color:#f92672>=</span> read_redis
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> _M
</span></span></code></pre></td></tr></table></div></div><h3 id=462å®ç°redisæŸ¥è¯¢>4.6.2.å®ç°RedisæŸ¥è¯¢
<a class=header-anchor href=#462%e5%ae%9e%e7%8e%b0redis%e6%9f%a5%e8%af%a2></a></h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹<strong>item.lua</strong>æ–‡ä»¶ï¼Œå®ç°å…ˆå¯¹Rediså†å¯¹Tomcatçš„æŸ¥è¯¢äº†ã€‚</p><p>æŸ¥è¯¢é€»è¾‘æ˜¯ï¼š</p><ul><li>æ ¹æ®idæŸ¥è¯¢Redis</li><li>å¦‚æœæŸ¥è¯¢å¤±è´¥åˆ™ç»§ç»­æŸ¥è¯¢Tomcat</li><li>å°†æŸ¥è¯¢ç»“æœè¿”å›</li></ul><p>1ï¼‰ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæŸ¥è¯¢å‡½æ•°ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> common <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;common&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_http <span style=color:#f92672>=</span> common.read_http
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_redis <span style=color:#f92672>=</span> common.read_redis
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_data</span>(key, path, params)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> val <span style=color:#f92672>=</span> read_redis(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#ae81ff>6379</span>, key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> read_http(path, params)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è¿”å›æ•°æ®</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰è€Œåä¿®æ”¹å•†å“æŸ¥è¯¢ã€åº“å­˜æŸ¥è¯¢çš„ä¸šåŠ¡ï¼Œä¸»è¦æ˜¯ä¿®æ”¹æŸ¥è¯¢æ•°æ®ä¼ é€’çš„å‚æ•°ä»¥åŠå‡½æ•°åï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231614.png alt=image-20210821114528954></p><p>3ï¼‰å®Œæ•´çš„item.luaä»£ç ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> common <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;common&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_http <span style=color:#f92672>=</span> common.read_http
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_redis <span style=color:#f92672>=</span> common.read_redis
</span></span><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥cjsonåº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> cjson <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;cjson&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_data</span>(key, path, params)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œè¿™é‡Œçš„redisä¸åº”è¯¥å†™æ­»ï¼Œåº”è¯¥å†™åˆ°ä¸€ä¸ªredisé›†ç¾¤ä¸­</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> val <span style=color:#f92672>=</span> read_redis(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#ae81ff>6379</span>, key)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> read_http(path, params)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è¿”å›æ•°æ®</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> id <span style=color:#f92672>=</span> ngx.var[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œå…ˆæŸ¥è¯¢rediså†æŸ¥è¯¢tomcat</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemJSON <span style=color:#f92672>=</span> read_data(<span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>..</span> id,  <span style=color:#e6db74>&#34;/item/&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stockJSON <span style=color:#f92672>=</span> read_data(<span style=color:#e6db74>&#34;item:stock:id:&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#e6db74>&#34;/item/stock/&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- JSONè½¬åŒ–ä¸ºluaçš„table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item <span style=color:#f92672>=</span> cjson.decode(itemJSON)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stock <span style=color:#f92672>=</span> cjson.decode(stockJSON)
</span></span><span style=display:flex><span><span style=color:#75715e>-- ç»„åˆæ•°æ®</span>
</span></span><span style=display:flex><span>item.stock <span style=color:#f92672>=</span> stock.stock
</span></span><span style=display:flex><span>item.sold <span style=color:#f92672>=</span> stock.sold
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style=display:flex><span>ngx.say(cjson.encode(item))
</span></span></code></pre></td></tr></table></div></div><blockquote><p>åœ¨å…¶ä¸­è°ƒç”¨read_dataå‡½æ•°ï¼Œå†…éƒ¨å…ˆè°ƒç”¨redisï¼Œç„¶åå†è°ƒç”¨tomcatï¼Œè¿™æ ·å°±å®ç°äº†å¤šçº§ç¼“å­˜</p></blockquote><h2 id=47nginxæœ¬åœ°ç¼“å­˜>4.7.Nginxæœ¬åœ°ç¼“å­˜
<a class=header-anchor href=#47nginx%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98></a></h2><p>ç°åœ¨ï¼Œæ•´ä¸ªå¤šçº§ç¼“å­˜ä¸­åªå·®æœ€åä¸€ç¯ï¼Œä¹Ÿå°±æ˜¯nginxçš„æœ¬åœ°ç¼“å­˜äº†ã€‚å¦‚å›¾ï¼Œnginxæœ¬åœ°ç¼“å­˜å’Œredisç¼“å­˜çš„æŸ¥è¯¢é¡ºåºç”±luaè„šæœ¬æ§åˆ¶ï¼Œæœ€åä¼šåˆ°è¾¾tomcatä¸­ï¼Œåœ¨è¿™é‡Œä¹Ÿä¼šå…ˆæŸ¥è¯¢jvmçš„æœ¬åœ°ç¼“å­˜ï¼Œæœ€åæ‰æŸ¥è¯¢æ•°æ®åº“ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231615.png alt=image-20210821114742950 style=zoom:50%><h3 id=471æœ¬åœ°ç¼“å­˜api>4.7.1.æœ¬åœ°ç¼“å­˜API
<a class=header-anchor href=#471%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98api></a></h3><p>OpenRestyä¸ºNginxæä¾›äº†<strong>shard dict</strong>çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨nginxçš„å¤šä¸ªworkerä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚</p><p>1ï¼‰å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨nginx.confçš„httpä¸‹æ·»åŠ é…ç½®ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=display:flex><span> <span style=color:#75715e># å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>lua_shared_dict</span> <span style=color:#e6db74>item_cache</span> <span style=color:#ae81ff>150m</span>; 
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰æ“ä½œå…±äº«å­—å…¸ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- è·å–æœ¬åœ°ç¼“å­˜å¯¹è±¡</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item_cache <span style=color:#f92672>=</span> ngx.shared.item_cache
</span></span><span style=display:flex><span><span style=color:#75715e>-- å­˜å‚¨, æŒ‡å®škeyã€valueã€è¿‡æœŸæ—¶é—´ï¼Œå•ä½sï¼Œé»˜è®¤ä¸º0ä»£è¡¨æ°¸ä¸è¿‡æœŸ</span>
</span></span><span style=display:flex><span>item_cache:set(<span style=color:#e6db74>&#39;key&#39;</span>, <span style=color:#e6db74>&#39;value&#39;</span>, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- è¯»å–</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> val <span style=color:#f92672>=</span> item_cache:get(<span style=color:#e6db74>&#39;key&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=472å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢>4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢
<a class=header-anchor href=#472%e5%ae%9e%e7%8e%b0%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98%e6%9f%a5%e8%af%a2></a></h3><p>1ï¼‰ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œä¿®æ”¹read_dataæŸ¥è¯¢å‡½æ•°ï¼Œæ·»åŠ æœ¬åœ°ç¼“å­˜é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯åœ¨æŸ¥è¯¢redisä¹‹å‰æ–°å¢ä¸€ä¸ªæŸ¥è¯¢æœ¬åœ°è¯·æ±‚çš„é€»è¾‘ï¼Œè¿™é‡Œæ¯æŸ¥è¯¢ä¸€æ¬¡ï¼Œå°±ä¼šæ›´æ–°ç¼“å­˜çš„å­˜æ´»æ—¶é—´ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜ï¼Œä¹‹åæ•°æ®ä¼šè¢«ç¼“å­˜åˆ°è¿™é‡Œ</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item_cache <span style=color:#f92672>=</span> ngx.shared.item_cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_data</span>(key, expire, path, params)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> val <span style=color:#f92672>=</span> item_cache:get(key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- æŸ¥è¯¢redis</span>
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> read_redis(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#ae81ff>6379</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>            <span style=color:#75715e>-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style=display:flex><span>            val <span style=color:#f92672>=</span> read_http(path, params)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    item_cache:set(key, val, expire)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è¿”å›æ•°æ®</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>2ï¼‰ä¿®æ”¹item.luaä¸­æŸ¥è¯¢å•†å“å’Œåº“å­˜çš„ä¸šåŠ¡ï¼Œå®ç°æœ€æ–°çš„read_dataå‡½æ•°ï¼ŒæŒ‡å®šç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231616.png alt=image-20210821115108528></p><p>å…¶å®å°±æ˜¯å¤šäº†ç¼“å­˜æ—¶é—´å‚æ•°ï¼Œè¿‡æœŸånginxç¼“å­˜ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä¸‹æ¬¡è®¿é—®å³å¯<strong>æ›´æ–°ç¼“å­˜</strong>ã€‚</p><p>è¿™é‡Œç»™å•†å“åŸºæœ¬ä¿¡æ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œåº“å­˜ä¸º1åˆ†é’Ÿã€‚</p><p>å› ä¸ºåº“å­˜æ›´æ–°é¢‘ç‡è¾ƒé«˜ï¼Œå¦‚æœç¼“å­˜æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¸æ•°æ®åº“å·®å¼‚è¾ƒå¤§ã€‚</p><p>3ï¼‰å®Œæ•´çš„item.luaæ–‡ä»¶ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> common <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;common&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_http <span style=color:#f92672>=</span> common.read_http
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> read_redis <span style=color:#f92672>=</span> common.read_redis
</span></span><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥cjsonåº“</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> cjson <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;cjson&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item_cache <span style=color:#f92672>=</span> ngx.shared.item_cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read_data</span>(key, expire, path, params)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> val <span style=color:#f92672>=</span> item_cache:get(key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- æŸ¥è¯¢redis</span>
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> read_redis(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#ae81ff>6379</span>, key)
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style=display:flex><span>            <span style=color:#75715e>-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style=display:flex><span>            val <span style=color:#f92672>=</span> read_http(path, params)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜ï¼Œæˆ–è€…è¯´æ›´æ–°æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    item_cache:set(key, val, expire)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- è¿”å›æ•°æ®</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> id <span style=color:#f92672>=</span> ngx.var[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> itemJSON <span style=color:#f92672>=</span> read_data(<span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#ae81ff>1800</span>,  <span style=color:#e6db74>&#34;/item/&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stockJSON <span style=color:#f92672>=</span> read_data(<span style=color:#e6db74>&#34;item:stock:id:&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;/item/stock/&#34;</span> <span style=color:#f92672>..</span> id, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- JSONè½¬åŒ–ä¸ºluaçš„table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> item <span style=color:#f92672>=</span> cjson.decode(itemJSON)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stock <span style=color:#f92672>=</span> cjson.decode(stockJSON)
</span></span><span style=display:flex><span><span style=color:#75715e>-- ç»„åˆæ•°æ®</span>
</span></span><span style=display:flex><span>item.stock <span style=color:#f92672>=</span> stock.stock
</span></span><span style=display:flex><span>item.sold <span style=color:#f92672>=</span> stock.sold
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style=display:flex><span>ngx.say(cjson.encode(item))
</span></span></code></pre></td></tr></table></div></div><h1 id=5ç¼“å­˜åŒæ­¥>5.ç¼“å­˜åŒæ­¥
<a class=header-anchor href=#5%e7%bc%93%e5%ad%98%e5%90%8c%e6%ad%a5></a></h1><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŸ¥è¯¢åˆ°çš„éƒ½æ˜¯ç¼“å­˜æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸æ•°æ®åº“æ•°æ®å­˜åœ¨<strong>è¾ƒå¤§å·®å¼‚</strong>ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„åæœã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“æ•°æ®ã€ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥ã€‚</p><h2 id=51æ•°æ®åŒæ­¥ç­–ç•¥>5.1.æ•°æ®åŒæ­¥ç­–ç•¥
<a class=header-anchor href=#51%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5%e7%ad%96%e7%95%a5></a></h2><p>ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><p><strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼šç»™ç¼“å­˜<strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°</p><ul><li>ä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿</li><li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´</li><li>åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡</li></ul><p><strong>åŒæ­¥åŒå†™</strong>ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥åœ¨<strong>æ›´æ–°æ—¶ä¿®æ”¹ç¼“å­˜</strong></p><ul><li>ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´</li><li>ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼›</li><li>åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®</li></ul><p><strong>å¼‚æ­¥é€šçŸ¥ï¼š<strong>ä¿®æ”¹æ•°æ®åº“æ—¶å‘é€</strong>äº‹ä»¶é€šçŸ¥</strong>ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®</p><ul><li>ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡</li><li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</li><li>åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥</li></ul><p>è€Œå¼‚æ­¥å®ç°åˆå¯ä»¥åŸºäºMQæˆ–è€…Canalæ¥å®ç°ï¼š</p><p>1ï¼‰åŸºäºMQçš„å¼‚æ­¥é€šçŸ¥ï¼š</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231617.png alt=image-20210821115552327 style=zoom:33%><p>è§£è¯»ï¼š</p><ul><li>å•†å“æœåŠ¡å®Œæˆå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œåªéœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQä¸­ã€‚</li><li>ç¼“å­˜æœåŠ¡ç›‘å¬MQæ¶ˆæ¯ï¼Œç„¶åå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°</li></ul><p>ä¾ç„¶æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥ã€‚</p><p>2ï¼‰åŸºäºCanalçš„é€šçŸ¥</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231618.png alt=image-20210821115719363 style=zoom:33%><p>è§£è¯»ï¼š</p><ul><li>å•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</li><li>Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡</li><li>ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜</li></ul><p><strong>ä»£ç é›¶ä¾µå…¥</strong></p><h2 id=52å®‰è£…canal>5.2.å®‰è£…Canal
<a class=header-anchor href=#52%e5%ae%89%e8%a3%85canal></a></h2><h3 id=521è®¤è¯†canal>5.2.1.è®¤è¯†Canal
<a class=header-anchor href=#521%e8%ae%a4%e8%af%86canal></a></h3><p><strong>Canal [kÉ™&rsquo;nÃ¦l]</strong>ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œcanalæ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…&æ¶ˆè´¹ã€‚GitHubçš„åœ°å€ï¼šhttps://github.com/alibaba/canal</p><p>Canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQLä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ç›‘å¬ä¸»èŠ‚ç‚¹çš„binlogï¼š</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231619.png alt=image-20210821115914748></p><ul><li>1ï¼‰MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—( binary logï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ•°æ®å«åšbinary log events</li><li>2ï¼‰MySQL slave å°† master çš„ binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(relay log)</li><li>3ï¼‰MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´åæ˜ å®ƒè‡ªå·±çš„æ•°</li></ul><p>è€ŒCanalå°±æ˜¯æŠŠè‡ªå·±<strong>ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªslaveèŠ‚ç‚¹</strong>ï¼Œä»è€Œç›‘å¬masterçš„binary logå˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™Canalçš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231620.png alt=image-20210821115948395 style=zoom:50%><h2 id=52ç›‘å¬canal>5.2.ç›‘å¬Canal
<a class=header-anchor href=#52%e7%9b%91%e5%90%accanal></a></h2><p>Canalæä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“Canalç›‘å¬åˆ°<strong>binlogå˜åŒ–</strong>æ—¶ï¼Œä¼šé€šçŸ¥Canalçš„å®¢æˆ·ç«¯ã€‚ç›¸å½“äºbinlogä¸€æ—¦å˜åŒ–ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ç»™cannalå®¢æˆ·ç«¯ï¼Œä¹‹ååœ¨å®¢æˆ·ç«¯ä¸­ç¼–å†™æ›´æ–°ç¼“å­˜çš„é€»è¾‘</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151231622.png alt=image-20210821120049024></p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Canalæä¾›çš„Javaå®¢æˆ·ç«¯ï¼Œç›‘å¬Canalé€šçŸ¥æ¶ˆæ¯ã€‚å½“æ”¶åˆ°å˜åŒ–çš„æ¶ˆæ¯æ—¶ï¼Œå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°ã€‚</p><p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨GitHubä¸Šçš„ç¬¬ä¸‰æ–¹å¼€æºçš„canal-starterå®¢æˆ·ç«¯ã€‚åœ°å€ï¼šhttps://github.com/NormanGyllenhaal/canal-client</p><p>ä¸SpringBootå®Œç¾æ•´åˆï¼Œè‡ªåŠ¨è£…é…ï¼Œæ¯”å®˜æ–¹å®¢æˆ·ç«¯è¦ç®€å•å¥½ç”¨å¾ˆå¤šã€‚</p><h3 id=531å¼•å…¥ä¾èµ–>5.3.1.å¼•å…¥ä¾èµ–ï¼š
<a class=header-anchor href=#531%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96></a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>top.javatool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>canal-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.2.1-RELEASE<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=532ç¼–å†™é…ç½®>5.3.2.ç¼–å†™é…ç½®ï¼š
<a class=header-anchor href=#532%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae></a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>canal</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>heima</span> <span style=color:#75715e># canalçš„é›†ç¾¤åå­—ï¼Œè¦ä¸å®‰è£…canalæ—¶è®¾ç½®çš„åç§°ä¸€è‡´</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.150.101</span>:<span style=color:#ae81ff>11111</span> <span style=color:#75715e># canalæœåŠ¡åœ°å€</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=533ä¿®æ”¹itemå®ä½“ç±»>5.3.3.ä¿®æ”¹Itemå®ä½“ç±»
<a class=header-anchor href=#533%e4%bf%ae%e6%94%b9item%e5%ae%9e%e4%bd%93%e7%b1%bb></a></h3><p>é€šè¿‡@Idã€@Columnã€ç­‰æ³¨è§£å®ŒæˆItemä¸æ•°æ®åº“è¡¨å­—æ®µçš„æ˜ å°„ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.heima.item.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.baomidou.mybatisplus.annotation.IdType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.baomidou.mybatisplus.annotation.TableField<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.baomidou.mybatisplus.annotation.TableId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.baomidou.mybatisplus.annotation.TableName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.data.annotation.Id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.data.annotation.Transient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.persistence.Column<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Date<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TableName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tb_item&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Item</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@TableId</span><span style=color:#f92672>(</span>type <span style=color:#f92672>=</span> IdType<span style=color:#f92672>.</span><span style=color:#a6e22e>AUTO</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id<span style=color:#f92672>;</span><span style=color:#75715e>//å•†å“id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Column</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span><span style=color:#75715e>//å•†å“åç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String title<span style=color:#f92672>;</span><span style=color:#75715e>//å•†å“æ ‡é¢˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Long price<span style=color:#f92672>;</span><span style=color:#75715e>//ä»·æ ¼ï¼ˆåˆ†ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String image<span style=color:#f92672>;</span><span style=color:#75715e>//å•†å“å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String category<span style=color:#f92672>;</span><span style=color:#75715e>//åˆ†ç±»åç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String brand<span style=color:#f92672>;</span><span style=color:#75715e>//å“ç‰Œåç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String spec<span style=color:#f92672>;</span><span style=color:#75715e>//è§„æ ¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Integer status<span style=color:#f92672>;</span><span style=color:#75715e>//å•†å“çŠ¶æ€ 1-æ­£å¸¸ï¼Œ2-ä¸‹æ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Date createTime<span style=color:#f92672>;</span><span style=color:#75715e>//åˆ›å»ºæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Date updateTime<span style=color:#f92672>;</span><span style=color:#75715e>//æ›´æ–°æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//è¡¨ç¤ºå½“å‰å­—æ®µä¸åœ¨å½“å‰æ•°æ®åº“ä¸­å‡ºç°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@TableField</span><span style=color:#f92672>(</span>exist <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transient</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer stock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@TableField</span><span style=color:#f92672>(</span>exist <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transient</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer sold<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=534ç¼–å†™ç›‘å¬å™¨>5.3.4.ç¼–å†™ç›‘å¬å™¨
<a class=header-anchor href=#534%e7%bc%96%e5%86%99%e7%9b%91%e5%90%ac%e5%99%a8></a></h3><p>é€šè¿‡å®ç°<code>EntryHandler&lt;T></code>æ¥å£ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬Canalæ¶ˆæ¯ã€‚æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li>å®ç°ç±»é€šè¿‡<code>@CanalTable("tb_item")</code>æŒ‡å®šç›‘å¬çš„è¡¨ä¿¡æ¯</li><li>EntryHandlerçš„æ³›å‹æ˜¯ä¸è¡¨å¯¹åº”çš„å®ä½“ç±»</li><li>ä¸€æ—¦å­˜åœ¨å¢åˆ æ”¹çš„æ“ä½œï¼Œcanalç›‘å¬åˆ°å°±ä¼š<strong>æ›´æ–°ç¼“å­˜</strong></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.heima.item.canal<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.github.benmanes.caffeine.cache.Cache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.config.RedisHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.Item<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> top.javatool.canal.client.annotation.CanalTable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> top.javatool.canal.client.handler.EntryHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¿™é‡ŒæŒ‡å®šè¦ç›‘å¬çš„è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@CanalTable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tb_item&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ç›‘å¬çš„è¡¨ä¸­çš„æŸä¸€è¡Œæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œcanalè‡ªåŠ¨å°†å…¶å°è£…æˆItemå‘é€è¿‡æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e>//ç„¶åè°ƒç”¨ä¸‹é¢çš„ä¸‰ä¸ªæ–¹æ³•å®Œæˆæ›´æ–°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ItemHandler</span> <span style=color:#66d9ef>implements</span> EntryHandler<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è¿™é‡Œåªæ›´æ–°äº†æœ¬åœ°ç¼“å­˜å’Œredisç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//åé¢çš„Nginxç¼“å­˜æ²¡æœ‰æ›´æ–°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//è¿™é‡Œè‡ªåŠ¨å°è£…äº†ä¸€ä¸ªHandler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisHandler redisHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Cache<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> Item<span style=color:#f92672>&gt;</span> itemCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span><span style=color:#f92672>(</span>Item item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        itemCache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å†™æ•°æ®åˆ°redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        redisHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>saveItem</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>Item before<span style=color:#f92672>,</span> Item after<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        itemCache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>after<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> after<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å†™æ•°æ®åˆ°redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        redisHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>saveItem</span><span style=color:#f92672>(</span>after<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>Item item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆ é™¤æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        itemCache<span style=color:#f92672>.</span><span style=color:#a6e22e>invalidate</span><span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆ é™¤æ•°æ®åˆ°redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        redisHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteItemById</span><span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨è¿™é‡Œå¯¹Redisçš„æ“ä½œéƒ½å°è£…åˆ°äº†RedisHandlerè¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰åšç¼“å­˜é¢„çƒ­æ—¶ç¼–å†™çš„ä¸€ä¸ªç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.heima.item.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.fasterxml.jackson.core.JsonProcessingException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.fasterxml.jackson.databind.ObjectMapper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.Item<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.pojo.ItemStock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.service.IItemService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.heima.item.service.IItemStockService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.InitializingBean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.data.redis.core.StringRedisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisHandler</span> <span style=color:#66d9ef>implements</span> InitializingBean <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> StringRedisTemplate redisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemService itemService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IItemStockService stockService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ObjectMapper MAPPER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectMapper<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 1.æŸ¥è¯¢å•†å“ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>Item<span style=color:#f92672>&gt;</span> itemList <span style=color:#f92672>=</span> itemService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.æ”¾å…¥ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Item item <span style=color:#f92672>:</span> itemList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.1.itemåºåˆ—åŒ–ä¸ºJSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String json <span style=color:#f92672>=</span> MAPPER<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.2.å­˜å…¥redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>ItemStock<span style=color:#f92672>&gt;</span> stockList <span style=color:#f92672>=</span> stockService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.æ”¾å…¥ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ItemStock stock <span style=color:#f92672>:</span> stockList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.1.itemåºåˆ—åŒ–ä¸ºJSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String json <span style=color:#f92672>=</span> MAPPER<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2.2.å­˜å…¥redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;item:stock:id:&#34;</span> <span style=color:#f92672>+</span> stock<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveItem</span><span style=color:#f92672>(</span>Item item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String json <span style=color:#f92672>=</span> MAPPER<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>JsonProcessingException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteItemById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;itemğŸ†”&#34;</span> <span style=color:#f92672>+</span> id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ä¹‹åå°±å¯ä»¥å®ç°cancalç›‘å¬åˆ°æ•°æ®åº“ä¸­æ•°æ®çš„å˜åŒ–å°±å®Œæˆå¯¹rediså’Œæœ¬åœ°ç¼“å­˜çš„æ›´æ–°ï¼Œä½†æ˜¯Nginxä¸­çš„ç¼“å­˜æ•°æ®å¹¶æ²¡æœ‰å®Œæˆæ›´æ–°ï¼Œæœ€ç»ˆçš„é¡¹ç›®ç»“æ„ä¸ºï¼š</p></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403151703936.jpg alt=Snipaste_2024-03-15_17-00-10></p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1>å¾®æœåŠ¡</a>
<a href=/tags/%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98>å¤šçº§ç¼“å­˜</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1mq/ rel=next title=å¼‚æ­¥é€šä¿¡MQ><i class="fa fa-chevron-left"></i> å¼‚æ­¥é€šä¿¡MQ</a></div><div class="post-nav-prev post-nav-item"><a href=/post/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98redis/ rel=prev title=åˆ†å¸ƒå¼ç¼“å­˜Redis>åˆ†å¸ƒå¼ç¼“å­˜Redis
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>zzziæä¾›æŠ€æœ¯æ”¯æŒ</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zzzicode.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":null,"views":null},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"right","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"è¯·æ–‡æ˜å‘è¨€å“Ÿ ãƒ¾(â‰§â–½â‰¦*)o","reaction":true,"reactiontext":["ç‚¹èµ","è¸©ä¸€ä¸‹","å¾—æ„","ä¸å±‘","å°´å°¬","ç¡è§‰"],"reactiontitle":"ä½ è®¤ä¸ºè¿™ç¯‡æ–‡ç« æ€ä¹ˆæ ·ï¼Ÿ","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"å¿«æ¥å‘è¡¨ä½ çš„æ„è§å§ (â‰§âˆ€â‰¦)ã‚","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0e26367f0461fb41ac6f947dc2af3620375dc44aa8945e6c2b1480d342c65d1.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>