<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.111.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon_next.png><meta itemprop=name content="异步通信MQ"><meta itemprop=description content="异步通信MQ"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zzzicode.github.io/imgs/avatar.png"><meta itemprop=keywords content="微服务,RabbitMQ"><meta property="og:type" content="article"><meta property="og:title" content="异步通信MQ"><meta property="og:description" content="异步通信MQ"><meta property="og:image" content="/imgs/avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zzzicode.github.io/post/%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1mq/"><meta property="og:site_name" content="zzzi的小站"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="zzzi"><meta property="article:published_time" content="2024-03-16 12:37:17 +0800 CST"><meta property="article:modified_time" content="2024-03-16 12:37:17 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4b7f3d9c4ef8db1505229a7dcd2c4e3ab17cd4960dd8a78b503c013770ad56a6.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1mq","permalink":"https://zzzicode.github.io/post/%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1mq/","title":"异步通信MQ"}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>异步通信MQ - zzzi的小站</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>zzzi的小站</h1><i class=logo-line></i></a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>231</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#11生产者消息确认>1.1.生产者消息确认</a><ul><li><a href=#111修改配置>1.1.1.修改配置</a></li><li><a href=#112定义return回调>1.1.2.定义Return回调</a></li><li><a href=#113定义confirmcallback>1.1.3.定义ConfirmCallback</a></li><li><a href=#114-总结>1.1.4 总结</a></li></ul></li><li><a href=#12消息持久化>1.2.消息持久化</a><ul><li><a href=#121交换机持久化>1.2.1.交换机持久化</a></li><li><a href=#122队列持久化>1.2.2.队列持久化</a></li><li><a href=#123消息持久化>1.2.3.消息持久化</a></li></ul></li><li><a href=#13消费者消息确认>1.3.消费者消息确认</a><ul><li><a href=#131演示none模式>1.3.1.演示none模式</a></li><li><a href=#132演示auto模式>1.3.2.演示auto模式</a></li></ul></li><li><a href=#14消费失败重试机制>1.4.消费失败重试机制</a><ul><li><a href=#141本地重试>1.4.1.本地重试</a></li><li><a href=#142失败策略>1.4.2.失败策略</a></li></ul></li><li><a href=#15总结>1.5.总结</a></li></ul><ul><li><a href=#21初识死信交换机>2.1.初识死信交换机</a><ul><li><a href=#211什么是死信交换机>2.1.1.什么是死信交换机</a></li><li><a href=#212利用死信交换机接收死信拓展>2.1.2.利用死信交换机接收死信（拓展）</a></li><li><a href=#213总结>2.1.3.总结</a></li></ul></li><li><a href=#22ttl>2.2.TTL</a><ul><li><a href=#221接收超时死信的死信交换机>2.2.1.接收超时死信的死信交换机</a></li><li><a href=#222声明一个队列并且指定ttl>2.2.2.声明一个队列，并且指定TTL</a></li><li><a href=#223发送消息时设定ttl>2.2.3.发送消息时，设定TTL</a></li><li><a href=#224总结>2.2.4.总结</a></li></ul></li><li><a href=#23延迟队列>2.3.延迟队列</a><ul><li><a href=#231delayexchange原理>2.3.1.DelayExchange原理</a></li><li><a href=#232使用delayexchange>2.3.2.使用DelayExchange</a><ul><li><a href=#1声明delayexchange交换机>1）声明DelayExchange交换机</a></li><li><a href=#2发送消息>2）发送消息</a></li></ul></li><li><a href=#233总结>2.3.3.总结</a></li></ul></li></ul><ul><li><a href=#31消息堆积问题>3.1.消息堆积问题</a></li><li><a href=#32惰性队列>3.2.惰性队列</a><ul><li><a href=#321基于命令行设置lazy-queue>3.2.1.基于命令行设置lazy-queue</a></li><li><a href=#322基于bean声明lazy-queue>3.2.2.基于@Bean声明lazy-queue</a></li><li><a href=#323基于rabbitlistener声明lazyqueue>3.2.3.基于@RabbitListener声明LazyQueue</a></li><li><a href=#33总结>3.3.总结</a></li></ul></li></ul><ul><li><a href=#41集群分类>4.1.集群分类</a></li><li><a href=#42普通集群>4.2.普通集群</a><ul><li><a href=#421集群结构和特征>4.2.1.集群结构和特征</a></li></ul></li><li><a href=#43镜像集群>4.3.镜像集群</a><ul><li><a href=#431集群结构和特征>4.3.1.集群结构和特征</a></li></ul></li><li><a href=#44仲裁队列>4.4.仲裁队列</a><ul><li><a href=#441集群特征>4.4.1.集群特征</a></li><li><a href=#442java代码创建仲裁队列>4.4.2.Java代码创建仲裁队列</a></li><li><a href=#443springamqp连接mq集群>4.4.3.SpringAMQP连接MQ集群</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=zzzi src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.png><p class=site-author-name itemprop=name>zzzi</p><div class=site-description itemprop=description>make_tuple("工作","论文")</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>231</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>56</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zzziCode title="Github → https://github.com/zzziCode" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zzzicode.github.io/post/%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1mq/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.png"><meta itemprop=name content="zzzi"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="zzzi"><meta itemprop=description content="make_tuple(&#34;工作&#34;,&#34;论文&#34;)"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="异步通信MQ"><meta itemprop=description content="异步通信MQ"></span><header class=post-header><h1 class=post-title itemprop="name headline">异步通信MQ</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2024-03-16 12:37:17 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-03-16 12:37:17 +0800 CST">2024-03-16</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0 itemprop=url rel=index><span itemprop=name>学习笔记</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>9989</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>20分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>异步通信MQ</p></blockquote><p>本节中我们学习异步通信的剩下知识，并且介绍<code>RabbitMQ</code>的一些更高级的特性，也就是解决利用RabbitMQ来进行收发消息的时候，如何解决遇到的一些问题</p><p>消息队列在使用过程中，面临着很多实际问题需要思考：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237132.png alt=image-20210718155003157 style=zoom:33%><p>针对消息可靠性，MQ有多种解决办法，在第一节中介绍四种，针对延迟消息问题，在第二节中介绍一个死信交换机来实现延迟消息。针对消息堆积问题，第三节中提出了惰性队列，最后就是使用MQ集群来实现高可用</p><h1 id=1消息可靠性>1.消息可靠性
<a class=header-anchor href=#1%e6%b6%88%e6%81%af%e5%8f%af%e9%9d%a0%e6%80%a7></a></h1><p>消息从发送，到消费者接收，会经理<strong>多个过程</strong>：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237139.png alt=image-20210718155059371 style=zoom:33%><p>其中的每一步都可能导致<strong>消息丢失</strong>，常见的丢失原因包括：</p><ul><li>发送时丢失：<ul><li>生产者发送的消息未送达exchange</li><li>消息到达exchange后未到达queue</li></ul></li><li>MQ宕机，queue将消息丢失</li><li>consumer接收到消息后未消费就宕机</li></ul><blockquote><p>上面这些问题都导致了消息的<strong>不可靠</strong></p></blockquote><p>针对这些问题，RabbitMQ分别给出了解决方案：</p><ul><li>生产者确认机制</li><li>mq持久化</li><li>消费者确认机制</li><li>失败重试机制</li></ul><p>下面我们就通过案例来演示每一个步骤。</p><h2 id=11生产者消息确认>1.1.生产者消息确认
<a class=header-anchor href=#11%e7%94%9f%e4%ba%a7%e8%80%85%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4></a></h2><blockquote><p>确保消息到达MQ</p></blockquote><p>RabbitMQ提供了publisher confirm机制来<strong>避免消息发送到MQ过程中丢失</strong>。这种机制必须给每个消息指定一个唯一ID。消息发送到MQ以后，会返回一个结果给发送者，表示消息是否处理成功。</p><p>返回结果有两种方式：</p><ul><li><p>publisher-confirm，发送者确认，确认消息是否到交换机</p><ul><li>消息成功投递到交换机，返回ack</li><li>消息未投递到交换机，返回nack</li></ul><blockquote><p>到这里就是成功了一半，还没有到队列，不算真正的成功</p></blockquote></li><li><p>publisher-return，发送者回执，确认消息是否到队列</p><ul><li>消息投递到交换机了，但是<strong>没有路由到队列</strong>。返回ACK，及路由失败原因。</li></ul></li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161257740.png alt=image-20240316125655271></p><p>注意：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237144.png alt=image-20210718161707992 style=zoom:50%><p>相当于生产者确认有三种状态：</p><ol><li>成功到达交换机：publish-confirm ack</li><li>不成功到达交换机：publish-confirm nack</li><li>成功到达交换机但是不成功到达队列：publish-return ack</li></ol><h3 id=111修改配置>1.1.1.修改配置
<a class=header-anchor href=#111%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae></a></h3><p>首先，修改publisher服务中的application.yml文件，添加下面的内容：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>publisher-confirm-type</span>: <span style=color:#ae81ff>correlated</span> <span style=color:#75715e># 生产者确认类型</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>publisher-returns</span>: <span style=color:#66d9ef>true</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>mandatory</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li><code>publish-confirm-type</code>：开启publisher-confirm，这里支持两种类型：<ul><li><code>simple</code>：同步等待confirm结果，直到超时</li><li><code>correlated</code>：异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</li></ul></li><li><code>publish-returns</code>：开启publish-return功能，同样是基于callback机制，不过是定义ReturnCallback</li><li><code>template.mandatory</code>：定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</li></ul><h3 id=112定义return回调>1.1.2.定义Return回调
<a class=header-anchor href=#112%e5%ae%9a%e4%b9%89return%e5%9b%9e%e8%b0%83></a></h3><p>每个RabbitTemplate<strong>只能配置一个</strong>ReturnCallback，消息到达交换机但是没有到达队列时触发，因此需要在项目加载时配置：</p><p>修改publisher服务，添加一个：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.mq.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.extern.slf4j.Slf4j<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.rabbit.core.RabbitTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.BeansException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.ApplicationContext<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.ApplicationContextAware<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommonConfig</span> <span style=color:#66d9ef>implements</span> ApplicationContextAware <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setApplicationContext</span><span style=color:#f92672>(</span>ApplicationContext applicationContext<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取RabbitTemplate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RabbitTemplate rabbitTemplate <span style=color:#f92672>=</span> applicationContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span>RabbitTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置ReturnCallback
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        rabbitTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>setReturnCallback</span><span style=color:#f92672>((</span>message<span style=color:#f92672>,</span> replyCode<span style=color:#f92672>,</span> replyText<span style=color:#f92672>,</span> exchange<span style=color:#f92672>,</span> routingKey<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 投递失败，记录日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                     replyCode<span style=color:#f92672>,</span> replyText<span style=color:#f92672>,</span> exchange<span style=color:#f92672>,</span> routingKey<span style=color:#f92672>,</span> message<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果有业务需要，可以重发消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=113定义confirmcallback>1.1.3.定义ConfirmCallback
<a class=header-anchor href=#113%e5%ae%9a%e4%b9%89confirmcallback></a></h3><p>ConfirmCallback可以在<strong>发送消息时指定</strong>，因为每个业务处理confirm成功或失败的逻辑不一定相同。也就是ConfirmCallback是可以有多个的</p><p>在publisher服务的cn.itcast.mq.spring.SpringAmqpTest类中，定义一个单元测试方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testSendMessage2SimpleQueue</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1.消息体
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello, spring amqp!&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2.全局唯一的消息ID，需要封装到CorrelationData中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CorrelationData correlationData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorrelationData<span style=color:#f92672>(</span>UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.添加callback
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//根据返回的是ack还是nack判断消息是否到达交换机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    correlationData<span style=color:#f92672>.</span><span style=color:#a6e22e>getFuture</span><span style=color:#f92672>().</span><span style=color:#a6e22e>addCallback</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//消息发送成功（不一定到交换机），此时执行下面的判断逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>result<span style=color:#f92672>.</span><span style=color:#a6e22e>isAck</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 3.1.ack，消息成功
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消息发送成功, ID:{}&#34;</span><span style=color:#f92672>,</span> correlationData<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 3.2.nack，消息失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消息发送失败, ID:{}, 原因{}&#34;</span><span style=color:#f92672>,</span>correlationData<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>getReason</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//消息发送失败执行的逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ex <span style=color:#f92672>-&gt;</span> log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消息发送异常, ID:{}, 原因{}&#34;</span><span style=color:#f92672>,</span>correlationData<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span>ex<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.发送消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rabbitTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>convertAndSend</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;task.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;task&#34;</span><span style=color:#f92672>,</span> message<span style=color:#f92672>,</span> correlationData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 休眠一会儿，等待ack回执
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2000</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=114-总结>1.1.4 总结
<a class=header-anchor href=#114-%e6%80%bb%e7%bb%93></a></h3><p>springAMQP中处理消息确认的几种情况：</p><ul><li>publish-confirm：<ul><li>消息成功发送到交换机，返回ack</li><li>消息没有到达交换机，返回nack</li><li>消息发送过程中出现异常，没有收到上面的返回</li></ul></li><li>消息成功发送到交换机，但是没有发送到队列，调用ReturnCallback</li></ul><h2 id=12消息持久化>1.2.消息持久化
<a class=header-anchor href=#12%e6%b6%88%e6%81%af%e6%8c%81%e4%b9%85%e5%8c%96></a></h2><p>生产者确认可以<strong>确保</strong>消息投递到RabbitMQ的队列中，但是消息发送到RabbitMQ以后，如果突然宕机，也可能导致消息丢失。也就是指生产者确认只能保证一部分</p><p>要想确保消息在RabbitMQ中安全保存，必须开启消息持久化机制。而且下面三者<strong>缺一不可</strong></p><ul><li>交换机持久化：默认<strong>非</strong>持久化</li><li>队列持久化：默认<strong>非</strong>持久化</li><li>消息持久化：默认持久化</li></ul><h3 id=121交换机持久化>1.2.1.交换机持久化
<a class=header-anchor href=#121%e4%ba%a4%e6%8d%a2%e6%9c%ba%e6%8c%81%e4%b9%85%e5%8c%96></a></h3><p>RabbitMQ中交换机默认是非持久化的，mq重启后就丢失。</p><p>SpringAMQP中可以<strong>通过代码指定</strong>交换机持久化：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>simpleExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;simple.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>事实上，默认情况下，由SpringAMQP声明的交换机都是持久化的。</p><p>可以在RabbitMQ控制台看到持久化的交换机都会带上<code>D</code>的标示：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237145.png alt=image-20210718164412450 style=zoom:50%><h3 id=122队列持久化>1.2.2.队列持久化
<a class=header-anchor href=#122%e9%98%9f%e5%88%97%e6%8c%81%e4%b9%85%e5%8c%96></a></h3><p>RabbitMQ中队列默认是非持久化的，mq重启后就丢失。</p><p>SpringAMQP中可以<strong>通过代码指定</strong>交换机持久化：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>simpleQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用QueueBuilder构建队列，durable就是持久化的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> QueueBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>durable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;simple.queue&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>事实上，默认情况下，由SpringAMQP声明的队列都是持久化的。</p><p>可以在RabbitMQ控制台看到持久化的队列都会带上<code>D</code>的标示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237146.png alt=image-20210718164729543></p><h3 id=123消息持久化>1.2.3.消息持久化
<a class=header-anchor href=#123%e6%b6%88%e6%81%af%e6%8c%81%e4%b9%85%e5%8c%96></a></h3><p>利用SpringAMQP<strong>发送消息</strong>时，可以<strong>设置消息的属性</strong>（MessageProperties），指定delivery-mode：</p><ul><li>1：非持久化</li><li>2：持久化</li></ul><p>用java代码指定：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237147.png alt=image-20210718165100016></p><p><strong>默认</strong>情况下，SpringAMQP发出的任何消息都是持久化的，不用特意指定。</p><h2 id=13消费者消息确认>1.3.消费者消息确认
<a class=header-anchor href=#13%e6%b6%88%e8%b4%b9%e8%80%85%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4></a></h2><p>RabbitMQ是<strong>阅后即焚</strong>机制，RabbitMQ确认消息被消费者消费后<strong>会立刻删除</strong>。</p><p>而RabbitMQ是通过消费者回执来确认消费者是否成功处理消息的：消费者获取消息后，应该向RabbitMQ发送ACK回执，表明自己已经处理消息。</p><p>设想这样的场景：</p><ul><li>1）RabbitMQ投递消息给消费者</li><li>2）消费者获取消息后，返回ACK给RabbitMQ</li><li>3）RabbitMQ删除消息</li><li>4）消费者宕机，消息尚未处理</li></ul><p>这样，消息就丢失了。因此消费者返回ACK的时机非常重要。</p><p>而SpringAMQP则允许配置三种确认模式：</p><p>•manual：手动ack，需要在业务代码结束后，调用api发送ack。</p><p>•auto：自动ack，由spring监测listener代码是否出现异常，没有异常则返回ack；抛出异常则返回nack</p><p>•none：关闭ack，MQ假定消费者获取消息后会成功处理，因此消息投递后立即被删除</p><p>由此可知：</p><ul><li>none模式下，消息投递是<strong>不可靠</strong>的，可能丢失</li><li>auto模式类似事务机制，出现异常时返回nack，消息回滚到mq；没有异常，返回ack</li><li>manual：自己根据业务情况，判断什么时候该ack</li></ul><p>一般，我们都是使用默认的auto即可。</p><h3 id=131演示none模式>1.3.1.演示none模式
<a class=header-anchor href=#131%e6%bc%94%e7%a4%banone%e6%a8%a1%e5%bc%8f></a></h3><p>修改consumer服务的application.yml文件，添加下面内容：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>listener</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>simple</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>acknowledge-mode</span>: <span style=color:#ae81ff>none</span> <span style=color:#75715e># 关闭ack</span>
</span></span></code></pre></td></tr></table></div></div><p>修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理异常：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RabbitListener</span><span style=color:#f92672>(</span>queues <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;simple.queue&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>listenSimpleQueue</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消费者接收到simple.queue的消息：【{}】&#34;</span><span style=color:#f92672>,</span> msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 模拟异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消息处理完成！&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>测试可以发现，当消息处理抛异常时，消息依然被RabbitMQ删除了。</p><h3 id=132演示auto模式>1.3.2.演示auto模式
<a class=header-anchor href=#132%e6%bc%94%e7%a4%baauto%e6%a8%a1%e5%bc%8f></a></h3><p>再次把确认机制修改为auto:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>listener</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>simple</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>acknowledge-mode</span>: <span style=color:#ae81ff>auto</span> <span style=color:#75715e># 关闭ack</span>
</span></span></code></pre></td></tr></table></div></div><p>在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为unack（未确定状态）：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237148.png alt=image-20210718171705383></p><p>抛出异常后，因为Spring会<strong>自动返回nack</strong>，所以消息恢复至Ready状态，并且没有被RabbitMQ删除：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237149.png alt=image-20210718171759179></p><blockquote><p>也就是消息被删除是依靠spring中是否返回ack来决定的，返回了ack说明消息被正确处理，此时才删除消息，返回nack，此时消息不删除，之后重新发送给消费者</p></blockquote><h2 id=14消费失败重试机制>1.4.消费失败重试机制
<a class=header-anchor href=#14%e6%b6%88%e8%b4%b9%e5%a4%b1%e8%b4%a5%e9%87%8d%e8%af%95%e6%9c%ba%e5%88%b6></a></h2><p>当消费者出现异常后，消息会不断requeue（重入队）到队列，再<strong>重新发送</strong>给消费者，然后再次异常，再次requeue，<strong>无限循环</strong>，导致mq的消息处理飙升，带来不必要的压力：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237150.png alt=image-20210718172746378></p><p>怎么办呢？</p><h3 id=141本地重试>1.4.1.本地重试
<a class=header-anchor href=#141%e6%9c%ac%e5%9c%b0%e9%87%8d%e8%af%95></a></h3><p>我们可以利用Spring的retry机制，在消费者出现异常时利用<strong>本地重试</strong>，而不是无限制的requeue到mq队列。这样可以减小requeue的消耗</p><p>修改consumer服务的application.yml文件，添加内容：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>listener</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>simple</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>retry</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 开启消费者失败重试</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>initial-interval</span>: <span style=color:#ae81ff>1000</span> <span style=color:#75715e># 初始的失败等待时长为1秒</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>multiplier</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># 失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>max-attempts</span>: <span style=color:#ae81ff>3</span> <span style=color:#75715e># 最大重试次数</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>stateless</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># true无状态；false有状态。如果业务中包含事务，这里改为false</span>
</span></span></code></pre></td></tr></table></div></div><p>重启consumer服务，重复之前的测试。可以发现：</p><ul><li>在重试3次后，SpringAMQP会抛出异常AmqpRejectAndDontRequeueException，说明本地重试触发了</li><li>查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是ack，mq删除消息了</li></ul><p>结论：</p><ul><li>开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试</li><li>重试达到最大次数后，Spring会返回ack，消息会<strong>被丢弃</strong>，此时消息被丢弃的原因是因为队列认为消息被正确消费</li></ul><h3 id=142失败策略>1.4.2.失败策略
<a class=header-anchor href=#142%e5%a4%b1%e8%b4%a5%e7%ad%96%e7%95%a5></a></h3><p>在之前的测试中，达到最大重试次数后，消息会被丢弃，这是由Spring内部机制决定的。</p><p>在开启重试模式后，重试次数耗尽，如果消息依然失败，则需要有MessageRecovery接口来处理，它包含三种不同的实现：</p><ul><li><p>RejectAndDontRequeueRecoverer：重试耗尽后，直接reject，丢弃消息。默认就是这种方式</p></li><li><p>ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队</p></li><li><p>RepublishMessageRecoverer：重试耗尽后，将失败消息投递到指定的交换机</p></li></ul><p>比较优雅的一种处理方案是RepublishMessageRecoverer，失败后将消息<strong>投递到一个指定的，专门存放异常消息的队列</strong>，后续由人工集中处理。</p><p>1）在consumer服务中定义处理失败消息的交换机和队列</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>errorMessageExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error.direct&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>errorQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Queue<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error.queue&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>errorBinding</span><span style=color:#f92672>(</span>Queue errorQueue<span style=color:#f92672>,</span> DirectExchange errorMessageExchange<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>errorQueue<span style=color:#f92672>).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>errorMessageExchange<span style=color:#f92672>).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>2）定义一个RepublishMessageRecoverer，关联队列和交换机</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> MessageRecoverer <span style=color:#a6e22e>republishMessageRecoverer</span><span style=color:#f92672>(</span>RabbitTemplate rabbitTemplate<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RepublishMessageRecoverer<span style=color:#f92672>(</span>rabbitTemplate<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;error.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;error&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>完整代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.mq.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.Binding<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.BindingBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.DirectExchange<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.Queue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.rabbit.core.RabbitTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.rabbit.retry.MessageRecoverer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ErrorMessageConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//定义错误消息的交换机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>errorMessageExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error.direct&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//定义错误消息的队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>errorQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Queue<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error.queue&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//定义二者之间的绑定关系
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>errorBinding</span><span style=color:#f92672>(</span>Queue errorQueue<span style=color:#f92672>,</span> DirectExchange errorMessageExchange<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>errorQueue<span style=color:#f92672>).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>errorMessageExchange<span style=color:#f92672>).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//覆盖spring中默认的重试耗尽策略，将出现错误的消息放到错误交换机中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//此时需要将这个策略月交换机绑定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageRecoverer <span style=color:#a6e22e>republishMessageRecoverer</span><span style=color:#f92672>(</span>RabbitTemplate rabbitTemplate<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RepublishMessageRecoverer<span style=color:#f92672>(</span>rabbitTemplate<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;error.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;error&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=15总结>1.5.总结
<a class=header-anchor href=#15%e6%80%bb%e7%bb%93></a></h2><p>如何确保RabbitMQ消息的可靠性？</p><ul><li>开启生产者确认机制，确保生产者的消息<strong>能到达队列</strong></li><li>开启持久化功能，确保消息<strong>未消费前在队列中不会丢失</strong></li><li>开启消费者确认机制为auto，由spring确认消息处理成功后<strong>返回ack才删除</strong></li><li>开启消费者失败重试机制，并设置MessageRecoverer，多次重试失败后将消息投递到异常交换机，交由<strong>人工处理</strong>。人工只需要监听异常交换机对应的队列就可以拿到多次重试失败的消息，消息内部有出错的原因，之后完成人工处理</li></ul><h1 id=2死信交换机>2.死信交换机
<a class=header-anchor href=#2%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h1><h2 id=21初识死信交换机>2.1.初识死信交换机
<a class=header-anchor href=#21%e5%88%9d%e8%af%86%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h2><h3 id=211什么是死信交换机>2.1.1.什么是死信交换机
<a class=header-anchor href=#211%e4%bb%80%e4%b9%88%e6%98%af%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h3><blockquote><p>什么是死信？</p></blockquote><p>当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：</p><ul><li>消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false,也就是被丢弃的消息</li><li>消息是一个过期消息，超时无人消费</li><li>要投递的队列消息满了，无法投递</li></ul><p>如果这个包含死信的队列配置了<code>dead-letter-exchange</code>属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为<strong>死信交换机</strong>（Dead Letter Exchange，检查DLX）。</p><p>这有点类似于上面重试次数用完之后，将消息放入一个指定的队列中</p><p>如图，一个消息被消费者拒绝了，变成了死信：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237151.png alt=image-20210718174328383></p><p>因为simple.queue绑定了死信交换机 dl.direct，因此死信会投递给这个交换机：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237152.png alt=image-20210718174416160></p><p>如果这个死信交换机也绑定了一个队列，则消息最终会进入这个<strong>存放死信的队列</strong>，上一节中说道的将重试次数耗尽的消息交给一个指定的交换机，这种操作是<strong>由消费者实现</strong>的：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237153.png alt=image-20210718174506856></p><p>另外，队列将死信投递给死信交换机时，必须知道两个信息：</p><ul><li>死信交换机名称</li><li>死信交换机与死信队列绑定的RoutingKey</li></ul><blockquote><p>这样才能确保投递的消息能到达死信交换机，并且正确的路由到死信队列。</p></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237154.png alt=image-20210821073801398></p><p>知道交换机的名称和与队列之间的RoutingKey就可以将死信消息放入死信队列中</p><h3 id=212利用死信交换机接收死信拓展>2.1.2.利用死信交换机接收死信（拓展）
<a class=header-anchor href=#212%e5%88%a9%e7%94%a8%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba%e6%8e%a5%e6%94%b6%e6%ad%bb%e4%bf%a1%e6%8b%93%e5%b1%95></a></h3><p>在失败重试策略中，默认的RejectAndDontRequeueRecoverer会在本地重试次数耗尽后，发送reject给RabbitMQ，消息变成死信，被丢弃。</p><p>我们可以给simple.queue添加一个死信交换机，给死信交换机绑定一个队列。这样消息变成死信后也不会丢弃，而是最终投递到死信交换机，路由到与死信交换机绑定的队列。</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237153.png alt=image-20210718174506856></p><p>我们在consumer服务中，定义一组死信交换机、死信队列：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 声明普通的 simple.queue队列，并且为其指定死信交换机：dl.direct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>simpleQueue2</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> QueueBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>durable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;simple.queue&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 指定队列名称，并持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>deadLetterExchange</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dl.direct&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 指定死信交换机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 声明死信交换机 dl.direct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>dlExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dl.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 声明存储死信的队列 dl.queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>dlQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Queue<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dl.queue&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 将死信队列 与 死信交换机绑定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>dlBinding</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>dlQueue<span style=color:#f92672>()).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>dlExchange<span style=color:#f92672>()).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;simple&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样simple.queue中成为死信的消息最终就会交给绑定的死信队列</p><h3 id=213总结>2.1.3.总结
<a class=header-anchor href=#213%e6%80%bb%e7%bb%93></a></h3><p>什么样的消息会成为死信？</p><ul><li>消息被消费者reject或者返回nack</li><li>消息超时未消费</li><li>队列满了</li></ul><p>死信交换机的使用场景是什么？</p><ul><li>如果队列绑定了死信交换机，死信会投递到死信交换机；</li><li>可以利用死信交换机收集所有消费者处理失败的消息（死信），交由人工处理，进一步提高消息队列的可靠性。</li></ul><h2 id=22ttl>2.2.TTL
<a class=header-anchor href=#22ttl></a></h2><p>一个队列中的消息如果TTL结束都未消费，则会变为死信，超时分为两种情况：</p><ul><li>消息所在的队列设置了超时时间</li><li>消息本身设置了超时时间</li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237156.png alt=image-20210718182643311></p><h3 id=221接收超时死信的死信交换机>2.2.1.接收超时死信的死信交换机
<a class=header-anchor href=#221%e6%8e%a5%e6%94%b6%e8%b6%85%e6%97%b6%e6%ad%bb%e4%bf%a1%e7%9a%84%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h3><p>在consumer服务的SpringRabbitListener中，定义一个新的消费者，并且声明死信交换机、死信队列：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RabbitListener</span><span style=color:#f92672>(</span>bindings <span style=color:#f92672>=</span> <span style=color:#a6e22e>@QueueBinding</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> <span style=color:#a6e22e>@Queue</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dl.ttl.queue&#34;</span><span style=color:#f92672>,</span> durable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>    exchange <span style=color:#f92672>=</span> <span style=color:#a6e22e>@Exchange</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dl.ttl.direct&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ttl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>listenDlQueue</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;接收到 dl.ttl.queue的延迟消息：{}&#34;</span><span style=color:#f92672>,</span> msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=222声明一个队列并且指定ttl>2.2.2.声明一个队列，并且指定TTL
<a class=header-anchor href=#222%e5%a3%b0%e6%98%8e%e4%b8%80%e4%b8%aa%e9%98%9f%e5%88%97%e5%b9%b6%e4%b8%94%e6%8c%87%e5%ae%9attl></a></h3><p>要给队列设置超时时间，需要在声明队列时配置x-message-ttl属性：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>ttlQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> QueueBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>durable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ttl.queue&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 指定队列名称，并持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>ttl</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10000</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 设置队列的超时时间，10秒
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>deadLetterExchange</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dl.ttl.direct&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 指定死信交换机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，这个队列设定了死信交换机为<code>dl.ttl.direct</code></p><p>声明交换机，将ttl与交换机<strong>绑定</strong>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>ttlExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ttl.direct&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>ttlBinding</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>ttlQueue<span style=color:#f92672>()).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>ttlExchange<span style=color:#f92672>()).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ttl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至此就实现了一个延迟消息队列，内部消息先走到ttl.direct，之后延迟10s之后交给死信队列，监听死信队列的消费者就可以收到消息，看到的效果就是消费者的消息被延迟了</p><p>发送消息，但是不要指定TTL，此时消息就会按照队列的超时时间过期：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testTTLQueue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello, ttl queue&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 消息ID，需要封装到CorrelationData中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CorrelationData correlationData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorrelationData<span style=color:#f92672>(</span>UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rabbitTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>convertAndSend</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ttl.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ttl&#34;</span><span style=color:#f92672>,</span> message<span style=color:#f92672>,</span> correlationData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;发送消息成功&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>发送消息的日志：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237157.png alt=image-20210718191657478></p><p>查看下接收消息的日志：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237158.png alt=image-20210718191738706></p><p>因为队列的TTL值是10000ms，也就是10秒。可以看到消息发送与接收之间的时差刚好是10秒。这就相当于实现了延迟消息</p><h3 id=223发送消息时设定ttl>2.2.3.发送消息时，设定TTL
<a class=header-anchor href=#223%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af%e6%97%b6%e8%ae%be%e5%ae%9attl></a></h3><p>在发送消息时，也可以指定TTL：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testTTLMsg</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Message message <span style=color:#f92672>=</span> MessageBuilder
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello, ttl message&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setExpiration</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;5000&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 消息ID，需要封装到CorrelationData中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CorrelationData correlationData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorrelationData<span style=color:#f92672>(</span>UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rabbitTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>convertAndSend</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ttl.direct&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ttl&#34;</span><span style=color:#f92672>,</span> message<span style=color:#f92672>,</span> correlationData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;发送消息成功&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>查看发送消息日志：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237159.png alt=image-20210718191939140></p><p>接收消息日志：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237160.png alt=image-20210718192004662></p><p>这次，发送与接收的延迟只有5秒。说明当<strong>队列、消息都设置了TTL</strong>时，任意一个到期就会成为死信。也就是谁先到期消息就成为死信，延迟消息的延迟时间由较小的决定</p><h3 id=224总结>2.2.4.总结
<a class=header-anchor href=#224%e6%80%bb%e7%bb%93></a></h3><p>消息超时的两种方式是？</p><ul><li>给队列设置ttl属性，进入队列后超过ttl时间的消息<strong>变为死信</strong></li><li>给消息设置ttl属性，队列接收到消息超过ttl时间后<strong>变为死信</strong></li></ul><p>如何实现发送一个消息20秒后消费者才收到消息？</p><ul><li>给消息的目标队列指定死信交换机</li><li>将消费者监听的队列绑定到死信交换机</li><li>发送消息时给消息设置超时时间为20秒</li><li>20秒超时之后，死信自动进入死信队列</li><li>监听死信队列的消费者就可以收到延迟消息</li></ul><h2 id=23延迟队列>2.3.延迟队列
<a class=header-anchor href=#23%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97></a></h2><p><strong>利用TTL结合死信交换机</strong>，我们实现了消息发出后，消费者延迟收到消息的效果。这种消息模式就称为延迟队列（Delay Queue）模式。</p><p>延迟队列的使用场景包括：</p><ul><li>延迟发送短信</li><li>用户下单，如果用户在15 分钟内未支付，则自动取消</li><li>预约工作会议，20分钟后自动通知所有参会人员</li></ul><p>因为延迟队列的需求非常多，所以RabbitMQ的官方也推出了一个插件，原生支持延迟队列效果。</p><p>这个插件就是DelayExchange插件。参考RabbitMQ的插件列表页面：https://www.rabbitmq.com/community-plugins.html</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237161.png alt=image-20210718192529342></p><p>使用方式可以参考官网地址：https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq</p><h3 id=231delayexchange原理>2.3.1.DelayExchange原理
<a class=header-anchor href=#231delayexchange%e5%8e%9f%e7%90%86></a></h3><p>DelayExchange需要将一个交换机声明为delayed类型。当我们发送消息到delayExchange时，流程如下：</p><ul><li>接收消息</li><li>判断消息是否具备x-delay属性</li><li>如果有x-delay属性，说明是<strong>延迟消息</strong>，持久化到硬盘，读取x-delay值，作为延迟时间</li><li>返回routing not found结果给消息发送者</li><li>x-delay时间<strong>到期后</strong>，重新投递消息到指定队列</li></ul><h3 id=232使用delayexchange>2.3.2.使用DelayExchange
<a class=header-anchor href=#232%e4%bd%bf%e7%94%a8delayexchange></a></h3><p>插件的使用也非常简单：声明一个交换机，交换机的类型可以是任意类型，只需要设定delayed属性为true即可，然后声明队列与其绑定即可。</p><h4 id=1声明delayexchange交换机>1）声明DelayExchange交换机
<a class=header-anchor href=#1%e5%a3%b0%e6%98%8edelayexchange%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h4><p>基于注解方式（推荐），消费者直接绑定延迟交换机和队列：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237163.png alt=image-20210718193747649></p><p><strong>也可以基于@Bean</strong>的方式：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237164.png alt=image-20210718193831076></p><h4 id=2发送消息>2）发送消息
<a class=header-anchor href=#2%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af></a></h4><p>发送消息时，一定要携带x-delay属性，<strong>指定延迟的时间</strong>：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237165.png alt=image-20210718193917009></p><h3 id=233总结>2.3.3.总结
<a class=header-anchor href=#233%e6%80%bb%e7%bb%93></a></h3><p>延迟队列插件的使用步骤包括哪些？</p><p>•声明一个交换机，添加delayed属性为true</p><p>•发送消息时，添加x-delay头，值为延迟时间，此时就只能给消息设置延迟时间，时间到达之后再放入队列中，在队列中是立即读取的，看起来的效果就是收到了延迟消息，内部只不过将消息从交换机到队列的事件延迟了</p><h1 id=3惰性队列>3.惰性队列
<a class=header-anchor href=#3%e6%83%b0%e6%80%a7%e9%98%9f%e5%88%97></a></h1><h2 id=31消息堆积问题>3.1.消息堆积问题
<a class=header-anchor href=#31%e6%b6%88%e6%81%af%e5%a0%86%e7%a7%af%e9%97%ae%e9%a2%98></a></h2><p>当生产者发送消息的<strong>速度超过</strong>了消费者处理消息的速度，就会导致队列中的消息堆积，直到队列存储消息达到上限。之后发送的消息就会成为死信，可能会被丢弃，这就是消息堆积问题。同时消息堆积的足够多时，内存的利用率就会变低</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237166.png alt=image-20210718194040498 style=zoom:33%><p>解决消息堆积有两种思路：</p><ul><li>增加更多消费者，提高消费速度。也就是我们之前说的<code>work queue</code>模式</li><li>扩大队列容积，提高堆积上限</li></ul><p>要提升队列容积，把消息保存在内存中显然是不行的。所以惰性队列是将消息存放到磁盘中，这样就可以存储上百万条的消息</p><h2 id=32惰性队列>3.2.惰性队列
<a class=header-anchor href=#32%e6%83%b0%e6%80%a7%e9%98%9f%e5%88%97></a></h2><p>从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的概念，也就是惰性队列。惰性队列的特征如下：</p><ul><li><strong>接收到消息后直接存入磁盘</strong>而非内存</li><li>消费者要消费消息时才会从磁盘中读取并加载到内存</li><li>支持数百万条的消息存储</li></ul><h3 id=321基于命令行设置lazy-queue>3.2.1.基于命令行设置lazy-queue
<a class=header-anchor href=#321%e5%9f%ba%e4%ba%8e%e5%91%bd%e4%bb%a4%e8%a1%8c%e8%ae%be%e7%bd%aelazy-queue></a></h3><p>而要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。可以通过命令行将一个运行中的队列修改为惰性队列：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>rabbitmqctl set_policy Lazy <span style=color:#e6db74>&#34;^lazy-queue</span>$<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#39;{&#34;queue-mode&#34;:&#34;lazy&#34;}&#39;</span> --apply-to queues  
</span></span></code></pre></td></tr></table></div></div><p>命令解读：</p><ul><li><code>rabbitmqctl</code> ：RabbitMQ的命令行工具</li><li><code>set_policy</code> ：添加一个策略</li><li><code>Lazy</code> ：策略名称，可以自定义</li><li><code>"^lazy-queue$"</code> ：用正则表达式匹配队列的名字</li><li><code>'{"queue-mode":"lazy"}'</code> ：设置队列模式为lazy模式</li><li><code>--apply-to queues </code>：策略的作用对象，是所有的队列</li></ul><h3 id=322基于bean声明lazy-queue>3.2.2.基于@Bean声明lazy-queue
<a class=header-anchor href=#322%e5%9f%ba%e4%ba%8ebean%e5%a3%b0%e6%98%8elazy-queue></a></h3><p>使用@Bean声明一个队列的时候，可以指定其为惰性队列</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237167.png alt=image-20210718194522223></p><h3 id=323基于rabbitlistener声明lazyqueue>3.2.3.基于@RabbitListener声明LazyQueue
<a class=header-anchor href=#323%e5%9f%ba%e4%ba%8erabbitlistener%e5%a3%b0%e6%98%8elazyqueue></a></h3><p>在消费者上绑定队列和交换机时，可以声明队列为惰性队列</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237168.png alt=image-20210718194539054></p><h3 id=33总结>3.3.总结
<a class=header-anchor href=#33%e6%80%bb%e7%bb%93></a></h3><p>消息堆积问题的解决方案？</p><ul><li>队列上绑定多个消费者，提高消费速度</li><li>使用惰性队列，可以再mq中保存更多消息</li></ul><p>惰性队列的优点有哪些？</p><ul><li>基于磁盘存储，消息上限高</li><li>没有间歇性的page-out，性能比较稳定</li></ul><p>惰性队列的缺点有哪些？</p><ul><li>基于磁盘存储，消息时效性会降低</li><li>性能受限于磁盘的IO</li></ul><h1 id=4mq集群>4.MQ集群
<a class=header-anchor href=#4mq%e9%9b%86%e7%be%a4></a></h1><h2 id=41集群分类>4.1.集群分类
<a class=header-anchor href=#41%e9%9b%86%e7%be%a4%e5%88%86%e7%b1%bb></a></h2><p>RabbitMQ的是基于Erlang语言编写，而Erlang又是一个面向<strong>并发</strong>的语言，天然支持集群模式。RabbitMQ的集群有两种模式：</p><p>•<strong>普通集群</strong>：是一种分布式集群，将队列分散到集群的各个节点，从而提高整个集群的<strong>并发</strong>能力。</p><p>•<strong>镜像集群</strong>：是一种主从集群，普通集群的基础上，添加了主从备份功能，提高集群的数据<strong>可用性</strong>。</p><p>镜像集群虽然支持主从，但主从同步并<strong>不是强一致</strong>的，某些情况下可能有数据丢失的风险。因此在RabbitMQ的3.8版本以后，推出了新的功能：<strong>仲裁队列</strong>来代替镜像集群，底层采用Raft协议确保主从的数据一致性。</p><h2 id=42普通集群>4.2.普通集群
<a class=header-anchor href=#42%e6%99%ae%e9%80%9a%e9%9b%86%e7%be%a4></a></h2><h3 id=421集群结构和特征>4.2.1.集群结构和特征
<a class=header-anchor href=#421%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%92%8c%e7%89%b9%e5%be%81></a></h3><p>普通集群，或者叫标准集群（classic cluster），具备下列特征：</p><ul><li>会在集群的各个节点间<strong>共享部分数据</strong>，包括：交换机、队列元信息。不包含队列中的消息。</li><li>当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回，这是因为节点之间共享元信息，所以就知道最终访问哪个 节点</li><li>队列所在节点宕机，队列中的消息就会丢失</li></ul><p>结构如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237169.png alt=image-20210718220843323 style=zoom:50%><h2 id=43镜像集群>4.3.镜像集群
<a class=header-anchor href=#43%e9%95%9c%e5%83%8f%e9%9b%86%e7%be%a4></a></h2><h3 id=431集群结构和特征>4.3.1.集群结构和特征
<a class=header-anchor href=#431%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%92%8c%e7%89%b9%e5%be%81></a></h3><p>镜像集群：本质是<strong>主从模式</strong>，具备下面的特征：</p><ul><li>交换机、队列、队列中的消息会在各个mq的镜像节点之间<strong>操作系统</strong>。</li><li>创建队列的节点被称为该队列的<strong>主节点，<strong>备份到的其它节点叫做该队列的</strong>镜像</strong>节点。</li><li>一个队列的主节点可能是另一个队列的镜像节点</li><li>所有操作都是主节点完成，然后同步给镜像节点</li><li>主宕机后，镜像节点会替代成新的主</li></ul><p>结构如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403161237170.png alt=image-20210718221039542 style=zoom:50%><h2 id=44仲裁队列>4.4.仲裁队列
<a class=header-anchor href=#44%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97></a></h2><h3 id=441集群特征>4.4.1.集群特征
<a class=header-anchor href=#441%e9%9b%86%e7%be%a4%e7%89%b9%e5%be%81></a></h3><p>仲裁队列：仲裁队列是3.8版本以后才有的<strong>新功能</strong>，用来替代镜像队列，具备下列特征：</p><ul><li>与镜像队列一样，都是主从模式，支持主从数据同步</li><li>使用非常简单，没有复杂的配置</li><li><strong>主从同步</strong>基于Raft协议，<strong>强一致</strong></li></ul><h3 id=442java代码创建仲裁队列>4.4.2.Java代码创建仲裁队列
<a class=header-anchor href=#442java%e4%bb%a3%e7%a0%81%e5%88%9b%e5%bb%ba%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97></a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>quorumQueue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> QueueBuilder
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>durable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;quorum.queue&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>quorum</span><span style=color:#f92672>()</span> <span style=color:#75715e>// 仲裁队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=443springamqp连接mq集群>4.4.3.SpringAMQP连接MQ集群
<a class=header-anchor href=#443springamqp%e8%bf%9e%e6%8e%a5mq%e9%9b%86%e7%be%a4></a></h3><p>注意，这里用address来代替host、port方式</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>spring:
</span></span><span style=display:flex><span>  rabbitmq<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    addresses<span style=color:#f92672>:</span> <span style=color:#ae81ff>192.168.150.105</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8071</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>192.168.150.105</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8072</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>192.168.150.105</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8073</span>
</span></span><span style=display:flex><span>    username<span style=color:#f92672>:</span> itcast
</span></span><span style=display:flex><span>    password<span style=color:#f92672>:</span> <span style=color:#ae81ff>123321</span>
</span></span><span style=display:flex><span>    virtual<span style=color:#f92672>-</span>host<span style=color:#f92672>:</span> <span style=color:#f92672>/</span>
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1>微服务</a>
<a href=/tags/rabbitmq>RabbitMQ</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/%E7%94%9F%E6%88%90%E7%89%B9%E6%AE%8A%E6%95%B0%E5%AD%97%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C/ rel=next title=生成特殊数字的最少操作><i class="fa fa-chevron-left"></i> 生成特殊数字的最少操作</a></div><div class="post-nav-prev post-nav-item"><a href=/post/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/ rel=prev title=多级缓存>多级缓存
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>zzzi提供技术支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zzzicode.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":null,"views":null},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"right","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0e26367f0461fb41ac6f947dc2af3620375dc44aa8945e6c2b1480d342c65d1.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>