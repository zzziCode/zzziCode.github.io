<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.111.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon_next.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon_next.png><meta itemprop=name content="Elasticsearch学习笔记3"><meta itemprop=description content="elasticsearch学习笔记3"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zzzicode.github.io/imgs/avatar.png"><meta itemprop=keywords content="微服务,elasticsearch"><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch学习笔记3"><meta property="og:description" content="elasticsearch学习笔记3"><meta property="og:image" content="/imgs/avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B03/"><meta property="og:site_name" content="zzzi的小站"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="zzzi"><meta property="article:published_time" content="2024-03-05 20:44:59 +0800 CST"><meta property="article:modified_time" content="2024-03-05 20:44:59 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.4b7f3d9c4ef8db1505229a7dcd2c4e3ab17cd4960dd8a78b503c013770ad56a6.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B03","permalink":"https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B03/","title":"Elasticsearch学习笔记3"}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Elasticsearch学习笔记3 - zzzi的小站</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>zzzi的小站</h1><i class=logo-line></i></a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>222</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#11聚合的种类>1.1.聚合的种类</a></li><li><a href=#12dsl实现聚合>1.2.DSL实现聚合</a><ul><li><a href=#121bucket聚合语法>1.2.1.Bucket聚合语法</a></li><li><a href=#122聚合结果排序>1.2.2.聚合结果排序</a></li><li><a href=#123限定聚合范围>1.2.3.限定聚合范围</a></li><li><a href=#124metric聚合语法>1.2.4.Metric聚合语法</a></li><li><a href=#125小结>1.2.5.小结</a></li></ul></li><li><a href=#13restapi实现聚合>1.3.RestAPI实现聚合</a><ul><li><a href=#131api语法>1.3.1.API语法</a></li><li><a href=#132业务需求>1.3.2.业务需求</a></li><li><a href=#133业务实现>1.3.3.业务实现</a></li></ul></li></ul><ul><li><a href=#21拼音分词器>2.1.拼音分词器</a></li><li><a href=#22自定义分词器>2.2.自定义分词器</a></li><li><a href=#23自动补全查询>2.3.自动补全查询</a></li><li><a href=#24实现酒店搜索框自动补全>2.4.实现酒店搜索框自动补全</a><ul><li><a href=#241修改酒店映射结构>2.4.1.修改酒店映射结构</a></li><li><a href=#242修改hoteldoc实体>2.4.2.修改HotelDoc实体</a></li><li><a href=#243重新导入>2.4.3.重新导入</a></li><li><a href=#244自动补全查询的javaapi>2.4.4.自动补全查询的JavaAPI</a></li><li><a href=#245实现搜索框自动补全>2.4.5.实现搜索框自动补全</a></li></ul></li><li><a href=#25-总结>2.5. 总结</a></li></ul><ul><li><a href=#31思路分析>3.1.思路分析</a><ul><li><a href=#311同步调用>3.1.1.同步调用</a></li><li><a href=#312异步通知>3.1.2.异步通知</a></li><li><a href=#313监听binlog>3.1.3.监听binlog</a></li><li><a href=#314选择>3.1.4.选择</a></li></ul></li><li><a href=#32实现数据同步>3.2.实现数据同步</a><ul><li><a href=#321思路>3.2.1.思路</a></li><li><a href=#322导入demo>3.2.2.导入demo</a></li><li><a href=#323声明交换机队列>3.2.3.声明交换机、队列</a><ul><li><a href=#1引入依赖>1）引入依赖</a></li><li><a href=#2声明队列交换机名称>2）声明队列交换机名称</a></li><li><a href=#3声明队列交换机>3）声明队列交换机</a></li></ul></li><li><a href=#324发送mq消息>3.2.4.发送MQ消息</a></li><li><a href=#325接收mq消息>3.2.5.接收MQ消息</a></li></ul></li></ul><ul><li><a href=#41搭建es集群>4.1.搭建ES集群</a></li><li><a href=#42集群脑裂问题>4.2.集群脑裂问题</a><ul><li><a href=#421集群职责划分>4.2.1.集群职责划分</a></li><li><a href=#422脑裂问题>4.2.2.脑裂问题</a></li><li><a href=#423小结>4.2.3.小结</a></li></ul></li><li><a href=#43集群分布式存储>4.3.集群分布式存储</a><ul><li><a href=#431分片存储测试>4.3.1.分片存储测试</a></li><li><a href=#432分片存储原理>4.3.2.分片存储原理</a></li></ul></li><li><a href=#44集群分布式查询>4.4.集群分布式查询</a></li><li><a href=#45集群故障转移>4.5.集群故障转移</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=zzzi src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.png><p class=site-author-name itemprop=name>zzzi</p><div class=site-description itemprop=description>make_tuple("工作","论文")</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>222</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>50</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zzziCode title="Github → https://github.com/zzziCode" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zzzicode.github.io/post/elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B03/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.png"><meta itemprop=name content="zzzi"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="zzzi"><meta itemprop=description content="make_tuple(&#34;工作&#34;,&#34;论文&#34;)"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Elasticsearch学习笔记3"><meta itemprop=description content="elasticsearch学习笔记3"></span><header class=post-header><h1 class=post-title itemprop="name headline">Elasticsearch学习笔记3</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2024-03-05 20:44:59 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-03-05 20:44:59 +0800 CST">2024-03-05</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0 itemprop=url rel=index><span itemprop=name>学习笔记</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>10969</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>22分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>🖐️ elasticsearch学习笔记3</p></blockquote><p>本节中主要是延续前两节笔记中的内容继续介绍elasticsearch中的剩余内容，主要包含数据聚合，elasticsearch搜索时自动补全，elasticsearch集群之间的数据同步等知识</p><h1 id=1数据聚合>1.数据聚合
<a class=header-anchor href=#1%e6%95%b0%e6%8d%ae%e8%81%9a%e5%90%88></a></h1><p>**
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html title=聚合（ rel="noopener external nofollow noreferrer" target=_blank class=exturl>聚合（
<i class="fa fa-external-link-alt"></i></a>
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html title=aggregations rel="noopener external nofollow noreferrer" target=_blank class=exturl>aggregations
<i class="fa fa-external-link-alt"></i></a>
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html title=） rel="noopener external nofollow noreferrer" target=_blank class=exturl>）
<i class="fa fa-external-link-alt"></i>
</a>**可以让我们极其方便的实现对数据的统计、分析、运算。例如计数、求和、平均值、最小值、最大值、分组等，并且可以适用于下面几种情况：</p><ul><li>什么品牌的手机最受欢迎？</li><li>这些手机的平均价格、最高价格、最低价格？</li><li>这些手机每月的销售情况如何？</li></ul><p>实现这些统计功能比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p><h2 id=11聚合的种类>1.1.聚合的种类
<a class=header-anchor href=#11%e8%81%9a%e5%90%88%e7%9a%84%e7%a7%8d%e7%b1%bb></a></h2><p>聚合常见的有三类：</p><ul><li><p>**桶（Bucket）**聚合：用来对文档做分组</p><ul><li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li><li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li></ul></li><li><p>**度量（Metric）**聚合：用以计算一些值，比如：最大值、最小值、平均值等</p><ul><li>Avg：求平均值</li><li>Max：求最大值</li><li>Min：求最小值</li><li>Stats：同时求max、min、avg、sum等</li></ul></li><li><p>**管道（pipeline）**聚合：其它聚合的结果为基础做聚合</p></li></ul><blockquote><p>**注意：**参加聚合的字段必须是keyword、日期、数值、布尔类型</p></blockquote><h2 id=12dsl实现聚合>1.2.DSL实现聚合
<a class=header-anchor href=#12dsl%e5%ae%9e%e7%8e%b0%e8%81%9a%e5%90%88></a></h2><p>现在，我们要统计所有数据中每个酒店品牌旗下有多少酒店，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p><h3 id=121bucket聚合语法>1.2.1.Bucket聚合语法
<a class=header-anchor href=#121bucket%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95></a></h3><p>语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010>  </span><span style=color:#75715e>// 设置size为0，结果中不包含文档，只包含聚合结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;aggs&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 定义聚合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;brandAgg&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>//给聚合起个名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;terms&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 聚合的类型，按照品牌值聚合，所以选择term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;brand&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 参与聚合的字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 希望获取的聚合结果数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>结果如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044468.png alt=image-20210723171948228 style=zoom:50%><h3 id=122聚合结果排序>1.2.2.聚合结果排序
<a class=header-anchor href=#122%e8%81%9a%e5%90%88%e7%bb%93%e6%9e%9c%e6%8e%92%e5%ba%8f></a></h3><p>默认情况下，Bucket聚合会统计Bucket内的文档数量，符合桶要求的文档都会放入桶中，记为_count，并且按照_count降序排序。</p><p>我们可以指定order属性，自定义聚合的排序方式：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;aggs&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;brandAgg&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;terms&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;brand&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;order&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;_count&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;asc&#34;</span> <span style=color:#75715e>// 按照_count升序排列，也就是按照桶中文档的数量升序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=123限定聚合范围>1.2.3.限定聚合范围
<a class=header-anchor href=#123%e9%99%90%e5%ae%9a%e8%81%9a%e5%90%88%e8%8c%83%e5%9b%b4></a></h3><p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p><p>我们可以限定要聚合的文档范围，只要添加query条件即可，下面的DSL语句代表的是每个酒店品牌旗下价格小于200的酒店有多少：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;range&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;price&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;lte&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>200</span> <span style=color:#75715e>// 只对200元以下的文档聚合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;aggs&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;brandAgg&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;terms&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;brand&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这次，聚合得到的品牌明显变少了：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044470.png alt=image-20210723172404836 style=zoom:50%><h3 id=124metric聚合语法>1.2.4.Metric聚合语法
<a class=header-anchor href=#124metric%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95></a></h3><p>上节课，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的min、max、avg等值。</p><p>这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。</p><p>语法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /hotel/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;aggs&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;brandAgg&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;terms&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;brand&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;aggs&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 是brands聚合的子聚合，也就是分组后对每组分别计算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;score_stats&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 聚合名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;stats&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 聚合类型，这里stats可以计算min、max、avg等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>              <span style=color:#75715e>//这些数据会一起被计算出来
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>            </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;score&#34;</span><span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 聚合字段，这里是score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p><p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044471.png alt=image-20210723172917636 style=zoom:50%><h3 id=125小结>1.2.5.小结
<a class=header-anchor href=#125%e5%b0%8f%e7%bb%93></a></h3><p>aggs代表聚合，与query同级，此时query的作用是？</p><ul><li>限定聚合的的文档范围，使得被聚合的文档不是索引库中的全部文档</li></ul><p>聚合必须的三要素：</p><ul><li>聚合名称</li><li>聚合类型</li><li>聚合字段</li></ul><p>聚合可配置属性有：</p><ul><li>size：指定聚合结果数量</li><li>order：指定聚合结果排序方式</li><li>field：指定聚合字段</li></ul><h2 id=13restapi实现聚合>1.3.RestAPI实现聚合
<a class=header-anchor href=#13restapi%e5%ae%9e%e7%8e%b0%e8%81%9a%e5%90%88></a></h2><h3 id=131api语法>1.3.1.API语法
<a class=header-anchor href=#131api%e8%af%ad%e6%b3%95></a></h3><p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p><p>聚合条件的语法：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044472.png alt=image-20210723173057733 style=zoom:33%><p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044474.png alt=image-20210723173215728 style=zoom:33%><h3 id=132业务需求>1.3.2.业务需求
<a class=header-anchor href=#132%e4%b8%9a%e5%8a%a1%e9%9c%80%e6%b1%82></a></h3><p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044475.png alt=image-20210723192605566 style=zoom:53%><p>分析：</p><p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。</p><p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p><p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p><p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p><p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p><p>因为是对搜索结果聚合，因此聚合是<strong>限定范围的聚合</strong>，也就是说聚合的限定条件跟搜索文档的条件一致。</p><p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044476.png alt=image-20210723193730799></p><p>请求<strong>参数与搜索文档的参数完全一致</strong>。</p><p>返回值类型就是页面要展示的最终结果：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044477.png alt=image-20210723203915982></p><p>结果是一个Map结构：</p><ul><li>key是字符串，城市、星级、品牌、价格</li><li>value是集合，例如多个城市的名称</li></ul><h3 id=133业务实现>1.3.3.业务实现
<a class=header-anchor href=#133%e4%b8%9a%e5%8a%a1%e5%ae%9e%e7%8e%b0></a></h3><p>在<code>cn.itcast.hotel.web</code>包的<code>HotelController</code>中添加一个方法，遵循下面的要求：</p><ul><li>请求方式：<code>POST</code></li><li>请求路径：<code>/hotel/filters</code></li><li>请求参数：<code>RequestParams</code>，与搜索文档的参数一致</li><li>返回值类型：<code>Map&lt;String, List&lt;String>></code></li></ul><p>代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;filters&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>getFilters</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> RequestParams params<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> hotelService<span style=color:#f92672>.</span><span style=color:#a6e22e>getFilters</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里调用了IHotelService中的getFilters方法，尚未实现。</p><p>在<code>cn.itcast.hotel.service.IHotelService</code>中定义新方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>filters</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>filters</span><span style=color:#f92672>(</span>RequestParams params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 2.1.query，根据传递而来的参数筛选索引库中的文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        buildBasicQuery<span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.2.设置size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.3.聚合，将筛选过后的文档进行聚合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        buildAggregation<span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.发出请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.解析结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        Aggregations aggregations <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getAggregations</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.1.根据品牌名称，获取品牌结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> brandList <span style=color:#f92672>=</span> getAggByName<span style=color:#f92672>(</span>aggregations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;brandAgg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;品牌&#34;</span><span style=color:#f92672>,</span> brandList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.2.根据品牌名称，获取品牌结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> cityList <span style=color:#f92672>=</span> getAggByName<span style=color:#f92672>(</span>aggregations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;cityAgg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;城市&#34;</span><span style=color:#f92672>,</span> cityList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.3.根据品牌名称，获取品牌结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> starList <span style=color:#f92672>=</span> getAggByName<span style=color:#f92672>(</span>aggregations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;starAgg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;星级&#34;</span><span style=color:#f92672>,</span> starList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//依次对筛选过后的文档的三个字段做聚合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>buildAggregation</span><span style=color:#f92672>(</span>SearchRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>aggregation</span><span style=color:#f92672>(</span>AggregationBuilders
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>terms</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;brandAgg&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>field</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;brand&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>100</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>aggregation</span><span style=color:#f92672>(</span>AggregationBuilders
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>terms</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cityAgg&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>field</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;city&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>100</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>aggregation</span><span style=color:#f92672>(</span>AggregationBuilders
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>terms</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;starAgg&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>field</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;starName&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>100</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAggByName</span><span style=color:#f92672>(</span>Aggregations aggregations<span style=color:#f92672>,</span> String aggName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.1.根据聚合名称获取聚合结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Terms brandTerms <span style=color:#f92672>=</span> aggregations<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>aggName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.2.获取buckets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Terms<span style=color:#f92672>.</span><span style=color:#a6e22e>Bucket</span><span style=color:#f92672>&gt;</span> buckets <span style=color:#f92672>=</span> brandTerms<span style=color:#f92672>.</span><span style=color:#a6e22e>getBuckets</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4.3.遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> brandList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Terms<span style=color:#f92672>.</span><span style=color:#a6e22e>Bucket</span> bucket <span style=color:#f92672>:</span> buckets<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.4.获取key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String key <span style=color:#f92672>=</span> bucket<span style=color:#f92672>.</span><span style=color:#a6e22e>getKeyAsString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        brandList<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> brandList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>实现的逻辑就是先根据用户输入的查询参数将索引库中的文档筛选一遍，然后根据筛选得到的文档进一步进行聚合，得到这些文档中有哪些城市，星级，品牌，相当于这些数据变成了动态的</p><h1 id=2自动补全>2.自动补全
<a class=header-anchor href=#2%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8></a></h1><p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044478.png alt=image-20210723204936367 style=zoom:50%><p>这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。</p><p>因为需要根据拼音字母来推断，因此要用到拼音分词功能。</p><h2 id=21拼音分词器>2.1.拼音分词器
<a class=header-anchor href=#21%e6%8b%bc%e9%9f%b3%e5%88%86%e8%af%8d%e5%99%a8></a></h2><p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：https://github.com/medcl/elasticsearch-analysis-pinyin</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044479.png alt=image-20210723205932746 style=zoom:33%><p>安装拼音分词器到elasticsearch中之后，测试用法如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST /_analyze</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;text&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;如家酒店还不错&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;analyzer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;pinyin&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>结果：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044482.png alt=image-20210723210126506></p><h2 id=22自定义分词器>2.2.自定义分词器
<a class=header-anchor href=#22%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%86%e8%af%8d%e5%99%a8></a></h2><p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p><p>elasticsearch中分词器（analyzer）的组成包含三部分：</p><ul><li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</li><li>tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart</li><li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li></ul><p>文档分词时会依次由这三部分来处理文档：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044483.png alt=image-20210723210427878 style=zoom:50%><p>声明自定义分词器的语法如下，自定义时主要就是修改分词器的三部分组成：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>PUT /test</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;settings&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;analysis&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;analyzer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 自定义分词器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;my_analyzer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010>  </span><span style=color:#75715e>// 分词器名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;tokenizer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;ik_max_word&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;filter&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;py&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;filter&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 自定义tokenizer filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;py&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 过滤器名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;pinyin&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 过滤器类型，这里是pinyin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		  <span style=color:#f92672>&#34;keep_full_pinyin&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;keep_joined_full_pinyin&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;keep_original&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;limit_first_letter_length&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>16</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;remove_duplicated_term&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          </span><span style=color:#f92672>&#34;none_chinese_pinyin_tokenize&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>},
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;mappings&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;properties&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;analyzer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;my_analyzer&#34;</span>,<span style=color:#75715e>//字段选择分词器时，指定为自定义的分词器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;search_analyzer&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;ik_smart&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>这里的analyzer代表文档存储到索引库中时用到的分词器，每一个文档可能有多个字段需要分词存储，之后在搜索时根据分词结果来匹配文档，而search_analyzer是在搜索文档是使用的分词器，不会影响文档的存储</p></blockquote><p>测试：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044484.png alt=image-20210723211829150 style=zoom:50%><blockquote><p>根据搜索条件分词之后，如果输入的是汉字，那么就按照汉字匹配，如果输入的是拼音，就按照拼音匹配，因为文档存储时使用的是自定义的分词器，既会出现汉字，又会出现拼音</p></blockquote><p>总结：</p><p>如何使用拼音分词器？</p><ul><li><p>①下载pinyin分词器</p></li><li><p>②解压并放到elasticsearch的plugin目录</p></li><li><p>③重启即可</p></li></ul><p>如何自定义分词器？</p><ul><li><p>①创建索引库时，在settings中配置，可以包含三部分</p></li><li><p>②character filter</p></li><li><p>③tokenizer</p></li><li><p>④filter</p></li></ul><p>拼音分词器注意事项？</p><ul><li>为了避免搜索到同音字，搜索时不要使用拼音分词器</li></ul><h2 id=23自动补全查询>2.3.自动补全查询
<a class=header-anchor href=#23%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e6%9f%a5%e8%af%a2></a></h2><p>elasticsearch提供了
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html title="Completion Suggester" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Completion Suggester
<i class="fa fa-external-link-alt"></i>
</a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p><ul><li><p>参与补全查询的字段必须是completion类型。</p></li><li><p>字段的内容一般是用来补全的多个词条形成的数组。</p></li></ul><p>比如，一个这样的索引库：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// 创建索引库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>PUT test</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;mappings&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;properties&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;title&#34;</span>:{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;completion&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后插入下面的数据：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// 示例数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>POST test/_doc</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;title&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#e6db74>&#34;Sony&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;WH-1000XM3&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST test/_doc</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;title&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#e6db74>&#34;SK-II&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;PITERA&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST test/_doc</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;title&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>[<span style=color:#e6db74>&#34;Nintendo&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;switch&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>查询的DSL语句如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// 自动补全查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>GET /test/_search</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span><span style=color:#f92672>&#34;suggest&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#f92672>&#34;title_suggest&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;text&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;s&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span><span style=color:#f92672>&#34;completion&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;field&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#e6db74>&#34;title&#34;</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 补全查询的字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;skip_duplicates&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#66d9ef>true</span>,<span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 跳过重复的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>        </span><span style=color:#f92672>&#34;size&#34;</span>:<span style=color:#960050;background-color:#1e0010> </span><span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010> </span><span style=color:#75715e>// 获取前10条结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>      </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  </span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>之后就可以查询出title中带s的所有文档</p><h2 id=24实现酒店搜索框自动补全>2.4.实现酒店搜索框自动补全
<a class=header-anchor href=#24%e5%ae%9e%e7%8e%b0%e9%85%92%e5%ba%97%e6%90%9c%e7%b4%a2%e6%a1%86%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8></a></h2><p>现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。</p><p>另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。</p><p>因此，总结一下，我们需要做的事情包括：</p><ol><li><p>修改hotel索引库结构，设置自定义拼音分词器</p></li><li><p>修改索引库的name、all字段，使用自定义分词器</p></li><li><p>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器</p></li><li><p>给HotelDoc类添加suggestion字段，内容包含brand、business，之后搜索时，就会自动提示这两个字段中的内容</p></li><li><p>重新导入数据到hotel库</p></li></ol><h3 id=241修改酒店映射结构>2.4.1.修改酒店映射结构
<a class=header-anchor href=#241%e4%bf%ae%e6%94%b9%e9%85%92%e5%ba%97%e6%98%a0%e5%b0%84%e7%bb%93%e6%9e%84></a></h3><p>代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// 酒店数据索引库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>PUT</span> <span style=color:#960050;background-color:#1e0010>/hotel</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;analysis&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;analyzer&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;text_anlyzer&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;tokenizer&#34;</span>: <span style=color:#e6db74>&#34;ik_max_word&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;filter&#34;</span>: <span style=color:#e6db74>&#34;py&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;completion_analyzer&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;tokenizer&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;filter&#34;</span>: <span style=color:#e6db74>&#34;py&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filter&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;py&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;pinyin&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;keep_full_pinyin&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;keep_joined_full_pinyin&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;keep_original&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;limit_first_letter_length&#34;</span>: <span style=color:#ae81ff>16</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;remove_duplicated_term&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;none_chinese_pinyin_tokenize&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;mappings&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;text_anlyzer&#34;</span>,<span style=color:#75715e>//保存到索引库中时使用自定义分词器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>&#34;search_analyzer&#34;</span>: <span style=color:#e6db74>&#34;ik_smart&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;copy_to&#34;</span>: <span style=color:#e6db74>&#34;all&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;address&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;score&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;brand&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;copy_to&#34;</span>: <span style=color:#e6db74>&#34;all&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;city&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;starName&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;business&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;copy_to&#34;</span>: <span style=color:#e6db74>&#34;all&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;location&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;geo_point&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;pic&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;all&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;text_anlyzer&#34;</span>,<span style=color:#75715e>//保存到索引库中时使用自定义分词器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>&#34;search_analyzer&#34;</span>: <span style=color:#e6db74>&#34;ik_smart&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;suggestion&#34;</span>:{
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;completion&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;completion_analyzer&#34;</span><span style=color:#75715e>//保存到索引库中时使用自定义分词器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=242修改hoteldoc实体>2.4.2.修改HotelDoc实体
<a class=header-anchor href=#242%e4%bf%ae%e6%94%b9hoteldoc%e5%ae%9e%e4%bd%93></a></h3><p>HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。</p><p>因此我们在HotelDoc中添加一个suggestion字段，类型为<code>List&lt;String></code>，然后将brand、city、business等信息放到里面。</p><p>代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.pojo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.Data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.NoArgsConstructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Arrays<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Collections<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HotelDoc</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String address<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer price<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer score<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String brand<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String starName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String business<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String pic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Object distance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Boolean isAD<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> suggestion<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HotelDoc</span><span style=color:#f92672>(</span>Hotel hotel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>address</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getAddress</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>price</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrice</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>score</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getScore</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>brand</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrand</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>city</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getCity</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>starName</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getStarName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>business</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getBusiness</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getLatitude</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, &#34;</span> <span style=color:#f92672>+</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getLongitude</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pic</span> <span style=color:#f92672>=</span> hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getPic</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 组装suggestion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>)){</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// business有多个值，需要切割
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String<span style=color:#f92672>[]</span> arr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 添加元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>suggestion</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>suggestion</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>brand</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>suggestion</span><span style=color:#f92672>,</span> arr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>suggestion</span> <span style=color:#f92672>=</span> Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>asList</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>brand</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=243重新导入>2.4.3.重新导入
<a class=header-anchor href=#243%e9%87%8d%e6%96%b0%e5%af%bc%e5%85%a5></a></h3><p>重新执行之前编写的导入数据功能，可以看到新的酒店数据中包含了suggestion：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044485.png alt=image-20210723213546183 style=zoom:50%><h3 id=244自动补全查询的javaapi>2.4.4.自动补全查询的JavaAPI
<a class=header-anchor href=#244%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e6%9f%a5%e8%af%a2%e7%9a%84javaapi></a></h3><p>之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044486.png alt=image-20210723213759922 style=zoom:33%><p>而自动补全的结果也比较特殊，解析的代码如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044487.png alt=image-20210723213917524 style=zoom:33%><h3 id=245实现搜索框自动补全>2.4.5.实现搜索框自动补全
<a class=header-anchor href=#245%e5%ae%9e%e7%8e%b0%e6%90%9c%e7%b4%a2%e6%a1%86%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8></a></h3><p>查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044488.png alt=image-20210723214021062></p><p>返回值是补全词条的集合，类型为<code>List&lt;String></code></p><p>1）在<code>cn.itcast.hotel.web</code>包下的<code>HotelController</code>中添加新接口，接收新的请求：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;suggestion&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSuggestions</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;key&#34;</span><span style=color:#f92672>)</span> String prefix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hotelService<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuggestions</span><span style=color:#f92672>(</span>prefix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>2）在<code>cn.itcast.hotel.service</code>包下的<code>IhotelService</code>中添加方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSuggestions</span><span style=color:#f92672>(</span>String prefix<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><p>3）在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSuggestions</span><span style=color:#f92672>(</span>String prefix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SearchRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.准备DSL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>().</span><span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SuggestBuilder<span style=color:#f92672>().</span><span style=color:#a6e22e>addSuggestion</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;suggestions&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            SuggestBuilders<span style=color:#f92672>.</span><span style=color:#a6e22e>completionSuggestion</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;suggestion&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>prefix</span><span style=color:#f92672>(</span>prefix<span style=color:#f92672>)</span><span style=color:#75715e>//这里动态接受传递而来的前缀
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>skipDuplicates</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.发起请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SearchResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>search</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.解析结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Suggest suggest <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuggest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.1.根据补全查询名称，获取补全结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CompletionSuggestion suggestions <span style=color:#f92672>=</span> suggest<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuggestion</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;suggestions&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.2.获取options
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>CompletionSuggestion<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Option</span><span style=color:#f92672>&gt;</span> options <span style=color:#f92672>=</span> suggestions<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4.3.遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>options<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>CompletionSuggestion<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Option</span> option <span style=color:#f92672>:</span> options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String text <span style=color:#f92672>=</span> option<span style=color:#f92672>.</span><span style=color:#a6e22e>getText</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            list<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>text<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>相当于输入框中一旦出现条件，那么就会发起请求，后端就会向elasticsearch中发起自动补全的DSL语句，响应得到结果之后，将需要的部分数据解析出来返回给前端，此时前端看到的效果就是自动补全的效果·</p></blockquote><h2 id=25-总结>2.5. 总结
<a class=header-anchor href=#25-%e6%80%bb%e7%bb%93></a></h2><p>想要实现中文或者拼音状态下的自动补全，就需要将索引库进行修改，对于要分词的字段使用自定义的分词器，此时索引库中才能存储汉字和拼音的倒排索引，传递一个自动补全的DSL请求时，elasticsearch根据中文分词器或者拼音分词器将其分词，去索引库中查找倒排索引，自动补全中指定补全什么字段，最终返回的就是什么字段的内容</p><h1 id=3数据同步>3.数据同步
<a class=header-anchor href=#3%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5></a></h1><p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的<strong>数据同步</strong>。</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044489.png alt=image-20210723214758392 style=zoom:33%><h2 id=31思路分析>3.1.思路分析
<a class=header-anchor href=#31%e6%80%9d%e8%b7%af%e5%88%86%e6%9e%90></a></h2><p>常见的数据同步方案有三种：</p><ul><li>同步调用</li><li>异步通知</li><li>监听binlog</li></ul><h3 id=311同步调用>3.1.1.同步调用
<a class=header-anchor href=#311%e5%90%8c%e6%ad%a5%e8%b0%83%e7%94%a8></a></h3><p>方案一：同步调用</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044490.png alt=image-20210723214931869 style=zoom:33%><p>基本步骤如下：</p><ul><li>hotel-demo对外提供接口，用来修改elasticsearch中的数据</li><li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口更新elasticsearch中的数据</li></ul><h3 id=312异步通知>3.1.2.异步通知
<a class=header-anchor href=#312%e5%bc%82%e6%ad%a5%e9%80%9a%e7%9f%a5></a></h3><p>方案二：异步通知</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044491.png alt=image-20210723215140735 style=zoom:33%><p>流程如下：</p><ul><li>hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息</li><li>hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改</li><li>这种方式系统运行的效率更高</li></ul><h3 id=313监听binlog>3.1.3.监听binlog
<a class=header-anchor href=#313%e7%9b%91%e5%90%acbinlog></a></h3><p>方案三：监听binlog</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044492.png alt=image-20210723215518541 style=zoom:33%><p>流程如下：</p><ul><li>给mysql开启binlog功能</li><li>mysql完成增、删、改操作都会记录在binlog中</li><li>hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容</li></ul><h3 id=314选择>3.1.4.选择
<a class=header-anchor href=#314%e9%80%89%e6%8b%a9></a></h3><p>方式一：同步调用</p><ul><li>优点：实现简单，粗暴</li><li>缺点：业务耦合度高</li></ul><p>方式二：异步通知</p><ul><li>优点：低耦合，实现难度一般</li><li>缺点：依赖mq的可靠性</li></ul><p>方式三：监听binlog</p><ul><li>优点：完全解除服务间耦合</li><li>缺点：开启binlog增加数据库负担、实现复杂度高</li></ul><h2 id=32实现数据同步>3.2.实现数据同步
<a class=header-anchor href=#32%e5%ae%9e%e7%8e%b0%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5></a></h2><h3 id=321思路>3.2.1.思路
<a class=header-anchor href=#321%e6%80%9d%e8%b7%af></a></h3><p>利用课前资料提供的hotel-admin项目作为酒店管理的微服务。当酒店数据发生增、删、改时，异步通知elasticsearch中的数据完成相同操作。</p><p>步骤：</p><ul><li><p>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD</p></li><li><p>声明exchange、queue、RoutingKey</p></li><li><p>在hotel-admin中的增、删、改业务中完成消息发送</p></li><li><p>在hotel-demo中完成消息监听，并更新elasticsearch中数据</p></li><li><p>启动并测试数据同步功能</p></li></ul><h3 id=322导入demo>3.2.2.导入demo
<a class=header-anchor href=#322%e5%af%bc%e5%85%a5demo></a></h3><p>导入课前资料提供的hotel-admin项目：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044493.png alt=image-20210723220237930></p><p>运行后，访问 http://localhost:8099</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044494.png alt=image-20210723220354464 style=zoom:50%><p>其中包含了酒店的CRUD功能：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044495.png alt=image-20210723220511090 style=zoom:50%><h3 id=323声明交换机队列>3.2.3.声明交换机、队列
<a class=header-anchor href=#323%e5%a3%b0%e6%98%8e%e4%ba%a4%e6%8d%a2%e6%9c%ba%e9%98%9f%e5%88%97></a></h3><p>MQ结构如图：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044496.png alt=image-20210723215850307></p><blockquote><p>这种将新增修改和删除分开的方式可以使得项目中的微服务运行效率更高</p></blockquote><h4 id=1引入依赖>1）引入依赖
<a class=header-anchor href=#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96></a></h4><p>在hotel-admin、hotel-demo中引入rabbitmq的依赖：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--amqp--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2声明队列交换机名称>2）声明队列交换机名称
<a class=header-anchor href=#2%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e4%ba%a4%e6%8d%a2%e6%9c%ba%e5%90%8d%e7%a7%b0></a></h4><p>在hotel-admin和hotel-demo中的<code>cn.itcast.hotel.constatnts</code>包下新建一个类<code>MqConstants</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.constatnts<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MqConstants</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 交换机
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String HOTEL_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hotel.topic&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 监听新增和修改的队列
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String HOTEL_INSERT_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hotel.insert.queue&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 监听删除的队列
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String HOTEL_DELETE_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hotel.delete.queue&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 新增或修改的RoutingKey
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String HOTEL_INSERT_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hotel.insert&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 删除的RoutingKey
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String HOTEL_DELETE_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hotel.delete&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3声明队列交换机>3）声明队列交换机
<a class=header-anchor href=#3%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h4><p>在hotel-demo中，定义配置类，声明队列、交换机，我们将所有的组件都声明成bean交给项目自动管理，而不是使用注解的方式：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.itcast.hotel.constants.MqConstants<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.Binding<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.BindingBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.Queue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.core.TopicExchange<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MqConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TopicExchange <span style=color:#a6e22e>topicExchange</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TopicExchange<span style=color:#f92672>(</span>MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_EXCHANGE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>insertQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Queue<span style=color:#f92672>(</span>MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_INSERT_QUEUE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>deleteQueue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Queue<span style=color:#f92672>(</span>MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_DELETE_QUEUE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>insertQueueBinding</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>insertQueue<span style=color:#f92672>()).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>topicExchange<span style=color:#f92672>()).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_INSERT_KEY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>deleteQueueBinding</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>(</span>deleteQueue<span style=color:#f92672>()).</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>topicExchange<span style=color:#f92672>()).</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_DELETE_KEY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=324发送mq消息>3.2.4.发送MQ消息
<a class=header-anchor href=#324%e5%8f%91%e9%80%81mq%e6%b6%88%e6%81%af></a></h3><p>在hotel-admin中的增、删、改业务中分别发送MQ消息，这需要注入RabbitMQ的客户端，为了减小消息在网络中传输的消耗，这里我们直接传输id，在elasticsearch微服务端根据id进行增删改：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044497.png alt=image-20210723221843816 style=zoom:50%><h3 id=325接收mq消息>3.2.5.接收MQ消息
<a class=header-anchor href=#325%e6%8e%a5%e6%94%b6mq%e6%b6%88%e6%81%af></a></h3><p>hotel-demo接收到MQ消息要做的事情包括：</p><ul><li>新增消息：根据传递的hotel的id查询hotel信息，然后新增一条数据到索引库</li><li>删除消息：根据传递的hotel的id删除索引库中的一条数据</li></ul><p>1）首先在hotel-demo的<code>cn.itcast.hotel.service</code>包下的<code>IHotelService</code>中新增新增、删除业务</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insertById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><p>2）给hotel-demo中的<code>cn.itcast.hotel.service.impl</code>包下的HotelService中实现业务：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//根据传递而来的id从索引库中删除文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DeleteRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DeleteRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>,</span> id<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        client<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//根据传递而来的id查询出新增的mysql数据，然后将其转换成json格式并插入索引库中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insertById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 0.根据id查询酒店数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Hotel hotel <span style=color:#f92672>=</span> getById<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 转换为文档类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HotelDoc hotelDoc <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HotelDoc<span style=color:#f92672>(</span>hotel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1.准备Request对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        IndexRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> IndexRequest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hotel&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(</span>hotel<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2.准备Json文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>(</span>JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>hotelDoc<span style=color:#f92672>),</span> XContentType<span style=color:#f92672>.</span><span style=color:#a6e22e>JSON</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3.发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        client<span style=color:#f92672>.</span><span style=color:#a6e22e>index</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3）编写监听器</p><p>在hotel-demo中的<code>cn.itcast.hotel.mq</code>包新增一个类：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.itcast.hotel.mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.itcast.hotel.constants.MqConstants<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.itcast.hotel.service.IHotelService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.amqp.rabbit.annotation.RabbitListener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HotelListener</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IHotelService hotelService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 监听酒店新增或修改的业务，一旦mysql数据库发生新增或修改就会发送一个时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 这里就会监听到消息从而完成数据的同步
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param id 酒店id
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RabbitListener</span><span style=color:#f92672>(</span>queues <span style=color:#f92672>=</span> MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_INSERT_QUEUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>listenHotelInsertOrUpdate</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        hotelService<span style=color:#f92672>.</span><span style=color:#a6e22e>insertById</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 监听酒店删除的业务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param id 酒店id
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RabbitListener</span><span style=color:#f92672>(</span>queues <span style=color:#f92672>=</span> MqConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>HOTEL_DELETE_QUEUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>listenHotelDelete</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        hotelService<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteById</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>为了做到数据同步，主要是mysql端要在增删改时向MQ中发送一个消息，之后elasticsearch端监听到匹配的消息之后，就触发数据同步的操作，根据mysql中的变化操作elasticsearch中的文档</p></blockquote><h1 id=4集群>4.集群
<a class=header-anchor href=#4%e9%9b%86%e7%be%a4></a></h1><p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p><ul><li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点，这种集群叫做切片集群</li><li>单点故障问题：将分片数据在不同节点备份（replica ），这种叫做主从复制集群</li></ul><p><strong>ES集群相关概念</strong>:</p><ul><li><p>集群（cluster）：一组拥有共同的 cluster name 的 节点。</p></li><li><p><font color=red>节点（node)</font> ：集群中的一个 Elasticearch 实例</p></li><li><p><font color=red>分片（shard）</font>：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p><p>解决问题：数据量太大，单点存储量有限的问题。</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044498.png alt=image-20200104124440086 style=zoom:33%><blockquote><p>此处，我们把数据分成3片：shard0、shard1、shard2</p></blockquote></li><li><p>主分片（Primary shard）：相对于副本分片的定义。</p></li><li><p>副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。</p></li></ul><p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p><p>为了在高可用和成本间寻求平衡，我们可以这样做：</p><ul><li>首先对数据分片，存储到不同节点</li><li>然后对每个分片进行备份，放到对方节点，完成互相备份</li></ul><p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044499.png alt=image-20200104124551912 style=zoom:33%><p>现在，每个分片都有1个备份，存储在3个节点：</p><ul><li>node0：保存了分片0和1</li><li>node1：保存了分片0和2</li><li>node2：保存了分片1和2</li></ul><h2 id=41搭建es集群>4.1.搭建ES集群
<a class=header-anchor href=#41%e6%90%ad%e5%bb%baes%e9%9b%86%e7%be%a4></a></h2><p>参考课前资料的文档：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044500.png alt=image-20210723222732427></p><p>其中的第四章节：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044501.png alt=image-20210723222812619></p><h2 id=42集群脑裂问题>4.2.集群脑裂问题
<a class=header-anchor href=#42%e9%9b%86%e7%be%a4%e8%84%91%e8%a3%82%e9%97%ae%e9%a2%98></a></h2><h3 id=421集群职责划分>4.2.1.集群职责划分
<a class=header-anchor href=#421%e9%9b%86%e7%be%a4%e8%81%8c%e8%b4%a3%e5%88%92%e5%88%86></a></h3><p>elasticsearch中集群节点有不同的职责划分：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044502.png alt=image-20210723223008967></p><p>默认情况下，集群中的任何一个节点都同时具备上述四种角色。</p><p>但是真实的集群一定要将集群职责分离：</p><ul><li>master节点：对CPU要求高，但是内存要求第</li><li>data节点：对CPU和内存要求都高</li><li>coordinating节点：对网络带宽、CPU要求高</li></ul><p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p><p>一个典型的es集群职责划分如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044503.png alt=image-20210723223629142 style=zoom:33%><h3 id=422脑裂问题>4.2.2.脑裂问题
<a class=header-anchor href=#422%e8%84%91%e8%a3%82%e9%97%ae%e9%a2%98></a></h3><p>脑裂是因为集群中的<strong>节点失联</strong>导致的。</p><p>例如一个集群中，主节点与其它节点失联：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044504.png alt=image-20210723223804995 style=zoom:33%><p>此时，node2和node3<strong>认为</strong>node1宕机，就会重新选主：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044505.png alt=image-20210723223845754 style=zoom:33%><p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p><p>当网络恢复后，因为集群中有两个master节点，出现脑裂的情况：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044506.png alt=image-20210723224000555 style=zoom:33%><p>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，也就是一定要超过一半以上的节点选票通过才能当选主节点，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p><p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p><h3 id=423小结>4.2.3.小结
<a class=header-anchor href=#423%e5%b0%8f%e7%bb%93></a></h3><p>master eligible节点的作用是什么？</p><ul><li>参与集群选主</li><li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</li></ul><p>data节点的作用是什么？</p><ul><li>数据的CRUD</li></ul><p>coordinator节点的作用是什么？</p><ul><li><p>路由请求到其它节点</p></li><li><p>合并查询到的结果，返回给用户</p></li></ul><h2 id=43集群分布式存储>4.3.集群分布式存储
<a class=header-anchor href=#43%e9%9b%86%e7%be%a4%e5%88%86%e5%b8%83%e5%bc%8f%e5%ad%98%e5%82%a8></a></h2><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p><h3 id=431分片存储测试>4.3.1.分片存储测试
<a class=header-anchor href=#431%e5%88%86%e7%89%87%e5%ad%98%e5%82%a8%e6%b5%8b%e8%af%95></a></h3><p>插入三条数据：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044507.png alt=image-20210723225006058 style=zoom:50%>
<img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044508.png alt=image-20210723225034637 style=zoom:50%>
<img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044509.png alt=image-20210723225112029 style=zoom:50%><p>测试可以看到，三条数据分别在不同分片：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044510.png alt=image-20210723225227928 style=zoom:50%><p>结果：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044511.png alt=image-20210723225342120 style=zoom:50%><h3 id=432分片存储原理>4.3.2.分片存储原理
<a class=header-anchor href=#432%e5%88%86%e7%89%87%e5%ad%98%e5%82%a8%e5%8e%9f%e7%90%86></a></h3><p>elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044512.png alt=image-20210723224354904></p><p>说明：</p><ul><li>_routing默认是文档的id</li><li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！</li></ul><p>新增文档的流程如下：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044513.png alt=image-20210723225436084 style=zoom:40%><p>解读：</p><ul><li>1）新增一个id=1的文档</li><li>2）对id做hash运算，假如得到的是2，则应该存储到shard-2</li><li>3）shard-2的主分片在node3节点，将数据路由到node3</li><li>4）保存文档</li><li>5）同步给shard-2的副本replica-2，在node2节点</li><li>6）返回结果给coordinating-node节点</li></ul><h2 id=44集群分布式查询>4.4.集群分布式查询
<a class=header-anchor href=#44%e9%9b%86%e7%be%a4%e5%88%86%e5%b8%83%e5%bc%8f%e6%9f%a5%e8%af%a2></a></h2><p>elasticsearch的查询分成两个阶段：</p><ul><li><p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p></li><li><p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p></li></ul><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044514.png alt=image-20210723225809848 style=zoom:50%><h2 id=45集群故障转移>4.5.集群故障转移
<a class=header-anchor href=#45%e9%9b%86%e7%be%a4%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb></a></h2><p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p><p>1）例如一个集群结构如图：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044515.png alt=image-20210723225945963 style=zoom:50%><p>现在，node1是主节点，其它两个节点是从节点。</p><p>2）突然，node1发生了故障：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044516.png alt=image-20210723230020574 style=zoom:50%><p>宕机后的第一件事，需要重新选主，例如选中了node2：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044517.png alt=image-20210723230055974 style=zoom:50%><p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</p><img src=https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202403052044518.png alt=image-20210723230216642 style=zoom:50%><p>后期如果node1恢复之后，会重新计算每个分片所处的位置</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%be%ae%e6%9c%8d%e5%8a%a1>微服务</a>
<a href=/tags/elasticsearch>elasticsearch</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4sentinel/ rel=next title=微服务保护之Sentinel><i class="fa fa-chevron-left"></i> 微服务保护之Sentinel</a></div><div class="post-nav-prev post-nav-item"><a href=/post/2537.%E7%BB%9F%E8%AE%A1%E5%A5%BD%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%95%B0%E7%9B%AE/ rel=prev title=2537.统计好子数组的数目>2537.统计好子数组的数目
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>zzzi提供技术支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zzzicode.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":null,"views":null},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"right","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0e26367f0461fb41ac6f947dc2af3620375dc44aa8945e6c2b1480d342c65d1.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>